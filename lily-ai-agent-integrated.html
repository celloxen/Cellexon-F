<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lily Health Consultant - Celloxen Platform</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logo {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .lily-info h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .lily-info p {
            color: #cbd5e1;
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .back-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .session-info {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #1e3a8a;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .session-badge {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .chat-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            height: 70vh;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
            scroll-behavior: smooth;
        }
        
        .message-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            animation: slideIn 0.6s ease;
        }
        
        .message-wrapper.lily-wrapper {
            align-self: flex-start;
        }
        
        .message-wrapper.user-wrapper {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        
        .message {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: 18px;
            line-height: 1.5;
            font-size: 0.95rem;
            white-space: pre-line;
        }
        
        .lily-message {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            color: #1f2937;
            border-bottom-left-radius: 6px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }
        
        .user-message {
            background: linear-gradient(135deg, #1e3a8a, #1e40af);
            color: white;
            border-bottom-right-radius: 6px;
            box-shadow: 0 2px 10px rgba(30, 58, 138, 0.3);
        }
        
        .processing {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 1px solid #fbbf24;
            color: #92400e;
            padding: 14px 18px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-style: italic;
        }
        
        .dots { display: flex; gap: 4px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #92400e; animation: bounce 1.4s ease-in-out infinite; }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        .dot:nth-child(3) { animation-delay: 0; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; } 40% { transform: scale(1.2); opacity: 1; } }
        
        .multiple-choice { margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .choice-button { background: white; border: 2px solid #e2e8f0; padding: 12px 16px; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; text-align: left; font-size: 0.9rem; }
        .choice-button:hover { border-color: #1e3a8a; background: linear-gradient(135deg, #ffffff, #f8fafc); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(30, 58, 138, 0.15); }
        
        .question-progress { background: #e2e8f0; height: 4px; border-radius: 2px; margin: 10px 0; overflow: hidden; }
        .question-progress-bar { background: linear-gradient(90deg, #10b981, #059669); height: 100%; border-radius: 2px; transition: width 0.8s ease; }
        
        .report-section { background: white; border-radius: 12px; padding: 20px; margin: 15px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .report-header { background: linear-gradient(135deg, #1e3a8a, #1e40af); color: white; padding: 20px; border-radius: 12px 12px 0 0; text-align: center; }
        .domain-score { background: #f0f9ff; border-left: 4px solid #0284c7; padding: 12px; margin: 10px 0; border-radius: 8px; }
        
        .action-buttons { display: flex; gap: 15px; justify-content: center; margin-top: 25px; flex-wrap: wrap; }
        .btn-action { padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; border: none; display: flex; align-items: center; gap: 8px; }
        .btn-action-primary { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .btn-action-secondary { background: #e5e7eb; color: #374151; }
        .btn-action:disabled { background: #9ca3af; cursor: not-allowed; }

        .input-area { padding: 20px 25px; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-top: 1px solid #e2e8f0; }
        .input-container { display: flex; gap: 12px; max-width: 800px; margin: 0 auto; align-items: center; }
        .input-field { flex: 1; padding: 14px 20px; border: 2px solid #e2e8f0; border-radius: 30px; outline: none; font-size: 16px; background: white; transition: all 0.3s ease; }
        .input-field:focus { border-color: #1e3a8a; box-shadow: 0 0 0 4px rgba(30, 58, 138, 0.1); }
        .input-field:disabled { background: #f1f5f9; color: #9ca3af; cursor: not-allowed; }
        
        .send-button { background: linear-gradient(135deg, #1e3a8a, #1e40af); color: white; border: none; border-radius: 50%; width: 48px; height: 48px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3); }
        .send-button:hover:not(:disabled) { transform: translateY(-2px) scale(1.05); box-shadow: 0 6px 20px rgba(30, 58, 138, 0.4); }
        .send-button:disabled { background: linear-gradient(135deg, #9ca3af, #6b7280); cursor: not-allowed; box-shadow: none; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        @media print {
            body { background: white; }
            .header, .input-area, .session-info, .chat-card .chat-header { display: none; }
            .chat-card { box-shadow: none; height: auto; }
            .chat-messages { padding: 0; }
            .message-wrapper { display: none; }
            .lily-message .report-section { display: block; }
            .report-section .action-buttons { display: none; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-container">
            <div style="display: flex; align-items: center; gap: 20px;">
                <div class="logo">CELLOXEN</div>
                <div class="lily-info">
                    <h1>Lily - AI Health Consultant</h1>
                    <p>Preliminary Health Assessment System</p>
                </div>
            </div>
            <a href="clinic-dashboard.html" class="back-btn">‚Üê Back to Dashboard</a>
        </div>
    </div>
    
    <div class="container">
        <div class="session-info">
            <div>
                <h3>Health Assessment Session</h3>
                <p>Initial wellness evaluation for therapy planning</p>
            </div>
            <div class="session-badge">
                Session: <span id="sessionId"></span>
            </div>
        </div>
        
        <div class="chat-card">
            <div class="chat-header" style="padding: 20px 25px; border-bottom: 1px solid #e2e8f0; display: flex; gap: 15px; align-items: center;">
                <div class="lily-avatar" style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #1e3a8a, #1e40af); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">L</div>
                <div>
                    <div style="font-weight: 600; color: #1f2937;">Lily Health Consultant</div>
                    <div style="color: #10b981; font-size: 0.85rem;">Online & Ready</div>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages"></div>
            
            <div class="input-area">
                <div class="input-container">
                    <input type="text" class="input-field" id="userInput" placeholder="Type your response..." disabled>
                    <button class="send-button" id="sendButton" onclick="sendMessage()" disabled>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // --- START OF SCRIPT ---
    (function() {
        // --- 1. SUPABASE & APP CONFIGURATION ---
        const SUPABASE_URL = 'https://defifwzgazqlrigwumqn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRlZmlmd3pnYXpxbHJpZ3d1bXFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyNTM0MjYsImV4cCI6MjA3MjgyOTQyNn0.wcUBq6Pszjtqn5aBtuu3iXBE4BLmu8x9LtJbsMWlIiA';
        
        const { createClient } = window.supabase;
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- 2. LILY AI AGENT CLASS ---
        class LilyHealthConsultant {
            constructor() {
                this.sessionId = this.generateSessionId();
                this.currentStep = 'greeting';
                this.sessionData = {};
                this.responses = [];
                this.domainScores = {};
                this.currentQuestionIndex = 0;
                this.patientId = new URLSearchParams(window.location.search).get('patientId') || sessionStorage.getItem('currentPatientId');
                this.patientData = null;
                this.initialQuestions = this.getInitialScreeningQuestions();
                
                this.startInitialization();
            }

            async startInitialization() {
                if (this.patientId) await this.loadPatientData();
                await this.showGreeting();
                this.enableInput();
            }

            generateSessionId() {
                const sessionId = `LILY-${Date.now()}`;
                document.getElementById('sessionId').textContent = sessionId;
                return sessionId;
            }

            getInitialScreeningQuestions() {
                return [
                    { id: 'sleep1', text: 'How would you rate the quality of your sleep?', domain: 'sleep', weight: 1.0, options: [{ text: 'Excellent', score: 0 }, { text: 'Good', score: 25 }, { text: 'Fair', score: 50 }, { text: 'Poor', score: 75 }, { text: 'Very poor', score: 100 }] },
                    { id: 'stress1', text: 'How would you describe your current stress levels?', domain: 'stress', weight: 1.0, options: [{ text: 'Very low', score: 0 }, { text: 'Low', score: 25 }, { text: 'Moderate', score: 50 }, { text: 'High', score: 75 }, { text: 'Very high', score: 100 }] },
                    { id: 'cardio1', text: 'How is your energy during physical activity?', domain: 'cardiovascular', weight: 1.0, options: [{ text: 'Excellent', score: 0 }, { text: 'Good', score: 25 }, { text: 'Fair', score: 50 }, { text: 'Poor', score: 75 }, { text: 'Very poor', score: 100 }] },
                    { id: 'joint1', text: 'Do you experience joint discomfort?', domain: 'joint', weight: 1.0, options: [{ text: 'Never', score: 0 }, { text: 'Rarely', score: 25 }, { text: 'Sometimes', score: 50 }, { text: 'Often', score: 75 }, { text: 'Constantly', score: 100 }] },
                    { id: 'digestive1', text: 'How comfortable is your digestion after meals?', domain: 'digestive', weight: 1.0, options: [{ text: 'Very comfortable', score: 0 }, { text: 'Usually comfortable', score: 25 }, { text: 'Sometimes uncomfortable', score: 50 }, { text: 'Often uncomfortable', score: 75 }, { text: 'Always problematic', score: 100 }] },
                ];
            }

            async loadPatientData() {
                try {
                    const { data, error } = await supabase.from('patients').select('*').eq('id', this.patientId).single();
                    if (error) throw error;
                    this.patientData = data;
                } catch (error) {
                    console.error('Error loading patient:', error);
                }
            }
            
            async showGreeting() {
                let greeting = "Good morning";
                if (this.patientData) {
                    this.sessionData.patientName = `${this.patientData.first_name} ${this.patientData.last_name}`;
                    await this.addMessage(`${greeting}! I am Lily. I'm here to conduct a health assessment for ${this.sessionData.patientName}. Shall we begin?`, 'lily', ['Yes, begin', 'Cancel']);
                    this.currentStep = 'confirmation';
                } else {
                    await this.addMessage(`${greeting}! I am Lily. What is the full name of the patient for this assessment?`, 'lily');
                }
            }

            async addMessage(text, sender, options = null) {
                const messagesContainer = document.getElementById('chatMessages');
                const messageWrapper = document.createElement('div');
                messageWrapper.className = `message-wrapper ${sender}-wrapper`;
                
                let messageContent = text;
                if (options) {
                    const optionsHtml = options.map((opt, idx) => `<div class="choice-button" onclick="window.lily.selectChoice(${idx})">${opt}</div>`).join('');
                    messageContent += `<div class="multiple-choice">${optionsHtml}</div>`;
                }
                
                messageWrapper.innerHTML = `<div class="message ${sender}-message">${messageContent}</div>`;
                messagesContainer.appendChild(messageWrapper);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                return messageWrapper;
            }

            async processUserInput(input) {
                await this.addMessage(input, 'user');
                this.disableInput();
                
                const processingMsg = await this.addMessage('', 'processing');
                await this.delay(1500);
                processingMsg.remove();
                
                switch(this.currentStep) {
                    case 'greeting':
                        this.sessionData.patientName = input;
                        await this.addMessage(`Thank you. Shall we proceed with the assessment for ${this.sessionData.patientName}?`, 'lily', ['Yes, proceed', 'No, cancel']);
                        this.currentStep = 'confirmation';
                        break;
                }
                this.enableInput();
            }

            async selectChoice(index) {
                this.disableInput();
                if (this.currentStep === 'confirmation') {
                    const options = ['Yes, begin', 'Cancel'];
                    const choice = options[index];
                    await this.addMessage(choice, 'user');
                    if (choice === 'Yes, begin') await this.startAssessment();
                    else await this.addMessage("Assessment cancelled.", 'lily');
                } else if (this.currentStep === 'assessment') {
                    const question = this.initialQuestions[this.currentQuestionIndex];
                    await this.handleAssessmentResponse(question.options[index]);
                }
            }

            async startAssessment() {
                this.currentStep = 'assessment';
                await this.addMessage("Great. Let's begin with a few questions to understand the primary health concerns.", 'lily');
                await this.askNextQuestion();
            }

            async askNextQuestion() {
                await this.delay(1000);
                if (this.currentQuestionIndex < this.initialQuestions.length) {
                    const question = this.initialQuestions[this.currentQuestionIndex];
                    const progress = ((this.currentQuestionIndex + 1) / this.initialQuestions.length) * 100;
                    const progressHtml = `<div class="question-progress"><div class="question-progress-bar" style="width: ${progress}%"></div></div>Question ${this.currentQuestionIndex + 1}: ${question.text}`;
                    await this.addMessage(progressHtml, 'lily', question.options);
                } else {
                    await this.generateFullReport();
                }
            }

            async handleAssessmentResponse(selectedOption) {
                const question = this.initialQuestions[this.currentQuestionIndex];
                await this.addMessage(selectedOption.text, 'user');

                this.responses.push({ question: question.text, response: selectedOption.text, score: selectedOption.score });
                
                if (!this.domainScores[question.domain]) this.domainScores[question.domain] = { totalScore: 0, count: 0 };
                this.domainScores[question.domain].totalScore += selectedOption.score;
                this.domainScores[question.domain].count++;
                
                this.currentQuestionIndex++;
                await this.askNextQuestion();
            }

            // MODIFIED: Generates full report directly
            async generateFullReport() {
                await this.addMessage("Assessment complete! Generating your health report...", 'lily');
                const processingMsg = await this.addMessage('', 'processing');
                await this.delay(3000);
                processingMsg.remove();

                const finalScores = {};
                for (const domain in this.domainScores) {
                    finalScores[domain] = Math.round(this.domainScores[domain].totalScore / this.domainScores[domain].count);
                }
                const primaryConcerns = Object.entries(finalScores).filter(([d, s]) => s >= 75).map(([d]) => this.formatDomain(d));
                const secondaryConcerns = Object.entries(finalScores).filter(([d, s]) => s >= 50 && s < 75).map(([d]) => this.formatDomain(d));
                
                const reportHtml = `
                    <div class="report-section" id="finalReportContent">
                        <div class="report-header"><h2>Health Assessment Report</h2><p>Patient: ${this.sessionData.patientName}</p></div>
                        <h3 style="color: #1e293b; margin: 20px 0;">Domain Scores (Wellness %)</h3>
                        ${Object.entries(finalScores).map(([domain, score]) => `<div class="domain-score"><strong>${this.formatDomain(domain)}:</strong> ${100-score}%</div>`).join('')}
                        <h3 style="color: #1e293b; margin: 20px 0 10px;">Summary</h3>
                        <p><strong>Primary Concerns:</strong> ${primaryConcerns.length ? primaryConcerns.join(', ') : 'None'}</p>
                        <p><strong>Secondary Concerns:</strong> ${secondaryConcerns.length ? secondaryConcerns.join(', ') : 'None'}</p>
                    </div>
                    <div class="action-buttons">
                        <button class="btn-action btn-action-secondary" onclick="window.lily.printReport()">üñ®Ô∏è Print Report</button>
                        <button class="btn-action btn-action-primary" id="emailBtn" onclick="window.lily.emailReport()">üìß Email Report</button>
                        <button class="btn-action btn-action-primary" id="saveBtn" onclick="window.lily.saveReport()">üíæ Save to Database</button>
                    </div>
                `;
                
                await this.addMessage(reportHtml, 'lily');
                await this.saveAssessmentData(finalScores, primaryConcerns, secondaryConcerns); // Auto-save
                this.disableInput();
            }

            async saveAssessmentData(scores, primaryConcerns, secondaryConcerns) {
                if (!this.patientId) return;
                const saveData = {
                    patient_id: this.patientId,
                    clinic_id: this.patientData.clinic_id,
                    assessment_type: 'lily_standalone',
                    answers: this.responses,
                    scores: scores,
                    primary_concerns: primaryConcerns,
                    secondary_concerns: secondaryConcerns,
                    practitioner_name: this.sessionData.practitionerName,
                };
                
                try {
                    const { error } = await supabase.from('health_assessments').insert(saveData);
                    if (error) throw error;
                    document.getElementById('saveBtn').textContent = '‚úì Saved';
                    document.getElementById('saveBtn').disabled = true;
                } catch (error) {
                    console.error('Error saving assessment:', error);
                    alert("Error saving report to the database.");
                }
            }

            async emailReport() {
                if (!this.patientData || !this.patientData.email) {
                    alert("Patient email is not available.");
                    return;
                }
                const emailBtn = document.getElementById('emailBtn');
                emailBtn.textContent = 'Sending...';
                emailBtn.disabled = true;

                try {
                    const reportElement = document.getElementById('finalReportContent');
                    const pdfBlob = await html2pdf().from(reportElement).output('blob');
                    
                    const success = await this.sendEmailWithPDF(pdfBlob, this.patientData.email, this.sessionData.patientName);
                    if(success) {
                        emailBtn.textContent = '‚úì Sent';
                    } else {
                        emailBtn.textContent = 'Email Failed';
                    }
                } catch(e) {
                    console.error("Email failed", e);
                    emailBtn.textContent = 'Email Failed';
                }
            }
            
            async sendEmailWithPDF(pdfBlob, patientEmail, patientName) {
                // This is a simplified version of the logic from email-sender.js
                try {
                    const reader = new FileReader();
                    const base64Promise = new Promise(resolve => {
                        reader.onloadend = () => resolve(reader.result.split(',')[1]);
                        reader.readAsDataURL(pdfBlob);
                    });
                    const pdfBase64 = await base64Promise;

                    const emailData = {
                        to: patientEmail,
                        from: 'Celloxen Health <health@celloxen.com>',
                        subject: `Health Assessment Report - ${patientName}`,
                        html: `<p>Dear ${patientName},</p><p>Please find your health assessment report attached.</p>`,
                        attachments: [{ filename: `Health_Report.pdf`, content: pdfBase64, type: 'application/pdf' }]
                    };

                    const response = await fetch('https://defifwzgazqlrigwumqn.supabase.co/functions/v1/send-email', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` },
                        body: JSON.stringify(emailData)
                    });
                    
                    return response.ok;
                } catch (error) {
                    console.error('Error in sendEmailWithPDF:', error);
                    return false;
                }
            }
            
            printReport() {
                window.print();
            }

            formatDomain(domain) {
                return domain.charAt(0).toUpperCase() + domain.slice(1);
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            enableInput() {
                document.getElementById('userInput').disabled = false;
                document.getElementById('sendButton').disabled = false;
                document.getElementById('userInput').focus();
            }

            disableInput() {
                document.getElementById('userInput').disabled = true;
                document.getElementById('sendButton').disabled = true;
            }
        }

        // --- 3. GLOBAL FUNCTIONS & INITIALIZATION ---
        window.lily = new LilyHealthConsultant();

        window.sendMessage = function() {
            const input = document.getElementById('userInput');
            if (input.value.trim()) {
                window.lily.processUserInput(input.value.trim());
                input.value = '';
            }
        }
        document.getElementById('userInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

    })();
    // --- END OF SCRIPT ---
    </script>
</body>
</html>
