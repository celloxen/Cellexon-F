<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Assessment - Celloxen</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; }
        .header { background: linear-gradient(135deg, #1e293b, #334155); padding: 20px; border-bottom: 2px solid #10b981; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .card { background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 20px; border: 1px solid rgba(16, 185, 129, 0.3); margin: 10px 0; }
        .progress-bar { background: #e5e7eb; height: 8px; border-radius: 4px; margin: 20px 0; }
        .progress-fill { background: linear-gradient(90deg, #10b981, #059669); height: 100%; border-radius: 4px; transition: width 0.3s ease; }
        .category-tabs { display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
        .tab { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; background: rgba(255, 255, 255, 0.1); color: #94a3b8; font-weight: 500; transition: all 0.3s ease; }
        .tab.active { background: #10b981; color: white; }
        .tab.completed { background: #059669; color: white; }
        .question-card { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; padding: 20px; margin: 15px 0; }
        .question-text { font-size: 1.1rem; font-weight: 500; margin-bottom: 15px; color: #e2e8f0; }
        .options { display: grid; gap: 10px; }
        .option { padding: 12px; border: 2px solid #374151; border-radius: 8px; cursor: pointer; transition: all 0.2s; background: rgba(255, 255, 255, 0.05); color: #cbd5e1; }
        .option:hover { border-color: #10b981; background: rgba(16, 185, 129, 0.1); }
        .option.selected { border-color: #10b981; background: rgba(16, 185, 129, 0.2); }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; margin: 5px; }
        .btn-primary { background: #10b981; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .results-card { background: rgba(16, 185, 129, 0.1); border: 2px solid #10b981; }
        .score-display { text-align: center; margin: 20px 0; }
        .score-number { font-size: 3rem; font-weight: bold; color: #10b981; }
        .score-label { font-size: 1.2rem; color: #cbd5e1; }
        .recommendations { background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 20px; margin: 15px 0; }
        .recommendation-item { padding: 10px; margin: 8px 0; background: rgba(16, 185, 129, 0.1); border-left: 4px solid #10b981; border-radius: 4px; }
        .hidden { display: none; }
        .alert { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .alert-success { background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid #10b981; }
        .alert-error { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid #ef4444; }
        .patient-search { position: relative; width: 100%; }
        .patient-search input { width: 100%; padding: 10px; border: 1px solid #374151; border-radius: 6px; background: #1f2937; color: white; }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: #1f2937; border: 1px solid #374151; border-radius: 6px; max-height: 200px; overflow-y: auto; z-index: 100; }
        .search-result-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #374151; }
        .search-result-item:hover { background: rgba(16, 185, 129, 0.1); }
        .patient-info-display { background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 6px; margin-top: 15px; border: 1px solid #10b981; }
        .detailed-findings { margin-top: 30px; }
        .category-finding { background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 20px; margin: 15px 0; }
        .therapy-detail { background: rgba(16, 185, 129, 0.05); border-radius: 8px; padding: 15px; margin: 10px 0; border-left: 4px solid #10b981; }
        .action-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        
        /* Print styles for A4 report */
        @media print {
            body { background: white; color: black; }
            .header, .btn, .alert, .no-print { display: none !important; }
            .card { background: white; border: none; box-shadow: none; }
            .container { max-width: 100%; padding: 0; }
            .print-header { display: block !important; }
            .print-footer { display: block !important; }
            @page { size: A4; margin: 2cm; }
        }
        
        .print-header { display: none; text-align: center; margin-bottom: 30px; }
        .print-footer { display: none; text-align: center; margin-top: 30px; font-size: 0.9rem; color: #666; }
        .clinic-header { border-bottom: 2px solid #10b981; padding-bottom: 20px; margin-bottom: 30px; }
        .patient-details { margin-bottom: 30px; }
        .report-section { margin-bottom: 25px; }
        .report-title { font-size: 1.5rem; font-weight: bold; color: #10b981; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="header no-print">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>Celloxen Health Assessment</h1>
                    <p>Comprehensive 5-category health evaluation system</p>
                </div>
                <div>
                    <button class="btn btn-secondary" onclick="goBackToPatientSearch()" id="backToSearchBtn" style="display: none;">Back to Patient Search</button>
                    <button class="btn btn-secondary" onclick="window.location.href='index.html'">Dashboard</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div id="alertContainer"></div>
        
        <!-- Patient Selection -->
        <div class="card" id="patientSelection">
            <h2>Select Patient for Assessment</h2>
            <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: end;">
                <div>
                    <label style="color: #10b981;">Search Patient (type 3+ characters):</label>
                    <div class="patient-search">
                        <input type="text" id="patientSearchInput" placeholder="Type patient name or ID..." autocomplete="off">
                        <div id="searchResults" class="search-results" style="display: none;"></div>
                    </div>
                    <div id="patientInfo" class="patient-info-display" style="display: none;"></div>
                </div>
                <button class="btn btn-primary" onclick="startAssessment()">Start Assessment</button>
            </div>
        </div>

        <!-- Assessment Interface -->
        <div class="card hidden" id="assessmentInterface">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Health Assessment</h2>
                <div id="patientInfoHeader" style="text-align: right; color: #94a3b8;"></div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
            <div style="text-align: center; margin: 10px 0;">
                <span id="progressText" style="color: #94a3b8;">Category 1 of 5</span>
            </div>
            
            <div class="category-tabs" id="categoryTabs">
                <button class="tab active" onclick="switchCategory(0)">Physical Health</button>
                <button class="tab" onclick="switchCategory(1)">Mental Wellbeing</button>
                <button class="tab" onclick="switchCategory(2)">Lifestyle</button>
                <button class="tab" onclick="switchCategory(3)">Environment</button>
                <button class="tab" onclick="switchCategory(4)">Medical History</button>
            </div>
            
            <div id="questionsContainer">
                <!-- Questions will be populated here -->
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 30px;">
                <button class="btn btn-secondary" id="prevBtn" onclick="previousCategory()">Previous Category</button>
                <button class="btn btn-primary" id="nextBtn" onclick="nextCategory()">Next Category</button>
            </div>
        </div>

        <!-- Results Display -->
        <div class="card results-card hidden" id="resultsDisplay">
            <!-- Print Header -->
            <div class="print-header">
                <div class="clinic-header">
                    <h1 style="color: #10b981; margin-bottom: 10px;">CELLOXEN MEDICAL PLATFORM</h1>
                    <h2 style="margin-bottom: 15px;">COMPREHENSIVE HEALTH ASSESSMENT REPORT</h2>
                    <div id="clinicDetails" style="text-align: left; margin-top: 20px;"></div>
                </div>
                <div class="patient-details">
                    <h3 style="color: #10b981; margin-bottom: 10px;">PATIENT INFORMATION</h3>
                    <div id="printPatientDetails"></div>
                </div>
            </div>

            <h2 style="text-align: center; color: #10b981;" class="no-print">Assessment Complete!</h2>
            
            <div class="score-display">
                <div class="score-number" id="totalScore">0</div>
                <div class="score-label">Overall Health Score</div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                <div style="text-align: center; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #10b981;" id="physicalScore">0</div>
                    <div style="color: #cbd5e1;">Physical Health</div>
                </div>
                <div style="text-align: center; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #10b981;" id="mentalScore">0</div>
                    <div style="color: #cbd5e1;">Mental Wellbeing</div>
                </div>
                <div style="text-align: center; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #10b981;" id="lifestyleScore">0</div>
                    <div style="color: #cbd5e1;">Lifestyle</div>
                </div>
                <div style="text-align: center; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #10b981;" id="environmentScore">0</div>
                    <div style="color: #cbd5e1;">Environment</div>
                </div>
                <div style="text-align: center; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #10b981;" id="historyScore">0</div>
                    <div style="color: #cbd5e1;">Medical History</div>
                </div>
            </div>
            
            <div class="recommendations report-section">
                <h3 class="report-title">Recommended Therapy Protocols</h3>
                <div id="recommendationsList">
                    <!-- Recommendations will be populated here -->
                </div>
            </div>

            <!-- Detailed Findings Section -->
            <div class="detailed-findings report-section">
                <h3 class="report-title">Detailed Category Analysis</h3>
                <div id="detailedFindings">
                    <!-- Detailed findings will be populated here -->
                </div>
            </div>
            
            <!-- Print Footer -->
            <div class="print-footer">
                <div style="border-top: 1px solid #ccc; padding-top: 15px;">
                    <p>Report Generated: <span id="reportDate"></span></p>
                    <p>Celloxen Medical Platform - Electromagnetic Frequency Therapy System</p>
                </div>
            </div>

            <div class="action-buttons no-print">
                <button class="btn btn-primary" onclick="saveAssessment()">Save Assessment</button>
                <button class="btn btn-secondary" onclick="downloadPDF()">Download PDF</button>
                <button class="btn btn-secondary" onclick="printReport()">Print Report</button>
                <button class="btn btn-warning" onclick="startIrisAnalysis()">IRIS Analysis</button>
                <button class="btn btn-secondary" onclick="startNewAssessment()">New Assessment</button>
                <button class="btn btn-danger" onclick="exitToPatientManagement()">Exit</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabase } from './supabase-config.js';
        
        // Get current clinic ID (this should be set based on logged-in user)
        let currentClinicId = 1; // You'll need to get this from session/auth
        let currentClinic = null;
        
        // Assessment data structure
        const assessmentQuestions = {
            physical: [
                { text: "How would you rate your overall energy levels?", options: ["Very Low", "Low", "Moderate", "High", "Very High"] },
                { text: "How often do you experience physical pain or discomfort?", options: ["Daily", "Several times a week", "Weekly", "Rarely", "Never"] },
                { text: "How is your sleep quality?", options: ["Very Poor", "Poor", "Fair", "Good", "Excellent"] },
                { text: "How would you rate your physical fitness?", options: ["Very Poor", "Poor", "Average", "Good", "Excellent"] },
                { text: "Do you have any chronic health conditions?", options: ["Multiple conditions", "One major condition", "Minor conditions", "Occasional issues", "None"] }
            ],
            mental: [
                { text: "How often do you feel stressed or anxious?", options: ["Always", "Often", "Sometimes", "Rarely", "Never"] },
                { text: "How would you rate your mood most days?", options: ["Very Low", "Low", "Neutral", "Good", "Very Good"] },
                { text: "How well do you handle daily challenges?", options: ["Very Poorly", "Poorly", "Adequately", "Well", "Very Well"] },
                { text: "Do you feel mentally clear and focused?", options: ["Never", "Rarely", "Sometimes", "Often", "Always"] },
                { text: "How satisfied are you with your life overall?", options: ["Very Dissatisfied", "Dissatisfied", "Neutral", "Satisfied", "Very Satisfied"] }
            ],
            lifestyle: [
                { text: "How often do you exercise or engage in physical activity?", options: ["Never", "Rarely", "1-2 times/week", "3-4 times/week", "Daily"] },
                { text: "How would you rate your diet and nutrition?", options: ["Very Poor", "Poor", "Average", "Good", "Excellent"] },
                { text: "Do you smoke or use tobacco products?", options: ["Heavy use", "Moderate use", "Light use", "Occasionally", "Never"] },
                { text: "How much alcohol do you consume?", options: ["Heavy drinking", "Moderate drinking", "Light drinking", "Occasionally", "Never"] },
                { text: "How many hours of sleep do you get per night?", options: ["Less than 5", "5-6 hours", "6-7 hours", "7-8 hours", "More than 8"] }
            ],
            environment: [
                { text: "How clean and healthy is your living environment?", options: ["Very Poor", "Poor", "Average", "Good", "Excellent"] },
                { text: "Are you exposed to environmental toxins at work or home?", options: ["High exposure", "Moderate exposure", "Some exposure", "Minimal exposure", "No exposure"] },
                { text: "How much time do you spend in nature or outdoors?", options: ["Never", "Rarely", "Weekly", "Several times/week", "Daily"] },
                { text: "How would you rate the air quality in your area?", options: ["Very Poor", "Poor", "Average", "Good", "Excellent"] },
                { text: "Do you have a supportive social environment?", options: ["Very Poor", "Poor", "Average", "Good", "Excellent"] }
            ],
            history: [
                { text: "Have you had any major surgeries or hospitalizations?", options: ["Multiple major", "One major", "Minor procedures", "Few minor", "None"] },
                { text: "Do you take any regular medications?", options: ["Many medications", "Several medications", "Few medications", "One medication", "None"] },
                { text: "Do you have any known allergies or sensitivities?", options: ["Severe multiple", "Several allergies", "Few allergies", "One allergy", "None"] },
                { text: "Have you experienced any serious injuries?", options: ["Multiple serious", "One serious", "Few minor", "Very minor", "None"] },
                { text: "Do you have a family history of serious health conditions?", options: ["Multiple conditions", "Several conditions", "Few conditions", "One condition", "None known"] }
            ]
        };

        const therapyDatabase = {
            detoxification: {
                name: "Detoxification Protocol",
                overview: "Comprehensive electromagnetic therapy designed to support the body's natural detoxification processes by stimulating lymphatic drainage and cellular cleansing.",
                benefits: "Improved energy levels, enhanced immune function, reduced inflammation, better skin clarity, and overall wellness enhancement.",
                duration: "6 weeks",
                sessions: "12 sessions total",
                frequency: "2 sessions per week",
                sessionLength: "45 minutes per session"
            },
            energy_enhancement: {
                name: "Energy Enhancement Protocol",
                overview: "Targeted frequencies designed to optimise cellular energy production and combat fatigue through mitochondrial stimulation.",
                benefits: "Increased vitality, improved stamina, enhanced mental clarity, better sleep quality, and reduced chronic fatigue symptoms.",
                duration: "4 weeks", 
                sessions: "8 sessions total",
                frequency: "2 sessions per week",
                sessionLength: "30 minutes per session"
            },
            pain_management: {
                name: "Pain Management Protocol",
                overview: "Specialised electromagnetic frequencies targeting pain receptors and inflammatory pathways to provide natural pain relief.",
                benefits: "Reduced chronic pain, decreased inflammation, improved mobility, enhanced quality of life, and reduced dependency on pain medications.",
                duration: "6 weeks",
                sessions: "12 sessions total", 
                frequency: "2 sessions per week",
                sessionLength: "40 minutes per session"
            },
            stress_relief: {
                name: "Stress Relief Protocol",
                overview: "Calming electromagnetic frequencies designed to regulate the nervous system and promote deep relaxation and mental balance.",
                benefits: "Reduced anxiety levels, improved mood stability, better stress management, enhanced sleep quality, and overall mental wellbeing.",
                duration: "5 weeks",
                sessions: "10 sessions total",
                frequency: "2 sessions per week", 
                sessionLength: "35 minutes per session"
            },
            sleep_enhancement: {
                name: "Sleep Enhancement Protocol",
                overview: "Therapeutic frequencies targeting circadian rhythm regulation and nervous system calming to improve sleep quality and duration.",
                benefits: "Faster sleep onset, deeper sleep phases, improved sleep continuity, enhanced daytime alertness, and better overall rest quality.",
                duration: "4 weeks",
                sessions: "8 sessions total",
                frequency: "2 sessions per week",
                sessionLength: "30 minutes per session"
            },
            constitutional_support: {
                name: "Constitutional Support Protocol",
                overview: "Holistic electromagnetic therapy designed to strengthen overall constitutional health and support the body's natural healing mechanisms.",
                benefits: "Enhanced immune function, improved vitality, better adaptation to stress, increased resilience, and overall health optimisation.",
                duration: "8 weeks",
                sessions: "16 sessions total",
                frequency: "2 sessions per week",
                sessionLength: "50 minutes per session"
            }
        };
        
        let currentCategory = 0;
        let selectedPatient = null;
        let answers = {};
        let categoryScores = { physical: 0, mental: 0, lifestyle: 0, environment: 0, history: 0 };
        let allPatients = [];
        let filteredPatients = [];
        
        // Load clinic and setup on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadClinicInfo();
            setupPatientSearch();
        });
        
        // Load clinic information
        async function loadClinicInfo() {
            try {
                const { data, error } = await supabase
                    .from('clinics')
                    .select('*')
                    .eq('id', currentClinicId)
                    .single();
                    
                if (error) throw error;
                currentClinic = data;
                
            } catch (error) {
                console.error('Error loading clinic info:', error);
                currentClinic = {
                    clinic_name: "Demo Clinic",
                    address: "123 Health Street, London, UK",
                    phone: "+44 20 1234 5678",
                    email: "info@democlinic.co.uk"
                };
            }
        }
        
        // Setup patient search functionality
        function setupPatientSearch() {
            const searchInput = document.getElementById('patientSearchInput');
            const searchResults = document.getElementById('searchResults');
            
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.trim();
                
                if (searchTerm.length >= 3) {
                    performPatientSearch(searchTerm);
                } else {
                    searchResults.style.display = 'none';
                }
            });
            
            // Close search results when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.patient-search')) {
                    searchResults.style.display = 'none';
                }
            });
        }
        
        // Perform patient search with clinic filtering
        async function performPatientSearch(searchTerm) {
            try {
                const { data, error } = await supabase
                    .from('patients')
                    .select(`
                        id,
                        first_name,
                        last_name,
                        patient_id,
                        email,
                        date_of_birth,
                        gender,
                        address,
                        clinic_id,
                        created_at,
                        clinics (
                            clinic_name,
                            clinic_code,
                            address,
                            phone,
                            email
                        )
                    `)
                    .eq('clinic_id', currentClinicId)
                    .or(`first_name.ilike.%${searchTerm}%,last_name.ilike.%${searchTerm}%,patient_id.ilike.%${searchTerm}%`)
                    .order('created_at', { ascending: false })
                    .limit(10);
                    
                if (error) throw error;
                
                displaySearchResults(data || []);
                
            } catch (error) {
                console.error('Error searching patients:', error);
                showAlert('Error searching patients: ' + error.message, 'error');
            }
        }
        
        // Display search results
        function displaySearchResults(patients) {
            const searchResults = document.getElementById('searchResults');
            
            if (patients.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item">No patients found</div>';
            } else {
                searchResults.innerHTML = patients.map(patient => `
                    <div class="search-result-item" onclick="selectPatientFromSearch(${patient.id}, '${JSON.stringify(patient).replace(/'/g, "\\'")}')">
                        <strong>${patient.first_name} ${patient.last_name}</strong><br>
                        <small>ID: ${patient.patient_id} | ${patient.gender || 'N/A'}</small>
                    </div>
                `).join('');
            }
            
            searchResults.style.display = 'block';
        }
        
        // Select patient from search results
        window.selectPatientFromSearch = function(patientId, patientDataString) {
            try {
                selectedPatient = JSON.parse(patientDataString);
                
                const searchInput = document.getElementById('patientSearchInput');
                const searchResults = document.getElementById('searchResults');
                const patientInfo = document.getElementById('patientInfo');
                
                searchInput.value = `${selectedPatient.first_name} ${selectedPatient.last_name} (${selectedPatient.patient_id})`;
                searchResults.style.display = 'none';
                
                patientInfo.innerHTML = `
                    <strong>Patient:</strong> ${selectedPatient.first_name} ${selectedPatient.last_name}<br>
                    <strong>ID:</strong> ${selectedPatient.patient_id}<br>
                    <strong>Gender:</strong> ${selectedPatient.gender || 'Not specified'}<br>
                    <strong>DOB:</strong> ${selectedPatient.date_of_birth || 'Not provided'}<br>
                    <strong>Clinic:</strong> ${selectedPatient.clinics?.clinic_name || 'Unknown'}
                `;
                patientInfo.style.display = 'block';
                
            } catch (error) {
                console.error('Error selecting patient:', error);
                showAlert('Error selecting patient', 'error');
            }
        };
        
        // Show alert messages
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }
        
        // Go back to patient search
        window.goBackToPatientSearch = function() {
            document.getElementById('assessmentInterface').classList.add('hidden');
            document.getElementById('resultsDisplay').classList.add('hidden');
            document.getElementById('patientSelection').classList.remove('hidden');
            document.getElementById('backToSearchBtn').style.display = 'none';
        };
        
        // Start assessment
        window.startAssessment = function() {
            if (!selectedPatient) {
                showAlert('Please select a patient first', 'error');
                return;
            }
            
            const patientText = `${selectedPatient.first_name} ${selectedPatient.last_name} (${selectedPatient.patient_id})`;
            document.getElementById('patientInfoHeader').textContent = `Patient: ${patientText}`;
            document.getElementById('backToSearchBtn').style.display = 'inline-block';
            
            document.getElementById('patientSelection').classList.add('hidden');
            document.getElementById('assessmentInterface').classList.remove('hidden');
            
            // Initialize answers
            answers = { physical: {}, mental: {}, lifestyle: {}, environment: {}, history: {} };
            currentCategory = 0;
            
            loadCategoryQuestions();
        };
        
        // Load questions for current category
        function loadCategoryQuestions() {
            const categories = ['physical', 'mental', 'lifestyle', 'environment', 'history'];
            const categoryName = categories[currentCategory];
            const questions = assessmentQuestions[categoryName];
            
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            
            questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-card';
                questionDiv.innerHTML = `
                    <div class="question-text">${index + 1}. ${question.text}</div>
                    <div class="options" data-question="${index}">
                        ${question.options.map((option, optIndex) => `
                            <div class="option" onclick="selectOption(${index}, ${optIndex})" data-value="${optIndex}">
                                ${option}
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(questionDiv);
            });
            
            // Restore previous answers if they exist
            if (answers[categoryName]) {
                Object.keys(answers[categoryName]).forEach(questionIndex => {
                    const optionValue = answers[categoryName][questionIndex];
                    const optionElement = container.querySelector(`[data-question="${questionIndex}"] [data-value="${optionValue}"]`);
                    if (optionElement) {
                        optionElement.classList.add('selected');
                    }
                });
            }
            
            updateProgress();
            updateNavigation();
        }
        
        // Select option
        window.selectOption = function(questionIndex, optionValue) {
            const categories = ['physical', 'mental', 'lifestyle', 'environment', 'history'];
            const categoryName = categories[currentCategory];
            
            // Remove previous selection
            const optionsContainer = document.querySelector(`[data-question="${questionIndex}"]`);
            optionsContainer.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            
            // Add new selection
            const selectedOption = optionsContainer.querySelector(`[data-value="${optionValue}"]`);
            selectedOption.classList.add('selected');
            
            // Store answer
            if (!answers[categoryName]) answers[categoryName] = {};
            answers[categoryName][questionIndex] = optionValue;
        };
        
        // Navigation functions
        window.nextCategory = function() {
            if (currentCategory < 4) {
                currentCategory++;
                loadCategoryQuestions();
            } else {
                calculateResults();
            }
        };
        
        window.previousCategory = function() {
            if (currentCategory > 0) {
                currentCategory--;
                loadCategoryQuestions();
            }
        };
        
        window.switchCategory = function(categoryIndex) {
            currentCategory = categoryIndex;
            loadCategoryQuestions();
        };
        
        // Update progress
        function updateProgress() {
            const progress = ((currentCategory + 1) / 5) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = `Category ${currentCategory + 1} of 5`;
            
            // Update tab states - only current category is highlighted
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach((tab, index) => {
                tab.classList.remove('active', 'completed');
                if (index === currentCategory) {
                    tab.classList.add('active');
                }
            });
        }
        
        // Update navigation buttons
        function updateNavigation() {
            document.getElementById('prevBtn').disabled = currentCategory === 0;
            document.getElementById('nextBtn').textContent = currentCategory === 4 ? 'Complete Assessment' : 'Next Category';
        }
        
        // Calculate results
        function calculateResults() {
            const categories = ['physical', 'mental', 'lifestyle', 'environment', 'history'];
            let totalScore = 0;
            
            categories.forEach(category => {
                let categoryTotal = 0;
                const categoryAnswers = answers[category] || {};
                
                Object.values(categoryAnswers).forEach(answer => {
                    categoryTotal += (answer * 20); // Convert 0-4 scale to 0-80 points
                });
                
                const maxQuestions = assessmentQuestions[category].length;
                const categoryScore = Math.round((categoryTotal / (maxQuestions * 80)) * 100);
                categoryScores[category] = categoryScore;
                totalScore += categoryScore;
            });
            
            const overallScore = Math.round(totalScore / 5);
            
            displayResults(overallScore);
        }
        
        // Display results
        function displayResults(overallScore) {
            document.getElementById('assessmentInterface').classList.add('hidden');
            document.getElementById('resultsDisplay').classList.remove('hidden');
            
            document.getElementById('totalScore').textContent = overallScore;
            document.getElementById('physicalScore').textContent = categoryScores.physical;
            document.getElementById('mentalScore').textContent = categoryScores.mental;
            document.getElementById('lifestyleScore').textContent = categoryScores.lifestyle;
            document.getElementById('environmentScore').textContent = categoryScores.environment;
            document.getElementById('historyScore').textContent = categoryScores.history;
            
            // Setup print details
            setupPrintDetails();
            
            generateRecommendations(overallScore);
            generateDetailedFindings();
        }
        
        // Setup print details
        function setupPrintDetails() {
            const clinicDetails = document.getElementById('clinicDetails');
            if (currentClinic) {
                clinicDetails.innerHTML = `
                    <p><strong>Clinic:</strong> ${currentClinic.clinic_name}</p>
                    <p><strong>Address:</strong> ${currentClinic.address}</p>
                    <p><strong>Phone:</strong> ${currentClinic.phone}</p>
                    <p><strong>Email:</strong> ${currentClinic.email}</p>
                `;
            }
            
            const printPatientDetails = document.getElementById('printPatientDetails');
            if (selectedPatient) {
                printPatientDetails.innerHTML = `
                    <p><strong>Name:</strong> ${selectedPatient.first_name} ${selectedPatient.last_name}</p>
                    <p><strong>Patient ID:</strong> ${selectedPatient.patient_id}</p>
                    <p><strong>Date of Birth:</strong> ${selectedPatient.date_of_birth || 'Not provided'}</p>
                    <p><strong>Gender:</strong> ${selectedPatient.gender || 'Not specified'}</p>
                    <p><strong>Address:</strong> ${selectedPatient.address || 'Not provided'}</p>
                `;
            }
            
            document.getElementById('reportDate').textContent = new Date().toLocaleDateString('en-GB');
        }
        
        // Generate therapy recommendations (max 2)
        function generateRecommendations(overallScore) {
            const recommendations = [];
            
            // Always include detoxification as mandatory
            recommendations.push("detoxification");
            
            // Find the lowest scoring category for second recommendation
            const categoryNames = ['physical', 'mental', 'lifestyle', 'environment', 'history'];
            let lowestCategory = categoryNames[0];
            let lowestScore = categoryScores[lowestCategory];
            
            categoryNames.forEach(category => {
                if (categoryScores[category] < lowestScore) {
                    lowestScore = categoryScores[category];
                    lowestCategory = category;
                }
            });
            
            // Add appropriate second therapy based on lowest scoring category
            if (lowestCategory === 'physical' && categoryScores.physical < 70) {
                recommendations.push(categoryScores.physical < 50 ? "pain_management" : "energy_enhancement");
            } else if (lowestCategory === 'mental' && categoryScores.mental < 70) {
                recommendations.push("stress_relief");
            } else if (lowestCategory === 'lifestyle' && categoryScores.lifestyle < 70) {
                recommendations.push("sleep_enhancement");
            } else if ((lowestCategory === 'environment' || lowestCategory === 'history') && lowestScore < 70) {
                recommendations.push("constitutional_support");
            }
            
            const recommendationsList = document.getElementById('recommendationsList');
            recommendationsList.innerHTML = recommendations.map(therapyKey => {
                const therapy = therapyDatabase[therapyKey];
                return `
                    <div class="therapy-detail">
                        <h4 style="color: #10b981; margin-bottom: 10px;">${therapy.name}</h4>
                        <p><strong>Overview:</strong> ${therapy.overview}</p>
                        <p><strong>Expected Benefits:</strong> ${therapy.benefits}</p>
                        <p><strong>Treatment Duration:</strong> ${therapy.duration}</p>
                        <p><strong>Sessions:</strong> ${therapy.sessions}</p>
                        <p><strong>Frequency:</strong> ${therapy.frequency}</p>
                        <p><strong>Session Length:</strong> ${therapy.sessionLength}</p>
                    </div>
                `;
            }).join('');
        }
        
        // Generate detailed findings for each category
        function generateDetailedFindings() {
            const categories = ['physical', 'mental', 'lifestyle', 'environment', 'history'];
            const categoryTitles = ['Physical Health', 'Mental Wellbeing', 'Lifestyle Factors', 'Environmental Health', 'Medical History'];
            
            const detailedFindings = document.getElementById('detailedFindings');
            
            detailedFindings.innerHTML = categories.map((category, index) => {
                const score = categoryScores[category];
                const status = score >= 80 ? 'Excellent' : score >= 70 ? 'Good' : score >= 60 ? 'Fair' : score >= 50 ? 'Poor' : 'Very Poor';
                const color = score >= 70 ? '#10b981' : score >= 50 ? '#f59e0b' : '#ef4444';
                
                let interpretation = '';
                if (category === 'physical') {
                    interpretation = score >= 70 ? 'Physical health indicators show good vitality and low pain levels.' : 'Physical health may benefit from targeted interventions to improve energy and reduce discomfort.';
                } else if (category === 'mental') {
                    interpretation = score >= 70 ? 'Mental wellbeing shows good stress management and mood stability.' : 'Mental health indicators suggest need for stress reduction and mood support interventions.';
                } else if (category === 'lifestyle') {
                    interpretation = score >= 70 ? 'Lifestyle factors indicate healthy habits supporting overall wellbeing.' : 'Lifestyle modifications recommended for improved nutrition, exercise, and sleep patterns.';
                } else if (category === 'environment') {
                    interpretation = score >= 70 ? 'Environmental health factors are supportive of overall wellness.' : 'Environmental factors may be impacting health and warrant attention.';
                } else if (category === 'history') {
                    interpretation = score >= 70 ? 'Medical history indicates good health foundation with minimal risk factors.' : 'Medical history suggests monitoring and support for chronic conditions or risk factors.';
                }
                
                return `
                    <div class="category-finding">
                        <h4 style="color: ${color}; margin-bottom: 10px;">${categoryTitles[index]} - Score: ${score}/100 (${status})</h4>
                        <p style="margin-bottom: 10px;"><strong>Assessment:</strong> ${interpretation}</p>
                        <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 4px;">
                            <strong>Category Responses:</strong><br>
                            ${assessmentQuestions[category].map((q, i) => 
                                `${i + 1}. ${q.text} → <em>${answers[category][i] !== undefined ? q.options[answers[category][i]] : 'Not answered'}</em>`
                            ).join('<br>')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Save assessment
        window.saveAssessment = async function() {
            if (!selectedPatient) {
                showAlert('No patient selected for assessment', 'error');
                return;
            }
            
            try {
                const overallScore = Math.round((Object.values(categoryScores).reduce((a, b) => a + b, 0)) / 5);
                const recommendations = Array.from(document.querySelectorAll('.therapy-detail h4')).map(item => item.textContent);
                
                const reportData = {
                    patient_info: {
                        name: `${selectedPatient.first_name} ${selectedPatient.last_name}`,
                        patient_id: selectedPatient.patient_id,
                        date_of_birth: selectedPatient.date_of_birth,
                        gender: selectedPatient.gender,
                        clinic: selectedPatient.clinics
                    },
                    assessment_responses: answers,
                    category_scores: categoryScores,
                    overall_score: overallScore,
                    recommendations: recommendations,
                    assessment_date: new Date().toISOString()
                };
                
                const { data, error } = await supabase
                    .from('medical_reports')
                    .insert([{
                        patient_id: selectedPatient.id,
                        clinic_id: selectedPatient.clinic_id,
                        report_type: 'health_assessment',
                        report_title: 'Comprehensive Health Assessment Report',
                        report_data: reportData,
                        recommendations: recommendations,
                        therapies_recommended: recommendations,
                        total_score: overallScore,
                        category_scores: categoryScores
                    }])
                    .select();
                    
                if (error) throw error;
                
                // Show success banner
                showAlert('✅ Assessment Report Saved Successfully! Report available in Patient Management records.', 'success');
                console.log('Assessment saved:', data);
                
            } catch (error) {
                console.error('Error saving assessment:', error);
                showAlert('Error saving assessment: ' + error.message, 'error');
            }
        };
        
        // Action button functions
        window.downloadPDF = function() {
            showAlert('PDF download functionality would be implemented here with professional A4 formatting', 'success');
            // In a real implementation, you would use a library like jsPDF or html2pdf
        };
        
        window.printReport = function() {
            window.print();
        };
        
        window.startIrisAnalysis = function() {
            if (selectedPatient) {
                const url = `iris-analysis.html?patient_id=${selectedPatient.id}`;
                window.open(url, '_blank');
            }
        };
        
        window.startNewAssessment = function() {
            if (confirm('Start a new assessment? Current progress will be lost.')) {
                location.reload();
            }
        };
        
        window.exitToPatientManagement = function() {
            window.location.href = 'patient-management.html';
        };
        
    </script>
</body>
</html>
