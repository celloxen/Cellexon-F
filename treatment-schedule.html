<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treatment Schedule - Celloxen Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #1f2937;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
        }
        
        .back-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .progress-bar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .progress-steps {
            display: flex;
            justify-content: space-between;
            position: relative;
        }
        
        .progress-step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }
        
        .progress-step::before {
            content: '';
            position: absolute;
            top: 20px;
            left: -50%;
            right: -50%;
            height: 2px;
            background: #e2e8f0;
            z-index: -1;
        }
        
        .progress-step:first-child::before {
            display: none;
        }
        
        .progress-step.completed::before {
            background: #10b981;
        }
        
        .progress-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e2e8f0;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .progress-step.active .progress-circle {
            background: linear-gradient(135deg, #1e3a8a, #1e40af);
            color: white;
            transform: scale(1.1);
        }
        
        .progress-step.completed .progress-circle {
            background: #10b981;
            color: white;
        }
        
        .schedule-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .card-header {
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 20px;
            margin-bottom: 25px;
        }
        
        .card-title {
            font-size: 22px;
            font-weight: 600;
            color: #1e293b;
        }
        
        .patient-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-item {
            padding: 15px;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 12px;
        }
        
        .summary-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .summary-value {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-top: 5px;
        }
        
        .therapy-list {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .therapy-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #1e3a8a;
        }
        
        .therapy-info {
            flex: 1;
        }
        
        .therapy-name {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 5px;
        }
        
        .therapy-duration {
            font-size: 14px;
            color: #64748b;
        }
        
        .frequency-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .frequency-input {
            width: 60px;
            padding: 8px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
        }
        
        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 25px;
        }
        
        .day-header {
            font-weight: 600;
            color: #475569;
            text-align: center;
            padding: 10px;
            background: #f1f5f9;
            border-radius: 8px;
        }
        
        .time-slot {
            padding: 12px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .time-slot:hover {
            border-color: #1e3a8a;
            background: #f0f9ff;
        }
        
        .time-slot.selected {
            background: linear-gradient(135deg, #dcfce7, #d1fae5);
            border-color: #10b981;
        }
        
        .treatment-summary {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border-radius: 12px;
            padding: 25px;
            margin-top: 30px;
        }
        
        .summary-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 20px;
        }
        
        .summary-details {
            display: grid;
            gap: 15px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        
        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background: #d1d5db;
        }
        
        .btn-outline {
            background: white;
            color: #1e3a8a;
            border: 2px solid #1e3a8a;
        }
        
        .btn-outline:hover {
            background: #f0f9ff;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-info {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }
        
        .alert-success {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
        }
        
        .close-btn:hover {
            color: #1e293b;
        }
        
        .bulk-action-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }
        
        .bulk-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div>
                <h1>Treatment Schedule Planning</h1>
                <p style="color: #cbd5e1; margin-top: 5px;">Configure therapy sessions and create treatment plan</p>
            </div>
            <a href="clinic-dashboard.html" class="back-btn">← Back to Dashboard</a>
        </div>
    </div>
    
    <div class="container">
        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-steps">
                <div class="progress-step completed">
                    <div class="progress-circle">✓</div>
                    <div>Health Assessment</div>
                </div>
                <div class="progress-step completed">
                    <div class="progress-circle">✓</div>
                    <div>IRIS Analysis</div>
                </div>
                <div class="progress-step completed">
                    <div class="progress-circle">✓</div>
                    <div>Diagnosis Report</div>
                </div>
                <div class="progress-step completed">
                    <div class="progress-circle">✓</div>
                    <div>Therapy Selection</div>
                </div>
                <div class="progress-step active">
                    <div class="progress-circle">5</div>
                    <div>Treatment Plan</div>
                </div>
            </div>
        </div>
        
        <!-- Patient Summary -->
        <div class="schedule-card">
            <div class="card-header">
                <h2 class="card-title">Patient Information</h2>
            </div>
            <div class="patient-summary" id="patientSummary">
                <!-- Patient details will be populated here -->
            </div>
        </div>
        
        <!-- Selected Therapies -->
        <div class="schedule-card">
            <div class="card-header">
                <h2 class="card-title">Selected Therapies</h2>
            </div>
            <div class="alert alert-info">
                Configure the frequency and schedule for each selected therapy. Recommended frequencies are based on the diagnosis.
            </div>
            <div class="therapy-list" id="therapyList">
                <!-- Selected therapies will be populated here -->
            </div>
        </div>
        
        <!-- Treatment Schedule -->
        <div class="schedule-card">
            <div class="card-header">
                <h2 class="card-title">Treatment Schedule Configuration</h2>
            </div>
            
            <div style="margin-bottom: 25px;">
                <label style="font-weight: 600; color: #1e293b; display: block; margin-bottom: 10px;">
                    Treatment Duration
                </label>
                <select id="treatmentDuration" class="frequency-input" style="width: 200px; padding: 10px;">
                    <option value="2">2 Weeks</option>
                    <option value="4" selected>4 Weeks</option>
                    <option value="6">6 Weeks</option>
                    <option value="8">8 Weeks</option>
                    <option value="12">12 Weeks</option>
                </select>
            </div>
            
            <div style="margin-bottom: 25px;">
                <label style="font-weight: 600; color: #1e293b; display: block; margin-bottom: 10px;">
                    Preferred Treatment Days
                </label>
                <div class="schedule-grid" id="daySelection">
                    <div class="time-slot" data-day="monday" onclick="toggleDay('monday')">Monday</div>
                    <div class="time-slot" data-day="tuesday" onclick="toggleDay('tuesday')">Tuesday</div>
                    <div class="time-slot" data-day="wednesday" onclick="toggleDay('wednesday')">Wednesday</div>
                    <div class="time-slot" data-day="thursday" onclick="toggleDay('thursday')">Thursday</div>
                    <div class="time-slot" data-day="friday" onclick="toggleDay('friday')">Friday</div>
                    <div class="time-slot" data-day="saturday" onclick="toggleDay('saturday')">Saturday</div>
                    <div class="time-slot" data-day="sunday" onclick="toggleDay('sunday')">Sunday</div>
                </div>
            </div>
            
            <div style="margin-bottom: 25px;">
                <label style="font-weight: 600; color: #1e293b; display: block; margin-bottom: 10px;">
                    Preferred Time Slot
                </label>
                <select id="timeSlot" style="width: 200px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px;">
                    <option value="morning">Morning (9:00 - 12:00)</option>
                    <option value="afternoon">Afternoon (12:00 - 17:00)</option>
                    <option value="evening">Evening (17:00 - 20:00)</option>
                </select>
            </div>
        </div>
        
        <!-- Treatment Summary -->
        <div class="schedule-card">
            <div class="treatment-summary">
                <h3 class="summary-title">Treatment Plan Summary</h3>
                <div class="summary-details" id="treatmentSummary">
                    <!-- Summary will be populated here -->
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="saveDraft()">Save as Draft</button>
                <button class="btn btn-outline" onclick="printPlan()">Print Treatment Plan</button>
                <button class="btn bulk-action-btn" onclick="proceedToBulkScheduling()">
                    Generate Bulk Appointments →
                </button>
                <button class="btn btn-primary" onclick="confirmTreatmentPlan()">
                    Confirm & Save Plan →
                </button>
            </div>
        </div>
    </div>
    
    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="color: #1e293b;">Treatment Plan Created Successfully!</h2>
                <button class="close-btn" onclick="closeModal()">×</button>
            </div>
            <div class="alert alert-success">
                The treatment plan has been successfully created and saved.
            </div>
            <div style="margin: 20px 0;">
                <p><strong>Plan ID:</strong> <span id="planId"></span></p>
                <p><strong>Start Date:</strong> <span id="startDate"></span></p>
                <p><strong>Total Sessions:</strong> <span id="totalSessions"></span></p>
            </div>
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="viewPlan()">View Full Plan</button>
                <button class="btn bulk-action-btn" onclick="goToAutomatedScheduler()">
                    Create Appointments →
                </button>
                <button class="btn btn-primary" onclick="goToDashboard()">Return to Dashboard</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { supabase } from './supabase-config.js';
        
        let patientData = null;
        let selectedTherapies = [];
        let selectedDays = [];
        let therapyFrequencies = {};
        let treatmentPlanId = null;
        
        // Available therapy details (from database)
        const therapyDetails = {};
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const patientId = urlParams.get('patient') || sessionStorage.getItem('currentPatientId');
            const planId = urlParams.get('planId') || sessionStorage.getItem('treatmentPlanId');
            
            if (!patientId) {
                alert('No patient selected. Redirecting to dashboard.');
                window.location.href = 'clinic-dashboard.html';
                return;
            }
            
            // Load therapy protocols from database
            await loadTherapyProtocols();
            
            // Load treatment plan if exists
            if (planId) {
                await loadExistingPlan(planId);
            } else {
                // Load selected therapies from session
                const therapyData = sessionStorage.getItem('selectedTherapies');
                if (!therapyData) {
                    alert('No therapies selected. Please complete therapy selection first.');
                    window.location.href = `report-generator.html?patient=${patientId}`;
                    return;
                }
                
                const parsedData = JSON.parse(therapyData);
                selectedTherapies = parsedData.selected_therapies || [];
            }
            
            await loadPatientData(patientId);
            displaySelectedTherapies();
            updateTreatmentSummary();
        });
        
        async function loadTherapyProtocols() {
            try {
                const { data, error } = await supabase
                    .from('therapy_configurations')
                    .select('*')
                    .eq('is_active', true);
                
                if (error) throw error;
                
                data.forEach(therapy => {
                    therapyDetails[therapy.therapy_code] = {
                        name: therapy.therapy_name,
                        duration: `${therapy.duration || 45} minutes`,
                        recommendedFrequency: 2,
                        category: therapy.category,
                        notes: therapy.notes
                    };
                });
                
            } catch (error) {
                console.error('Error loading therapy protocols:', error);
            }
        }
        
        async function loadExistingPlan(planId) {
            try {
                const { data, error } = await supabase
                    .from('treatment_plans')
                    .select('*')
                    .eq('id', planId)
                    .single();
                
                if (error) throw error;
                
                treatmentPlanId = planId;
                selectedTherapies = data.protocols || [];
                // Load other plan data
                
            } catch (error) {
                console.error('Error loading plan:', error);
            }
        }
        
        async function loadPatientData(patientId) {
            try {
                const { data, error } = await supabase
                    .from('patients')
                    .select('*')
                    .eq('id', patientId)
                    .single();
                
                if (error) throw error;
                
                patientData = data;
                displayPatientSummary();
                
            } catch (error) {
                console.error('Error loading patient:', error);
                alert('Error loading patient data');
            }
        }
        
        function displayPatientSummary() {
            const summaryDiv = document.getElementById('patientSummary');
            
            summaryDiv.innerHTML = `
                <div class="summary-item">
                    <div class="summary-label">Patient Name</div>
                    <div class="summary-value">${patientData.first_name} ${patientData.last_name}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Patient ID</div>
                    <div class="summary-value">${patientData.patient_id}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Age</div>
                    <div class="summary-value">${calculateAge(patientData.date_of_birth)} years</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Plan Start Date</div>
                    <div class="summary-value">${new Date().toLocaleDateString('en-GB')}</div>
                </div>
            `;
        }
        
        function displaySelectedTherapies() {
            const therapyListDiv = document.getElementById('therapyList');
            
            let therapyHtml = '';
            selectedTherapies.forEach(therapyId => {
                const therapy = therapyDetails[therapyId] || {
                    name: therapyId,
                    duration: '45 minutes',
                    recommendedFrequency: 2
                };
                
                const recommendedFreq = therapy.recommendedFrequency;
                therapyFrequencies[therapyId] = recommendedFreq;
                
                therapyHtml += `
                    <div class="therapy-item">
                        <div class="therapy-info">
                            <div class="therapy-name">${therapy.name}</div>
                            <div class="therapy-duration">Duration: ${therapy.duration}</div>
                        </div>
                        <div class="frequency-selector">
                            <label style="margin-right: 10px; color: #64748b;">Sessions per week:</label>
                            <input type="number" 
                                   class="frequency-input" 
                                   id="freq-${therapyId}"
                                   value="${recommendedFreq}" 
                                   min="1" 
                                   max="7"
                                   onchange="updateFrequency('${therapyId}', this.value)">
                            <span style="margin-left: 10px; font-size: 12px; color: #10b981;">
                                (Recommended: ${recommendedFreq})
                            </span>
                        </div>
                    </div>
                `;
            });
            
            therapyListDiv.innerHTML = therapyHtml || '<p>No therapies selected</p>';
        }
        
        window.updateFrequency = function(therapyId, value) {
            therapyFrequencies[therapyId] = parseInt(value);
            updateTreatmentSummary();
        };
        
        window.toggleDay = function(day) {
            const dayElement = document.querySelector(`[data-day="${day}"]`);
            
            if (selectedDays.includes(day)) {
                selectedDays = selectedDays.filter(d => d !== day);
                dayElement.classList.remove('selected');
            } else {
                selectedDays.push(day);
                dayElement.classList.add('selected');
            }
            
            updateTreatmentSummary();
        };
        
        function updateTreatmentSummary() {
            const summaryDiv = document.getElementById('treatmentSummary');
            const duration = parseInt(document.getElementById('treatmentDuration').value);
            
            let totalSessions = 0;
            selectedTherapies.forEach(therapyId => {
                const frequency = therapyFrequencies[therapyId] || 0;
                totalSessions += frequency * duration;
            });
            
            let summaryHtml = `
                <div class="summary-row">
                    <span>Treatment Duration:</span>
                    <strong>${duration} weeks</strong>
                </div>
                <div class="summary-row">
                    <span>Total Therapies:</span>
                    <strong>${selectedTherapies.length} therapies</strong>
                </div>
                <div class="summary-row">
                    <span>Total Sessions:</span>
                    <strong>${totalSessions} sessions</strong>
                </div>
                <div class="summary-row">
                    <span>Selected Days:</span>
                    <strong>${selectedDays.length > 0 ? selectedDays.join(', ') : 'None selected'}</strong>
                </div>
            `;
            
            summaryDiv.innerHTML = summaryHtml;
        }
        
        window.confirmTreatmentPlan = async function() {
            if (selectedDays.length === 0) {
                alert('Please select at least one treatment day');
                return;
            }
            
            const duration = parseInt(document.getElementById('treatmentDuration').value);
            const timeSlot = document.getElementById('timeSlot').value;
            
            // Calculate total sessions
            let totalSessions = 0;
            selectedTherapies.forEach(therapyId => {
                const frequency = therapyFrequencies[therapyId] || 0;
                totalSessions += frequency * duration;
            });
            
            // Create treatment plan object
            const treatmentPlan = {
                patient_id: patientData.id,
                clinic_id: patientData.clinic_id,
                duration_weeks: duration,
                sessions_per_week: Math.ceil(totalSessions / duration),
                total_sessions: totalSessions,
                protocols: selectedTherapies,
                protocol_details: selectedTherapies.map(id => therapyDetails[id] || { therapy_code: id }),
                selected_days: selectedDays,
                time_preference: timeSlot,
                start_date: new Date().toISOString(),
                status: 'planned',
                created_at: new Date().toISOString()
            };
            
            try {
                // Save to database
                const { data, error } = await supabase
                    .from('treatment_plans')
                    .insert([treatmentPlan])
                    .select()
                    .single();
                
                if (error) throw error;
                
                treatmentPlanId = data.id;
                
                // Save to session for next steps
                sessionStorage.setItem('treatmentPlanId', data.id);
                sessionStorage.setItem('treatmentPlan', JSON.stringify(data));
                
                // Show success modal
                showSuccessModal(data.id, treatmentPlan);
                
            } catch (error) {
                console.error('Error saving plan:', error);
                // Fallback to localStorage
                const planId = `PLAN-${Date.now()}`;
                localStorage.setItem(`treatment_plan_${planId}`, JSON.stringify(treatmentPlan));
                sessionStorage.setItem('treatmentPlanId', planId);
                sessionStorage.setItem('treatmentPlan', JSON.stringify(treatmentPlan));
                showSuccessModal(planId, treatmentPlan);
            }
        };
        
        window.proceedToBulkScheduling = function() {
            // Save current configuration
            const config = {
                patient_id: patientData.id,
                therapies: selectedTherapies,
                frequencies: therapyFrequencies,
                days: selectedDays,
                duration: document.getElementById('treatmentDuration').value,
                timeSlot: document.getElementById('timeSlot').value
            };
            
            sessionStorage.setItem('schedulingConfig', JSON.stringify(config));
            
            // Redirect to automated scheduler
            window.location.href = 'treatment-scheduler-auto.html';
        };
        
        function showSuccessModal(planId, plan) {
            const modal = document.getElementById('successModal');
            const totalSessions = plan.total_sessions;
            
            document.getElementById('planId').textContent = planId;
            document.getElementById('startDate').textContent = new Date().toLocaleDateString('en-GB');
            document.getElementById('totalSessions').textContent = totalSessions;
            
            modal.style.display = 'block';
        }
        
        window.closeModal = function() {
            document.getElementById('successModal').style.display = 'none';
        };
        
        window.viewPlan = function() {
            window.print();
            closeModal();
        };
        
        window.goToAutomatedScheduler = function() {
            window.location.href = `treatment-scheduler-auto.html?planId=${treatmentPlanId}`;
        };
        
        window.goToDashboard = function() {
            window.location.href = 'clinic-dashboard.html';
        };
        
        window.saveDraft = function() {
            const draftData = {
                patient_id: patientData.id,
                therapies: selectedTherapies,
                frequencies: therapyFrequencies,
                days: selectedDays,
                saved_at: new Date().toISOString()
            };
            
            localStorage.setItem(`treatment_draft_${patientData.id}`, JSON.stringify(draftData));
            alert('Treatment plan saved as draft. You can continue from the dashboard.');
        };
        
        window.printPlan = function() {
            window.print();
        };
        
        function calculateAge(dateOfBirth) {
            if (!dateOfBirth) return 'Unknown';
            const birthDate = new Date(dateOfBirth);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }
        
        // Update summary on duration change
        document.getElementById('treatmentDuration').addEventListener('change', updateTreatmentSummary);
    </script>
</body>
</html>
