<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treatment Planning - Celloxen Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
        }
        
        .header p {
            color: #cbd5e1;
            margin-top: 5px;
            font-size: 14px;
        }
        
        .back-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }
        
        .card h2 {
            font-size: 24px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .patient-header {
            background: linear-gradient(135deg, #1e3a8a, #1e40af);
            color: white;
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 25px;
        }
        
        .patient-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .info-item {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 8px;
        }
        
        .info-label {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
        }
        
        .info-value {
            font-size: 18px;
            font-weight: 600;
            margin-top: 5px;
        }
        
        .protocol-card {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-left: 4px solid #10b981;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .protocol-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .protocol-card.selected {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border-left-color: #059669;
        }
        
        .protocol-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        
        .protocol-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }
        
        .protocol-code {
            background: #1e3a8a;
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .protocol-priority {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .priority-mandatory {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .priority-primary {
            background: #fef3c7;
            color: #92400e;
        }
        
        .priority-secondary {
            background: #e0f2fe;
            color: #0369a1;
        }
        
        .protocol-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .detail-box {
            background: white;
            padding: 10px;
            border-radius: 8px;
        }
        
        .detail-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
        }
        
        .detail-value {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-top: 5px;
        }
        
        .schedule-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-top: 25px;
        }
        
        .summary-box {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 1px solid #1e3a8a;
            border-radius: 16px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .summary-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .summary-number {
            font-size: 32px;
            font-weight: bold;
            color: #1e3a8a;
        }
        
        .summary-label {
            font-size: 14px;
            color: #64748b;
            margin-top: 5px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        
        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
        }
        
        .btn-secondary:hover {
            background: #e2e8f0;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-success {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        
        .alert-info {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }
        
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #1e3a8a;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        input[type="date"], input[type="number"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #1e3a8a;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: #f1f5f9;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .checkbox-label:hover {
            background: #e2e8f0;
        }
        
        .checkbox-label input[type="checkbox"]:checked + span {
            color: #1e3a8a;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-container">
            <div>
                <h1>Treatment Planning</h1>
                <p>Configure therapy protocols and schedule</p>
            </div>
            <a href="clinic-dashboard.html" class="back-btn">← Back to Dashboard</a>
        </div>
    </div>
    
    <div class="container">
        <!-- Patient Information -->
        <div class="patient-header">
            <h2 style="margin: 0;">Treatment Plan Configuration</h2>
            <div class="patient-info-grid">
                <div class="info-item">
                    <div class="info-label">Patient</div>
                    <div class="info-value" id="patientName">Loading...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Patient ID</div>
                    <div class="info-value" id="patientId">--</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Report Date</div>
                    <div class="info-value" id="reportDate">--</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Status</div>
                    <div class="info-value">Planning Treatment</div>
                </div>
            </div>
        </div>
        
        <!-- Recommended Protocols -->
        <div class="card">
            <h2>Recommended Treatment Protocols</h2>
            <div class="alert alert-info">
                These protocols have been automatically selected based on the comprehensive diagnostic report. 
                Click on each protocol to see details and configure the treatment schedule.
            </div>
            <div id="protocolsList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading recommended protocols from database...</p>
                </div>
            </div>
        </div>
        
        <!-- Schedule Configuration -->
        <div class="card" id="scheduleCard" style="display: none;">
            <h2>Treatment Schedule Configuration</h2>
            <div class="schedule-grid">
                <div>
                    <label>Treatment Start Date</label>
                    <input type="date" id="startDate" min="">
                </div>
                <div>
                    <label>Treatment Duration (Weeks)</label>
                    <input type="number" id="durationWeeks" value="8" min="1" max="52">
                </div>
                <div>
                    <label>Sessions Per Week</label>
                    <input type="number" id="sessionsPerWeek" value="2" min="1" max="7">
                </div>
                <div>
                    <label>Session Duration</label>
                    <select id="sessionDuration">
                        <option value="30">30 minutes</option>
                        <option value="45" selected>45 minutes</option>
                        <option value="60">60 minutes</option>
                        <option value="90">90 minutes</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-top: 25px;">
                <label>Preferred Treatment Days</label>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="days" value="Monday" checked>
                        <span>Monday</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="days" value="Tuesday">
                        <span>Tuesday</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="days" value="Wednesday" checked>
                        <span>Wednesday</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="days" value="Thursday">
                        <span>Thursday</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="days" value="Friday" checked>
                        <span>Friday</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="days" value="Saturday">
                        <span>Saturday</span>
                    </label>
                </div>
            </div>
            
            <div style="margin-top: 25px; text-align: center;">
                <button class="btn btn-primary" onclick="calculatePlan()">
                    Calculate Treatment Plan
                </button>
            </div>
        </div>
        
        <!-- Treatment Summary -->
        <div class="card" id="summaryCard" style="display: none;">
            <h2>Treatment Plan Summary</h2>
            <div class="summary-box">
                <h3 style="color: #1e293b; margin-bottom: 20px;">Comprehensive Treatment Program</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-number" id="totalSessions">0</div>
                        <div class="summary-label">Total Sessions</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number" id="totalProtocols">0</div>
                        <div class="summary-label">Therapy Protocols</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number" id="totalWeeks">0</div>
                        <div class="summary-label">Weeks Duration</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number" id="estimatedHours">0</div>
                        <div class="summary-label">Total Hours</div>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-success" style="margin-top: 20px;">
                <strong>Treatment Plan Ready!</strong> Review the details above and confirm to begin the treatment program.
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="confirmTreatmentPlan()">
                    ✓ Confirm Treatment Plan
                </button>
                <button class="btn btn-secondary" onclick="adjustPlan()">
                    Adjust Schedule
                </button>
                <button class="btn btn-secondary" onclick="printPlan()">
                    Print Plan
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabase } from './supabase-config.js';
        import { workflowManager } from './workflow-manager.js';
        
        let selectedPatient = null;
        let recommendedProtocols = [];
        let selectedProtocols = [];
        let reportData = null;
        let treatmentPlan = {};
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('startDate').min = today;
            
            // Get patient ID from URL or session
            const urlParams = new URLSearchParams(window.location.search);
            const patientId = urlParams.get('patientId') || sessionStorage.getItem('currentPatientId');
            const reportId = urlParams.get('reportId') || sessionStorage.getItem('reportId');
            
            if (patientId) {
                await loadPatientData(patientId);
                await loadRecommendedProtocols(patientId, reportId);
            } else {
                alert('No patient selected. Please start from patient selection.');
                window.location.href = 'patient-management.html';
            }
        });
        
        async function loadPatientData(patientId) {
            try {
                const { data, error } = await supabase
                    .from('patients')
                    .select('*')
                    .eq('id', patientId)
                    .single();
                
                if (error) throw error;
                
                selectedPatient = data;
                document.getElementById('patientName').textContent = `${data.first_name} ${data.last_name}`;
                document.getElementById('patientId').textContent = data.patient_id;
                document.getElementById('reportDate').textContent = new Date().toLocaleDateString('en-GB');
                
            } catch (error) {
                console.error('Error loading patient:', error);
                alert('Error loading patient data');
            }
        }
        
        async function loadRecommendedProtocols(patientId, reportId) {
            try {
                // First, load the medical report to get recommendations
                const { data: report, error: reportError } = await supabase
                    .from('medical_reports')
                    .select('*')
                    .eq('patient_id', patientId)
                    .eq('id', reportId || 0)
                    .single();
                
                if (!reportError && report) {
                    reportData = report;
                    const therapyCodes = report.therapies_recommended || [];
                    
                    // Now load the full protocol details from therapy_configurations
                    const { data: protocols, error: protocolError } = await supabase
                        .from('therapy_configurations')
                        .select('*')
                        .in('therapy_code', therapyCodes)
                        .eq('is_active', true);
                    
                    if (!protocolError && protocols) {
                        recommendedProtocols = protocols;
                        displayProtocols(protocols);
                    } else {
                        // Use default protocols if none found
                        loadDefaultProtocols();
                    }
                } else {
                    // Load default protocols if no report found
                    loadDefaultProtocols();
                }
                
            } catch (error) {
                console.error('Error loading protocols:', error);
                loadDefaultProtocols();
            }
        }
        
        function loadDefaultProtocols() {
            // Default protocols based on common recommendations
            recommendedProtocols = [
                {
                    therapy_name: 'Stress Relief Therapy',
                    therapy_code: '602',
                    category: 'Stress, Anxiety & Sleep',
                    duration: 40,
                    conditions_treated: 'Anxiety, tension, stress',
                    notes: 'Calming protocol for stress relief',
                    priority: 'PRIMARY'
                },
                {
                    therapy_name: 'Energy Boost Therapy',
                    therapy_code: '701',
                    category: 'Digestive & Energy Wellness',
                    duration: 40,
                    conditions_treated: 'Vitality-enhancing',
                    notes: 'Boosts energy levels and vitality',
                    priority: 'SECONDARY'
                }
            ];
            displayProtocols(recommendedProtocols);
        }
        
        function displayProtocols(protocols) {
            const container = document.getElementById('protocolsList');
            
            if (protocols.length === 0) {
                container.innerHTML = '<p>No protocols found. Please check the therapy database.</p>';
                return;
            }
            
            container.innerHTML = protocols.map((protocol, index) => {
                const priority = determinePriority(protocol, index);
                const priorityClass = getPriorityClass(priority);
                
                return `
                    <div class="protocol-card" onclick="selectProtocol('${protocol.therapy_code}')" data-code="${protocol.therapy_code}">
                        <div class="protocol-header">
                            <div>
                                <div class="protocol-title">${protocol.therapy_name}</div>
                                <span class="protocol-priority ${priorityClass}">${priority}</span>
                            </div>
                            <div class="protocol-code">Code ${protocol.therapy_code}</div>
                        </div>
                        <div class="protocol-details">
                            <div class="detail-box">
                                <div class="detail-label">Category</div>
                                <div class="detail-value">${protocol.category}</div>
                            </div>
                            <div class="detail-box">
                                <div class="detail-label">Duration</div>
                                <div class="detail-value">${protocol.duration || 45} min</div>
                            </div>
                            <div class="detail-box">
                                <div class="detail-label">Conditions</div>
                                <div class="detail-value">${protocol.conditions_treated || 'General wellness'}</div>
                            </div>
                        </div>
                        ${protocol.notes ? `
                            <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 8px;">
                                <strong>Clinical Notes:</strong> ${protocol.notes}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            // Show schedule configuration
            document.getElementById('scheduleCard').style.display = 'block';
            
            // Auto-select all protocols initially
            protocols.forEach(p => {
                selectedProtocols.push(p.therapy_code);
            });
            document.querySelectorAll('.protocol-card').forEach(card => {
                card.classList.add('selected');
            });
        }
        
        function determinePriority(protocol, index) {
            if (protocol.priority) return protocol.priority;
            if (index === 0) return 'MANDATORY';
            if (index === 1) return 'PRIMARY';
            return 'SECONDARY';
        }
        
        function getPriorityClass(priority) {
            if (priority === 'MANDATORY') return 'priority-mandatory';
            if (priority === 'PRIMARY') return 'priority-primary';
            return 'priority-secondary';
        }
        
        window.selectProtocol = function(code) {
            const card = document.querySelector(`[data-code="${code}"]`);
            card.classList.toggle('selected');
            
            if (selectedProtocols.includes(code)) {
                selectedProtocols = selectedProtocols.filter(c => c !== code);
            } else {
                selectedProtocols.push(code);
            }
        };
        
        window.calculatePlan = function() {
            if (selectedProtocols.length === 0) {
                alert('Please select at least one treatment protocol');
                return;
            }
            
            const startDate = document.getElementById('startDate').value;
            const durationWeeks = parseInt(document.getElementById('durationWeeks').value);
            const sessionsPerWeek = parseInt(document.getElementById('sessionsPerWeek').value);
            const sessionDuration = parseInt(document.getElementById('sessionDuration').value);
            
            // Get selected days
            const selectedDays = [];
            document.querySelectorAll('input[name="days"]:checked').forEach(cb => {
                selectedDays.push(cb.value);
            });
            
            if (selectedDays.length === 0) {
                alert('Please select at least one treatment day');
                return;
            }
            
            // Calculate totals
            const totalSessions = durationWeeks * sessionsPerWeek;
            const totalHours = Math.round((totalSessions * sessionDuration) / 60);
            
            // Update summary
            document.getElementById('totalSessions').textContent = totalSessions;
            document.getElementById('totalProtocols').textContent = selectedProtocols.length;
            document.getElementById('totalWeeks').textContent = durationWeeks;
            document.getElementById('estimatedHours').textContent = totalHours;
            
            // Store plan details
            treatmentPlan = {
                patient_id: selectedPatient.id,
                clinic_id: selectedPatient.clinic_id,
                start_date: startDate,
                duration_weeks: durationWeeks,
                sessions_per_week: sessionsPerWeek,
                session_duration: sessionDuration,
                total_sessions: totalSessions,
                selected_days: selectedDays,
                protocols: selectedProtocols,
                protocol_details: recommendedProtocols.filter(p => 
                    selectedProtocols.includes(p.therapy_code)
                )
            };
            
            // Show summary
            document.getElementById('summaryCard').style.display = 'block';
            document.getElementById('summaryCard').scrollIntoView({ behavior: 'smooth' });
        };
        
        window.confirmTreatmentPlan = async function() {
            try {
                // Save treatment plan to database
                const { data, error } = await supabase
                    .from('treatment_plans')
                    .insert([{
                        ...treatmentPlan,
                        status: 'active',
                        created_at: new Date().toISOString(),
                        completed_sessions: 0
                    }])
                    .select()
                    .single();
                
                if (error) throw error;
                
                // Update workflow status
                await workflowManager.updateStage(selectedPatient.id, 'treatment_planning');
                
                // Store plan ID for next steps
                sessionStorage.setItem('treatmentPlanId', data.id);
                
                alert('Treatment plan confirmed successfully!');
                
                // Redirect to treatment schedule view
                window.location.href = `treatment-schedule.html?planId=${data.id}`;
                
            } catch (error) {
                console.error('Error saving treatment plan:', error);
                alert('Error saving treatment plan. Please try again.');
            }
        };
        
        window.adjustPlan = function() {
            document.getElementById('summaryCard').style.display = 'none';
            document.getElementById('scheduleCard').scrollIntoView({ behavior: 'smooth' });
        };
        
        window.printPlan = function() {
            window.print();
        };
    </script>
</body>
</html>
