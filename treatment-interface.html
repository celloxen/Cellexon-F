<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treatment Interface - CELLOXEN HEALTH PLATFORM</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        /* Header */
        .header {
            background: #1e3a8a;
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-secondary {
            background: white;
            color: #1e3a8a;
        }
        
        .btn-secondary:hover {
            background: #f0f0f0;
        }
        
        .btn-probe {
            background: #10b981;
            color: white;
        }
        
        .btn-probe:hover {
            background: #059669;
        }
        
        /* Container */
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 400px 1fr 400px;
            gap: 20px;
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .card h2 {
            color: #1e3a8a;
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        /* Patient Selection */
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            font-size: 14px;
            background: white;
        }
        
        .patient-info {
            margin-top: 15px;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 5px;
            border-left: 3px solid #3b82f6;
        }
        
        .patient-detail {
            margin: 5px 0;
        }
        
        .patient-detail strong {
            color: #1e3a8a;
        }
        
        /* Protocol Selection */
        .protocol-category {
            margin-bottom: 15px;
        }
        
        .protocol-category h3 {
            color: #374151;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .protocol-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .protocol-card:hover {
            background: #e0f2fe;
            border-color: #3b82f6;
        }
        
        .protocol-card.selected {
            background: #dbeafe;
            border-color: #2563eb;
            border-width: 2px;
        }
        
        /* Therapy Information */
        .therapy-info {
            background: #f0fdf4;
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .therapy-detail {
            margin: 8px 0;
            padding: 8px;
            background: white;
            border-radius: 5px;
        }
        
        /* Probe Checklist */
        .probe-checklist {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .probe-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 8px 0;
            background: white;
            border-radius: 5px;
            border: 1px solid #e5e7eb;
        }
        
        .probe-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 15px;
            cursor: pointer;
        }
        
        .probe-label {
            flex: 1;
        }
        
        .probe-position {
            font-weight: 600;
            color: #1e3a8a;
        }
        
        .probe-location {
            font-size: 13px;
            color: #6b7280;
            margin-top: 3px;
        }
        
        .probe-settings {
            font-size: 12px;
            color: #059669;
            margin-left: auto;
            padding: 3px 8px;
            background: #f0fdf4;
            border-radius: 3px;
        }
        
        /* Ready Status */
        .ready-status {
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .ready-status.not-ready {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        
        .ready-status.ready {
            background: #dcfce7;
            border: 1px solid #10b981;
            color: #14532d;
        }
        
        .status-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .status-message {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .status-detail {
            font-size: 14px;
        }
        
        /* Confirm Button */
        .btn-confirm {
            width: 100%;
            padding: 15px;
            background: #10b981;
            color: white;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-confirm:hover:not(:disabled) {
            background: #059669;
        }
        
        .btn-confirm:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        /* Session Info */
        .session-info {
            background: #f9fafb;
            padding: 15px;
            border-radius: 5px;
        }
        
        .session-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        /* Notes */
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
        }
        
        /* Instructions */
        .instructions {
            background: #eff6ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .instructions h3 {
            color: #1e3a8a;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .instructions ol {
            margin-left: 20px;
        }
        
        .instructions li {
            margin: 5px 0;
            color: #374151;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <h1>CELLOXEN HEALTH PLATFORM - Treatment Setup</h1>
            <div class="header-buttons">
                <button class="btn btn-probe" onclick="openProbeGuide()">
                    📋 View Probe Placement Guide
                </button>
                <button class="btn btn-secondary" onclick="window.location.href='clinic-dashboard.html'">
                    Back to Dashboard
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main Container -->
    <div class="container">
        <div class="main-grid">
            <!-- Left Column: Patient & Protocol Selection -->
            <div>
                <!-- Patient Selection -->
                <div class="card">
                    <h2>1. Select Patient</h2>
                    <select id="patientSelect">
                        <option value="">Choose a patient...</option>
                    </select>
                    <div id="patientInfo" class="patient-info" style="display: none;">
                        <div class="patient-detail">
                            <strong>Name:</strong> <span id="patientName">-</span>
                        </div>
                        <div class="patient-detail">
                            <strong>ID:</strong> <span id="patientId">-</span>
                        </div>
                        <div class="patient-detail">
                            <strong>Age:</strong> <span id="patientAge">-</span>
                        </div>
                        <div class="patient-detail">
                            <strong>Gender:</strong> <span id="patientGender">-</span>
                        </div>
                        <div class="patient-detail">
                            <strong>Last Visit:</strong> <span id="lastVisit">-</span>
                        </div>
                        <div class="patient-detail">
                            <strong>Health Score:</strong> <span id="healthScore">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Protocol Selection -->
                <div class="card">
                    <h2>2. Select Therapy Protocol</h2>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <div id="protocolsList"></div>
                    </div>
                </div>
            </div>
            
            <!-- Center Column: Therapy Info & Probe Verification -->
            <div>
                <!-- Instructions -->
                <div class="instructions">
                    <h3>Treatment Setup Process</h3>
                    <ol>
                        <li>Select the patient from the list</li>
                        <li>Choose the appropriate therapy protocol</li>
                        <li>Review probe placement locations</li>
                        <li>Click "View Probe Placement Guide" for visual reference</li>
                        <li>Place all 5 probes on the patient as indicated</li>
                        <li>Check each probe box to confirm placement</li>
                        <li>Once all probes are confirmed, press "Setup Complete"</li>
                        <li>Start the treatment on the device</li>
                    </ol>
                </div>
                
                <!-- Therapy Information -->
                <div class="card">
                    <h2>Therapy Information</h2>
                    <div id="therapyInfo" style="display: none;">
                        <div class="therapy-info">
                            <div class="therapy-detail">
                                <strong>Protocol:</strong> <span id="protocolName">-</span>
                            </div>
                            <div class="therapy-detail">
                                <strong>Code:</strong> <span id="protocolCode">-</span>
                            </div>
                            <div class="therapy-detail">
                                <strong>Duration:</strong> <span id="protocolDuration">-</span> minutes
                            </div>
                            <div class="therapy-detail">
                                <strong>Number of Probes:</strong> 5 probes (4 active + 1 ground)
                            </div>
                            <div class="therapy-detail">
                                <strong>Conditions Treated:</strong> <span id="protocolConditions">-</span>
                            </div>
                        </div>
                    </div>
                    <div id="noTherapySelected" style="text-align: center; padding: 20px; color: #6b7280;">
                        Please select a patient and therapy protocol
                    </div>
                </div>
                
                <!-- Probe Checklist -->
                <div class="card">
                    <h2>3. Probe Placement Verification</h2>
                    <div id="probeChecklist" style="display: none;">
                        <div class="probe-checklist">
                            <p style="margin-bottom: 10px; font-weight: 600;">
                                Confirm all 5 probes are correctly placed:
                            </p>
                            
                            <!-- Probe A -->
                            <div class="probe-item">
                                <input type="checkbox" class="probe-checkbox" id="probeA" onchange="checkAllProbes()">
                                <div class="probe-label">
                                    <div class="probe-position">Probe A (Red Cable)</div>
                                    <div class="probe-location" id="probeALocation">-</div>
                                </div>
                                <div class="probe-settings" id="probeASettings">-</div>
                            </div>
                            
                            <!-- Probe B -->
                            <div class="probe-item">
                                <input type="checkbox" class="probe-checkbox" id="probeB" onchange="checkAllProbes()">
                                <div class="probe-label">
                                    <div class="probe-position">Probe B (Blue Cable)</div>
                                    <div class="probe-location" id="probeBLocation">-</div>
                                </div>
                                <div class="probe-settings" id="probeBSettings">-</div>
                            </div>
                            
                            <!-- Probe C -->
                            <div class="probe-item">
                                <input type="checkbox" class="probe-checkbox" id="probeC" onchange="checkAllProbes()">
                                <div class="probe-label">
                                    <div class="probe-position">Probe C (Green Cable)</div>
                                    <div class="probe-location" id="probeCLocation">-</div>
                                </div>
                                <div class="probe-settings" id="probeCSettings">-</div>
                            </div>
                            
                            <!-- Probe D -->
                            <div class="probe-item">
                                <input type="checkbox" class="probe-checkbox" id="probeD" onchange="checkAllProbes()">
                                <div class="probe-label">
                                    <div class="probe-position">Probe D (Yellow Cable)</div>
                                    <div class="probe-location" id="probeDLocation">-</div>
                                </div>
                                <div class="probe-settings" id="probeDSettings">-</div>
                            </div>
                            
                            <!-- Ground Probe -->
                            <div class="probe-item">
                                <input type="checkbox" class="probe-checkbox" id="probeGround" onchange="checkAllProbes()">
                                <div class="probe-label">
                                    <div class="probe-position">Ground Probe (Black Cable)</div>
                                    <div class="probe-location">Wrist or ankle (patient preference)</div>
                                </div>
                                <div class="probe-settings">Ground</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Ready Status -->
                <div id="readyStatus" class="ready-status not-ready">
                    <div class="status-icon">⚠️</div>
                    <div class="status-message">Setup Not Complete</div>
                    <div class="status-detail">Please complete all steps above</div>
                </div>
                
                <!-- Confirm Button -->
                <button class="btn-confirm" id="confirmBtn" onclick="confirmSetup()" disabled>
                    Setup Complete - Ready for Treatment
                </button>
            </div>
            
            <!-- Right Column: Session Info & Notes -->
            <div>
                <!-- Session Information -->
                <div class="card">
                    <h2>Session Information</h2>
                    <div class="session-info">
                        <p><strong>Date:</strong> <span id="sessionDate"></span></p>
                        <p><strong>Time:</strong> <span id="sessionTime"></span></p>
                        <p><strong>Practitioner:</strong> <span id="practitionerName">Dr. Smith</span></p>
                        <p><strong>Clinic:</strong> London Wellness Centre</p>
                        <p><strong>Device ID:</strong> CEL-001</p>
                        <p><strong>Session ID:</strong> <span id="sessionId">-</span></p>
                    </div>
                </div>
                
                <!-- Treatment Notes -->
                <div class="card">
                    <h2>Treatment Notes</h2>
                    <textarea id="treatmentNotes" rows="6" 
                              placeholder="Enter any relevant notes about the treatment setup or patient condition..."></textarea>
                </div>
                
                <!-- Device Status -->
                <div class="card">
                    <h2>Device Status</h2>
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 48px; margin-bottom: 10px;">🔌</div>
                        <p style="font-weight: 600; color: #10b981;">Device Connected</p>
                        <p style="color: #6b7280; margin-top: 10px;">
                            Once setup is complete, press START on the device
                        </p>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="card">
                    <h2>Quick Actions</h2>
                    <button class="btn btn-secondary" onclick="viewPatientHistory()" 
                            style="width: 100%; margin-bottom: 10px;">
                        View Patient History
                    </button>
                    <button class="btn btn-secondary" onclick="printSetupSheet()" 
                            style="width: 100%;">
                        Print Setup Sheet
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Supabase Integration -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase Configuration
        const supabaseUrl = 'https://defifwzgazqlrigwumqn.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRlZmlmd3pnYXpxbHJpZ3d1bXFuIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NzI1MzQyNiwiZXhwIjoyMDcyODI5NDI2fQ.Z2rYuNduatwFsIfiA4aO-g__GNtQKAXBEyHBLG4r5W8';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // Therapy Protocols with Probe Placements
        const therapyProtocols = {
            '100': {
                name: 'Blood Sugar Balance',
                category: 'Metabolic',
                duration: 45,
                conditions: 'Diabetes support, insulin sensitivity, metabolic syndrome',
                probes: {
                    A: { location: 'DU4 + BL23 - lower back kidney region', settings: 'Low temp' },
                    B: { location: 'SP6 - inner ankle', settings: 'Low temp' },
                    C: { location: 'ST36 - below knee', settings: 'Low temp' },
                    D: { location: 'LI4 - hand web', settings: 'Low temp' }
                }
            },
            '101': {
                name: 'Deep Sleep Renewal',
                category: 'Sleep & Stress',
                duration: 30,
                conditions: 'Insomnia, restless sleep, sleep quality issues',
                probes: {
                    A: { location: 'DU4 + BL23 - kidney energy support', settings: 'Weak temp' },
                    B: { location: 'DU14 - upper back calming', settings: 'Weak temp' },
                    C: { location: 'GB20 + DU16 - neck relaxation', settings: 'Weak temp' },
                    D: { location: 'Temples (EX-HN5) - bilateral', settings: 'Very gentle' }
                }
            },
            '102': {
                name: 'Stress Relief',
                category: 'Sleep & Stress',
                duration: 40,
                conditions: 'Anxiety, tension, nervous exhaustion',
                probes: {
                    A: { location: 'HT7 - inner wrist', settings: 'Very gentle' },
                    B: { location: 'EX-HN3 - forehead', settings: 'Very gentle' },
                    C: { location: 'DU20 - crown', settings: 'Very gentle' },
                    D: { location: 'PC6 - inner forearm', settings: 'Very gentle' }
                }
            },
            '103': {
                name: 'Relaxation & Calm',
                category: 'Sleep & Stress',
                duration: 35,
                conditions: 'Daily stress, mental fatigue, emotional tension',
                probes: {
                    A: { location: 'Temple regions', settings: 'Low intensity' },
                    B: { location: 'Inner wrist (PC6)', settings: 'Low intensity' },
                    C: { location: 'Ankle (SP6)', settings: 'Low intensity' },
                    D: { location: 'Back of neck', settings: 'Low intensity' }
                }
            },
            '104': {
                name: 'Sleep Quality',
                category: 'Sleep & Stress',
                duration: 45,
                conditions: 'Poor sleep quality, frequent waking, unrefreshing sleep',
                probes: {
                    A: { location: 'Forehead center', settings: 'Very low' },
                    B: { location: 'Behind ears', settings: 'Very low' },
                    C: { location: 'Upper chest', settings: 'Very low' },
                    D: { location: 'Solar plexus', settings: 'Very low' }
                }
            },
            '201': {
                name: 'Kidney Detox',
                category: 'Kidney & Urinary',
                duration: 35,
                conditions: 'Fatigue, fluid retention, kidney function support',
                probes: {
                    A: { location: 'DU4 + BL23', settings: 'Low, 4-6' },
                    B: { location: 'BL23 - upper back', settings: 'Low, 3-5' },
                    C: { location: 'BL23 - liver reflex (left)', settings: 'Weak, 3-5' },
                    D: { location: 'KI3 + KI1 bilateral', settings: 'Weak, 2-5' }
                }
            },
            '202': {
                name: 'Kidney Support',
                category: 'Kidney & Urinary',
                duration: 40,
                conditions: 'Kidney weakness, lower back pain, energy depletion',
                probes: {
                    A: { location: 'DU4 - kidney energy center', settings: 'Low, 3-7' },
                    B: { location: 'BL23 - kidney back-shu', settings: 'Low, 3-7' },
                    C: { location: 'BL23 - reinforcement', settings: 'Low, 3-7' },
                    D: { location: 'ST36 (morning) or KI1/SP6 (afternoon)', settings: 'Low, 3-7' }
                }
            },
            '203': {
                name: 'Bladder Comfort',
                category: 'Kidney & Urinary',
                duration: 30,
                conditions: 'Bladder irritation, frequency, urgency',
                probes: {
                    A: { location: 'CV3 - lower abdomen', settings: 'Gentle' },
                    B: { location: 'BL28 - bladder shu', settings: 'Gentle' },
                    C: { location: 'SP6 - inner ankle', settings: 'Gentle' },
                    D: { location: 'BL32 - sacrum', settings: 'Gentle' }
                }
            },
            '204': {
                name: 'Urinary Balance',
                category: 'Kidney & Urinary',
                duration: 25,
                conditions: 'UTI prevention, urinary health maintenance',
                probes: {
                    A: { location: 'Lower abdomen (CV4)', settings: 'Mild' },
                    B: { location: 'Lower back (BL23)', settings: 'Mild' },
                    C: { location: 'Inner thigh (SP10)', settings: 'Mild' },
                    D: { location: 'Ankle (KI3)', settings: 'Mild' }
                }
            },
            '301': {
                name: 'Heart Health',
                category: 'Cardiovascular',
                duration: 40,
                conditions: 'Heart rhythm support, circulation, chest tightness',
                probes: {
                    A: { location: 'PC6 - inner forearm', settings: 'Moderate' },
                    B: { location: 'HT7 - wrist crease', settings: 'Moderate' },
                    C: { location: 'CV17 - chest center', settings: 'Gentle' },
                    D: { location: 'BL15 - heart shu', settings: 'Moderate' }
                }
            },
            '302': {
                name: 'Blood Pressure Balance',
                category: 'Cardiovascular',
                duration: 35,
                conditions: 'Hypertension support, stress-related BP issues',
                probes: {
                    A: { location: 'LI11 - elbow crease', settings: 'Moderate' },
                    B: { location: 'GB20 - base of skull', settings: 'Gentle' },
                    C: { location: 'ST36 - below knee', settings: 'Moderate' },
                    D: { location: 'LR3 - foot', settings: 'Gentle' }
                }
            },
            '303': {
                name: 'Circulation Boost',
                category: 'Cardiovascular',
                duration: 30,
                conditions: 'Poor circulation, cold extremities, varicose veins',
                probes: {
                    A: { location: 'SP6 - inner ankle', settings: 'Moderate' },
                    B: { location: 'ST36 - leg', settings: 'Moderate' },
                    C: { location: 'LI4 - hand', settings: 'Moderate' },
                    D: { location: 'BL40 - behind knee', settings: 'Gentle' }
                }
            },
            '304': {
                name: 'Cardiovascular Vitality',
                category: 'Cardiovascular',
                duration: 45,
                conditions: 'Overall heart health, endurance, energy',
                probes: {
                    A: { location: 'Heart area (CV17)', settings: 'Low-moderate' },
                    B: { location: 'Upper back (BL15)', settings: 'Low-moderate' },
                    C: { location: 'Wrist (PC6)', settings: 'Low-moderate' },
                    D: { location: 'Ankle (SP6)', settings: 'Low-moderate' }
                }
            },
            '401': {
                name: 'Joint Wellness',
                category: 'Joint & Mobility',
                duration: 30,
                conditions: 'Joint stiffness, morning stiffness, flexibility',
                probes: {
                    A: { location: 'Affected joint - anterior', settings: 'Moderate' },
                    B: { location: 'Affected joint - posterior', settings: 'Moderate' },
                    C: { location: 'GB34 - knee side', settings: 'Moderate' },
                    D: { location: 'SP5 - ankle', settings: 'Gentle' }
                }
            },
            '402': {
                name: 'Arthritis Relief',
                category: 'Joint & Mobility',
                duration: 35,
                conditions: 'Arthritis pain, inflammation, joint degeneration',
                probes: {
                    A: { location: 'Primary affected joint', settings: 'High' },
                    B: { location: 'Secondary affected area', settings: 'High' },
                    C: { location: 'ST36 - systemic support', settings: 'Moderate' },
                    D: { location: 'LI4 - pain relief', settings: 'Moderate' }
                }
            },
            '403': {
                name: 'Mobility Enhancement',
                category: 'Joint & Mobility',
                duration: 30,
                conditions: 'Reduced mobility, muscle tension, recovery',
                probes: {
                    A: { location: 'Hip area (GB30)', settings: 'Moderate' },
                    B: { location: 'Lower back (BL23)', settings: 'Moderate' },
                    C: { location: 'Knee (ST35)', settings: 'Moderate' },
                    D: { location: 'Ankle (BL60)', settings: 'Gentle' }
                }
            },
            '501': {
                name: 'Pain Management',
                category: 'Healing Support',
                duration: 30,
                conditions: 'Chronic pain, acute pain, pain relief',
                probes: {
                    A: { location: 'Primary pain site', settings: 'High' },
                    B: { location: 'Opposite side balance', settings: 'Moderate' },
                    C: { location: 'LI4 - general pain', settings: 'High' },
                    D: { location: 'ST36 - support', settings: 'Moderate' }
                }
            },
            '502': {
                name: 'Inflammation Control',
                category: 'Healing Support',
                duration: 40,
                conditions: 'Inflammatory conditions, swelling, heat',
                probes: {
                    A: { location: 'Inflamed area - center', settings: 'Moderate' },
                    B: { location: 'Inflamed area - periphery', settings: 'Gentle' },
                    C: { location: 'SP6 - cooling', settings: 'Moderate' },
                    D: { location: 'LI11 - heat clearing', settings: 'Moderate' }
                }
            },
            '601': {
                name: 'Immune Boost',
                category: 'Wellness & Energy',
                duration: 35,
                conditions: 'Weak immunity, frequent illness, recovery',
                probes: {
                    A: { location: 'ST36 - immune point', settings: 'Moderate' },
                    B: { location: 'CV6 - energy center', settings: 'Moderate' },
                    C: { location: 'BL23 - kidney support', settings: 'Gentle' },
                    D: { location: 'LI4 - defensive qi', settings: 'Moderate' }
                }
            },
            '602': {
                name: 'Energy Enhancement',
                category: 'Wellness & Energy',
                duration: 30,
                conditions: 'Fatigue, low energy, exhaustion',
                probes: {
                    A: { location: 'CV4 - vital energy', settings: 'Moderate' },
                    B: { location: 'ST36 - stamina', settings: 'Moderate' },
                    C: { location: 'GV20 - lifting energy', settings: 'Gentle' },
                    D: { location: 'PC6 - circulation', settings: 'Moderate' }
                }
            },
            '703': {
                name: 'Cellular Regeneration',
                category: 'Wellness & Energy',
                duration: 45,
                conditions: 'Anti-aging, tissue repair, cellular health',
                probes: {
                    A: { location: 'CV8 - navel center', settings: 'Low' },
                    B: { location: 'GV4 - life gate', settings: 'Low' },
                    C: { location: 'ST36 - longevity', settings: 'Low' },
                    D: { location: 'SP6 - three yin', settings: 'Low' }
                }
            },
            '801': {
                name: 'Full Body Wellness',
                category: 'Comprehensive',
                duration: 60,
                conditions: 'Overall health optimization, preventive care',
                probes: {
                    A: { location: 'GV20 - crown', settings: 'Balanced' },
                    B: { location: 'CV4 - lower dantian', settings: 'Balanced' },
                    C: { location: 'PC6 - inner gate', settings: 'Balanced' },
                    D: { location: 'ST36 - leg three li', settings: 'Balanced' }
                }
            },
            '802': {
                name: 'Complete Vitality',
                category: 'Comprehensive',
                duration: 60,
                conditions: 'Energy restoration, full system balance',
                probes: {
                    A: { location: 'Multiple points - rotating', settings: 'Variable' },
                    B: { location: 'Based on assessment', settings: 'Variable' },
                    C: { location: 'Customized placement', settings: 'Variable' },
                    D: { location: 'Practitioner discretion', settings: 'Variable' }
                }
            }
        };
        
        // Global Variables
        let selectedPatient = null;
        let selectedProtocol = null;
        let allProbesChecked = false;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadPatients();
            loadProtocols();
            updateDateTime();
            setInterval(updateDateTime, 60000);
        });
        
        // Load Patients
        async function loadPatients() {
            try {
                const { data, error } = await supabase
                    .from('patients')
                    .select('*')
                    .order('first_name');
                
                if (error) throw error;
                
                const patientSelect = document.getElementById('patientSelect');
                data.forEach(patient => {
                    const option = document.createElement('option');
                    option.value = patient.patient_id;
                    option.textContent = `${patient.first_name} ${patient.last_name} (${patient.patient_id})`;
                    patientSelect.appendChild(option);
                });
                
                patientSelect.addEventListener('change', async function() {
                    if (this.value) {
                        const patient = data.find(p => p.patient_id === this.value);
                        await selectPatient(patient);
                    } else {
                        selectedPatient = null;
                        document.getElementById('patientInfo').style.display = 'none';
                        updateReadyStatus();
                    }
                });
                
            } catch (error) {
                console.error('Error loading patients:', error);
            }
        }
        
        // Select Patient
        async function selectPatient(patient) {
            selectedPatient = patient;
            
            // Update patient info display
            document.getElementById('patientName').textContent = `${patient.first_name} ${patient.last_name}`;
            document.getElementById('patientId').textContent = patient.patient_id;
            document.getElementById('patientAge').textContent = calculateAge(patient.date_of_birth);
            document.getElementById('patientGender').textContent = patient.gender;
            
            // Load last visit
            try {
                const { data: sessions } = await supabase
                    .from('treatment_sessions')
                    .select('start_time')
                    .eq('patient_id', patient.patient_id)
                    .order('start_time', { ascending: false })
                    .limit(1);
                
                if (sessions && sessions.length > 0) {
                    const lastVisit = new Date(sessions[0].start_time);
                    document.getElementById('lastVisit').textContent = lastVisit.toLocaleDateString();
                } else {
                    document.getElementById('lastVisit').textContent = 'First visit';
                }
                
                // Load health score
                const { data: assessment } = await supabase
                    .from('health_assessments')
                    .select('total_score')
                    .eq('patient_id', patient.patient_id)
                    .order('assessment_date', { ascending: false })
                    .limit(1)
                    .single();
                
                if (assessment) {
                    document.getElementById('healthScore').textContent = `${assessment.total_score}/100`;
                } else {
                    document.getElementById('healthScore').textContent = 'No assessment';
                }
                
            } catch (error) {
                console.error('Error loading patient history:', error);
            }
            
            document.getElementById('patientInfo').style.display = 'block';
            updateReadyStatus();
        }
        
        // Load Protocols
        function loadProtocols() {
            const protocolsList = document.getElementById('protocolsList');
            const categories = {};
            
            // Group protocols by category
            Object.entries(therapyProtocols).forEach(([code, protocol]) => {
                if (!categories[protocol.category]) {
                    categories[protocol.category] = [];
                }
                categories[protocol.category].push({ code, ...protocol });
            });
            
            // Create UI for each category
            Object.entries(categories).forEach(([category, protocols]) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'protocol-category';
                
                const categoryTitle = document.createElement('h3');
                categoryTitle.textContent = category;
                categoryDiv.appendChild(categoryTitle);
                
                protocols.forEach(protocol => {
                    const protocolCard = document.createElement('div');
                    protocolCard.className = 'protocol-card';
                    protocolCard.innerHTML = `
                        <strong>${protocol.code}: ${protocol.name}</strong><br>
                        <small>${protocol.duration} minutes</small>
                    `;
                    protocolCard.onclick = function() { selectProtocol(protocol.code); };
                    categoryDiv.appendChild(protocolCard);
                });
                
                protocolsList.appendChild(categoryDiv);
            });
        }
        
        // Select Protocol from Database
        function selectProtocolFromDB(protocol) {
            selectedProtocol = {
                code: protocol.therapy_code,
                name: protocol.therapy_name,
                category: protocol.category,
                duration: protocol.duration || 30,
                conditions: protocol.conditions_treated || 'Various conditions',
                probes: {
                    A: { 
                        location: protocol.probe_a_location || 'See guide', 
                        settings: protocol.probe_a_settings || 'Standard' 
                    },
                    B: { 
                        location: protocol.probe_b_location || 'See guide', 
                        settings: protocol.probe_b_settings || 'Standard' 
                    },
                    C: { 
                        location: protocol.probe_c_location || 'See guide', 
                        settings: protocol.probe_c_settings || 'Standard' 
                    },
                    D: { 
                        location: protocol.probe_d_location || 'See guide', 
                        settings: protocol.probe_d_settings || 'Standard' 
                    }
                }
            };
            
            // Update UI
            document.querySelectorAll('.protocol-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.protocol-card').classList.add('selected');
            
            // Show therapy info
            document.getElementById('protocolName').textContent = selectedProtocol.name;
            document.getElementById('protocolCode').textContent = selectedProtocol.code;
            document.getElementById('protocolDuration').textContent = selectedProtocol.duration;
            document.getElementById('protocolConditions').textContent = selectedProtocol.conditions;
            
            // Update probe locations
            document.getElementById('probeALocation').textContent = selectedProtocol.probes.A.location;
            document.getElementById('probeASettings').textContent = selectedProtocol.probes.A.settings;
            
            document.getElementById('probeBLocation').textContent = selectedProtocol.probes.B.location;
            document.getElementById('probeBSettings').textContent = selectedProtocol.probes.B.settings;
            
            document.getElementById('probeCLocation').textContent = selectedProtocol.probes.C.location;
            document.getElementById('probeCSettings').textContent = selectedProtocol.probes.C.settings;
            
            document.getElementById('probeDLocation').textContent = selectedProtocol.probes.D.location;
            document.getElementById('probeDSettings').textContent = selectedProtocol.probes.D.settings;
            
            // Show sections
            document.getElementById('therapyInfo').style.display = 'block';
            document.getElementById('noTherapySelected').style.display = 'none';
            document.getElementById('probeChecklist').style.display = 'block';
            
            // Reset checkboxes
            document.querySelectorAll('.probe-checkbox').forEach(cb => cb.checked = false);
            
            updateReadyStatus();
            updateDeviceStatus();
        }
        
        // Select Protocol (fallback for hardcoded)
        function selectProtocol(protocolCode) {
            selectedProtocol = therapyProtocols[protocolCode];
            selectedProtocol.code = protocolCode;
            
            // Update UI
            document.querySelectorAll('.protocol-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.protocol-card').classList.add('selected');
            
            // Show therapy info
            document.getElementById('protocolName').textContent = selectedProtocol.name;
            document.getElementById('protocolCode').textContent = protocolCode;
            document.getElementById('protocolDuration').textContent = selectedProtocol.duration;
            document.getElementById('protocolConditions').textContent = selectedProtocol.conditions;
            
            // Update probe locations
            document.getElementById('probeALocation').textContent = selectedProtocol.probes.A.location;
            document.getElementById('probeASettings').textContent = selectedProtocol.probes.A.settings;
            
            document.getElementById('probeBLocation').textContent = selectedProtocol.probes.B.location;
            document.getElementById('probeBSettings').textContent = selectedProtocol.probes.B.settings;
            
            document.getElementById('probeCLocation').textContent = selectedProtocol.probes.C.location;
            document.getElementById('probeCSettings').textContent = selectedProtocol.probes.C.settings;
            
            document.getElementById('probeDLocation').textContent = selectedProtocol.probes.D.location;
            document.getElementById('probeDSettings').textContent = selectedProtocol.probes.D.settings;
            
            // Show sections
            document.getElementById('therapyInfo').style.display = 'block';
            document.getElementById('noTherapySelected').style.display = 'none';
            document.getElementById('probeChecklist').style.display = 'block';
            
            // Reset checkboxes
            document.querySelectorAll('.probe-checkbox').forEach(cb => cb.checked = false);
            
            updateReadyStatus();
        }
        
        // Check All Probes
        function checkAllProbes() {
            const checkboxes = document.querySelectorAll('.probe-checkbox');
            allProbesChecked = Array.from(checkboxes).every(cb => cb.checked);
            updateReadyStatus();
        }
        
        // Update Ready Status
        function updateReadyStatus() {
            const readyStatus = document.getElementById('readyStatus');
            const confirmBtn = document.getElementById('confirmBtn');
            
            if (selectedPatient && selectedProtocol && allProbesChecked) {
                readyStatus.className = 'ready-status ready';
                readyStatus.innerHTML = `
                    <div class="status-icon">✅</div>
                    <div class="status-message">Ready for Treatment</div>
                    <div class="status-detail">All probes placed correctly. Press button below to confirm.</div>
                `;
                confirmBtn.disabled = false;
            } else {
                readyStatus.className = 'ready-status not-ready';
                let message = 'Setup Not Complete';
                let detail = '';
                
                if (!selectedPatient) {
                    detail = 'Please select a patient';
                } else if (!selectedProtocol) {
                    detail = 'Please select a therapy protocol';
                } else if (!allProbesChecked) {
                    detail = 'Please confirm all probe placements';
                }
                
                readyStatus.innerHTML = `
                    <div class="status-icon">⚠️</div>
                    <div class="status-message">${message}</div>
                    <div class="status-detail">${detail}</div>
                `;
                confirmBtn.disabled = true;
            }
        }
        
        // Confirm Setup
        async function confirmSetup() {
            if (!selectedPatient || !selectedProtocol || !allProbesChecked) {
                alert('Please complete all setup steps');
                return;
            }
            
            // Generate session ID
            const sessionId = 'SES-' + Date.now();
            document.getElementById('sessionId').textContent = sessionId;
            
            // Save session to database
            try {
                await supabase.from('treatment_sessions').insert({
                    session_id: sessionId,
                    patient_id: selectedPatient.patient_id,
                    protocol_id: selectedProtocol.code,
                    protocol_name: selectedProtocol.name,
                    duration: selectedProtocol.duration,
                    start_time: new Date().toISOString(),
                    status: 'ready',
                    notes: document.getElementById('treatmentNotes').value,
                    probe_placement_confirmed: true,
                    practitioner: document.getElementById('practitionerName').textContent
                });
                
                // Update UI to show completion
                document.getElementById('readyStatus').className = 'ready-status ready';
                document.getElementById('readyStatus').innerHTML = `
                    <div class="status-icon">✅</div>
                    <div class="status-message">Setup Complete!</div>
                    <div class="status-detail">Please START treatment on the device</div>
                `;
                
                document.getElementById('confirmBtn').textContent = 'Setup Confirmed ✓';
                document.getElementById('confirmBtn').style.background = '#059669';
                
                alert('Setup complete! Please press START on the device to begin treatment.');
                
            } catch (error) {
                console.error('Error saving session:', error);
                alert('Error saving session. Please try again.');
            }
        }
        
        // Utility Functions
        function calculateAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }
        
        function updateDateTime() {
            const now = new Date();
            document.getElementById('sessionDate').textContent = now.toLocaleDateString();
            document.getElementById('sessionTime').textContent = now.toLocaleTimeString();
        }
        
        // View Toggle Function
        function toggleView(view) {
            if (view === 'front') {
                document.getElementById('frontView').style.display = 'block';
                document.getElementById('backView').style.display = 'none';
                document.getElementById('frontViewBtn').style.background = '#3b82f6';
                document.getElementById('frontViewBtn').style.color = 'white';
                document.getElementById('backViewBtn').style.background = '#e5e7eb';
                document.getElementById('backViewBtn').style.color = '#333';
            } else {
                document.getElementById('frontView').style.display = 'none';
                document.getElementById('backView').style.display = 'block';
                document.getElementById('backViewBtn').style.background = '#3b82f6';
                document.getElementById('backViewBtn').style.color = 'white';
                document.getElementById('frontViewBtn').style.background = '#e5e7eb';
                document.getElementById('frontViewBtn').style.color = '#333';
            }
        }
        
        // Update Visual Probe Markers
        function updateVisualProbeMarkers() {
            if (!selectedProtocol) return;
            
            // Define probe colors
            const probeColors = {
                A: '#ef4444', // Red
                B: '#3b82f6', // Blue
                C: '#10b981', // Green
                D: '#f59e0b'  // Yellow
            };
            
            // Example positions for common points (simplified)
            const pointPositions = {
                'front': {
                    'CV4': { x: 150, y: 220 },
                    'CV6': { x: 150, y: 200 },
                    'CV8': { x: 150, y: 180 },
                    'CV17': { x: 150, y: 120 },
                    'ST36': { x: 130, y: 250 },
                    'SP6': { x: 125, y: 280 },
                    'LI4': { x: 95, y: 155 },
                    'PC6': { x: 105, y: 140 },
                    'HT7': { x: 100, y: 150 }
                },
                'back': {
                    'BL23': { x: 130, y: 160 },
                    'DU4': { x: 150, y: 180 },
                    'DU14': { x: 150, y: 100 },
                    'DU20': { x: 150, y: 40 },
                    'GB20': { x: 135, y: 70 },
                    'BL15': { x: 130, y: 120 }
                }
            };
            
            // Clear existing markers
            document.getElementById('frontProbeMarkers').innerHTML = '';
            document.getElementById('backProbeMarkers').innerHTML = '';
            
            // Add markers for each probe
            ['A', 'B', 'C', 'D'].forEach(probe => {
                const location = selectedProtocol.probes[probe].location;
                
                // Try to find position (simplified - you can expand this)
                let position = null;
                let view = 'front';
                
                // Check if location contains back points
                if (location.includes('BL') || location.includes('DU') || location.includes('GB')) {
                    view = 'back';
                }
                
                // Get first mentioned point (simplified parsing)
                const points = Object.keys(view === 'front' ? pointPositions.front : pointPositions.back);
                for (let point of points) {
                    if (location.includes(point)) {
                        position = pointPositions[view][point];
                        break;
                    }
                }
                
                // If no specific position found, use default positions
                if (!position) {
                    const defaults = {
                        A: { front: { x: 150, y: 180 }, back: { x: 150, y: 160 } },
                        B: { front: { x: 130, y: 140 }, back: { x: 170, y: 140 } },
                        C: { front: { x: 170, y: 140 }, back: { x: 130, y: 180 } },
                        D: { front: { x: 120, y: 250 }, back: { x: 180, y: 250 } }
                    };
                    position = defaults[probe][view];
                }
                
                // Create marker
                const marker = `
                    <circle cx="${position.x}" cy="${position.y}" r="12" 
                            fill="${probeColors[probe]}" stroke="white" stroke-width="2"/>
                    <text x="${position.x}" y="${position.y + 5}" text-anchor="middle" 
                          fill="white" font-weight="bold" font-size="14">${probe}</text>
                `;
                
                if (view === 'front') {
                    document.getElementById('frontProbeMarkers').innerHTML += marker;
                } else {
                    document.getElementById('backProbeMarkers').innerHTML += marker;
                }
            });
        }
        
        // Action Functions
        function openProbeGuide() {
            const protocolParam = selectedProtocol ? '?therapy=' + selectedProtocol.code : '';
            window.open('therapy-reference.html' + protocolParam, 'ProbeGuide', 'width=1200,height=800');
        }
        
        function viewPatientHistory() {
            if (selectedPatient) {
                alert(`Opening treatment history for ${selectedPatient.first_name} ${selectedPatient.last_name}...`);
                // Implementation would open history modal
            } else {
                alert('Please select a patient first');
            }
        }
        
        function printSetupSheet() {
            if (selectedPatient && selectedProtocol) {
                window.print();
            } else {
                alert('Please select patient and protocol first');
            }
        }
    </script>
</body>
</html>
