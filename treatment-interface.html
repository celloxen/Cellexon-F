<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treatment Interface - CELLOXEN HEALTH PLATFORM</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        /* Header */
        .header {
            background: #1e3a8a;
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-secondary {
            background: white;
            color: #1e3a8a;
        }
        
        .btn-secondary:hover {
            background: #f0f0f0;
        }
        
        /* Container */
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 400px 1fr 400px;
            gap: 20px;
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .card h2 {
            color: #1e3a8a;
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        /* Patient Selection */
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            font-size: 14px;
            background: white;
        }
        
        .patient-info {
            margin-top: 15px;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 5px;
            border-left: 3px solid #3b82f6;
        }
        
        .patient-detail {
            margin: 5px 0;
        }
        
        .patient-detail strong {
            color: #1e3a8a;
        }
        
        /* Protocol Selection */
        .protocol-category {
            margin-bottom: 15px;
        }
        
        .protocol-category h3 {
            color: #374151;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .protocol-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .protocol-card:hover {
            background: #e0f2fe;
            border-color: #3b82f6;
        }
        
        .protocol-card.selected {
            background: #dbeafe;
            border-color: #2563eb;
            border-width: 2px;
        }
        
        /* Therapy Information */
        .therapy-info {
            background: #f0fdf4;
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .therapy-detail {
            margin: 8px 0;
            padding: 8px;
            background: white;
            border-radius: 5px;
        }
        
        /* Probe Checklist */
        .probe-checklist {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .probe-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 8px 0;
            background: white;
            border-radius: 5px;
            border: 1px solid #e5e7eb;
        }
        
        .probe-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 15px;
            cursor: pointer;
        }
        
        .probe-label {
            flex: 1;
        }
        
        .probe-position {
            font-weight: 600;
            color: #1e3a8a;
        }
        
        .probe-location {
            font-size: 13px;
            color: #6b7280;
            margin-top: 3px;
        }
        
        .probe-settings {
            font-size: 12px;
            color: #059669;
            margin-left: auto;
            padding: 3px 8px;
            background: #f0fdf4;
            border-radius: 3px;
        }
        
        /* Ready Status */
        .ready-status {
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .ready-status.not-ready {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        
        .ready-status.ready {
            background: #dcfce7;
            border: 1px solid #10b981;
            color: #14532d;
        }
        
        .status-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .status-message {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .status-detail {
            font-size: 14px;
        }
        
        /* Confirm Button */
        .btn-confirm {
            width: 100%;
            padding: 15px;
            background: #10b981;
            color: white;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-confirm:hover:not(:disabled) {
            background: #059669;
        }
        
        .btn-confirm:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        /* Session Info */
        .session-info {
            background: #f9fafb;
            padding: 15px;
            border-radius: 5px;
        }
        
        .session-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        /* Notes */
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
        }
        
        /* Instructions */
        .instructions {
            background: #eff6ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .instructions h3 {
            color: #1e3a8a;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .instructions ol {
            margin-left: 20px;
        }
        
        .instructions li {
            margin: 5px 0;
            color: #374151;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <h1>CELLOXEN HEALTH PLATFORM - Treatment Setup</h1>
            <div class="header-buttons">
                <button class="btn btn-secondary" onclick="window.location.href='clinic-dashboard.html'">
                    Back to Dashboard
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main Container -->
    <div class="container">
        <div class="main-grid">
            <!-- Left Column: Patient & Protocol Selection -->
            <div>
                <!-- Patient Selection -->
                <div class="card">
                    <h2>1. Select Patient</h2>
                    <select id="patientSelect">
                        <option value="">Choose a patient...</option>
                    </select>
                    <div id="patientInfo" class="patient-info" style="display: none;">
                        <div class="patient-detail">
                            <strong>Name:</strong> <span id="patientName">-</span>
                        </div>
                        <div class="patient-detail">
                            <strong>ID:</strong> <span id="patientId">-</span>
                        </div>
                        <div class="patient-detail">
                            <strong>Age:</strong> <span id="patientAge">-</span>
                        </div>
                        <div class="patient-detail">
                            <strong>Gender:</strong> <span id="patientGender">-</span>
                        </div>
                        <div class="patient-detail">
                            <strong>Last Visit:</strong> <span id="lastVisit">-</span>
                        </div>
                        <div class="patient-detail">
                            <strong>Health Score:</strong> <span id="healthScore">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Protocol Selection -->
                <div class="card">
                    <h2>2. Select Therapy Protocol</h2>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <div id="protocolsList"></div>
                    </div>
                </div>
            </div>
            
            <!-- Center Column: Visual Guide, Therapy Info & Probe Verification -->
            <div>
                <!-- Instructions -->
                <div class="instructions">
                    <h3>Treatment Setup Process</h3>
                    <ol>
                        <li>Select the patient from the list</li>
                        <li>Choose the appropriate therapy protocol</li>
                        <li>Review probe placement locations in the visual guide below</li>
                        <li>Place all 5 probes on the patient as indicated</li>
                        <li>Check each probe box to confirm placement</li>
                        <li>Once all probes are confirmed, press "Setup Complete"</li>
                        <li>Start the treatment on the device</li>
                    </ol>
                </div>
                
                <!-- Visual Probe Placement Guide - Always Visible -->
                <div class="card">
                    <h2>Visual Probe Placement Guide</h2>
                    <div id="visualGuide">
                        <!-- View Toggle Buttons -->
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <button class="btn btn-secondary" onclick="toggleView('front')" id="frontViewBtn" style="flex: 1; background: #3b82f6; color: white;">
                                Front View
                            </button>
                            <button class="btn btn-secondary" onclick="toggleView('back')" id="backViewBtn" style="flex: 1;">
                                Back View
                            </button>
                        </div>
                        
                        <!-- Body Diagram -->
                        <div style="position: relative; background: #f9fafb; border-radius: 8px; padding: 20px; margin-bottom: 20px; min-height: 450px;">
                            <div id="noProtocolMessage" style="text-align: center; padding: 150px 20px; color: #6b7280;">
                                <div style="font-size: 48px; margin-bottom: 20px;">üëÜ</div>
                                <p style="font-size: 16px;">Select a patient and therapy protocol above to see probe placement locations</p>
                            </div>
                            
                            <!-- Front View -->
                            <div id="frontView" style="text-align: center; display: none;">
                                <svg width="300" height="400" style="margin: 0 auto;">
                                    <!-- Simple body outline -->
                                    <ellipse cx="150" cy="50" rx="30" ry="35" fill="none" stroke="#333" stroke-width="2"/> <!-- Head -->
                                    <line x1="150" y1="85" x2="150" y2="200" stroke="#333" stroke-width="2"/> <!-- Body -->
                                    <line x1="150" y1="100" x2="100" y2="150" stroke="#333" stroke-width="2"/> <!-- Left arm -->
                                    <line x1="150" y1="100" x2="200" y2="150" stroke="#333" stroke-width="2"/> <!-- Right arm -->
                                    <line x1="150" y1="200" x2="120" y2="300" stroke="#333" stroke-width="2"/> <!-- Left leg -->
                                    <line x1="150" y1="200" x2="180" y2="300" stroke="#333" stroke-width="2"/> <!-- Right leg -->
                                    
                                    <!-- Probe positions will be added dynamically -->
                                    <g id="frontProbeMarkers"></g>
                                </svg>
                            </div>
                            
                            <!-- Back View -->
                            <div id="backView" style="display: none; text-align: center;">
                                <svg width="300" height="400" style="margin: 0 auto;">
                                    <!-- Simple body outline (back) -->
                                    <ellipse cx="150" cy="50" rx="30" ry="35" fill="none" stroke="#333" stroke-width="2"/> <!-- Head -->
                                    <line x1="150" y1="85" x2="150" y2="200" stroke="#333" stroke-width="2"/> <!-- Body -->
                                    <line x1="150" y1="100" x2="100" y2="150" stroke="#333" stroke-width="2"/> <!-- Left arm -->
                                    <line x1="150" y1="100" x2="200" y2="150" stroke="#333" stroke-width="2"/> <!-- Right arm -->
                                    <line x1="150" y1="200" x2="120" y2="300" stroke="#333" stroke-width="2"/> <!-- Left leg -->
                                    <line x1="150" y1="200" x2="180" y2="300" stroke="#333" stroke-width="2"/> <!-- Right leg -->
                                    
                                    <!-- Back specific markers -->
                                    <text x="150" y="120" text-anchor="middle" font-size="12" fill="#666">BACK VIEW</text>
                                    
                                    <!-- Probe positions will be added dynamically -->
                                    <g id="backProbeMarkers"></g>
                                </svg>
                            </div>
                        </div>
                        
                        <!-- Treatment Parameters -->
                        <div id="treatmentParams" style="margin-top: 20px; padding: 15px; background: #eff6ff; border-radius: 8px; display: none;">
                            <h4 style="color: #1e3a8a; margin-bottom: 10px;">Treatment Parameters</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div><strong>Duration:</strong> <span id="treatmentDuration">-</span></div>
                                <div><strong>Frequency:</strong> <span id="treatmentFrequency">-</span></div>
                                <div><strong>Course:</strong> <span id="treatmentCourse">-</span></div>
                                <div><strong>Sessions/Week:</strong> <span id="treatmentSessionsWeek">-</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Therapy Information -->
                <div class="card">
                    <h2>Therapy Information</h2>
                    <div id="therapyInfo" style="display: none;">
                        <div class="therapy-info">
                            <div class="therapy-detail">
                                <strong>Protocol:</strong> <span id="protocolName">-</span>
                            </div>
                            <div class="therapy-detail">
                                <strong>Code:</strong> <span id="protocolCode">-</span>
                            </div>
                            <div class="therapy-detail">
                                <strong>Duration:</strong> <span id="protocolDuration">-</span> minutes
                            </div>
                            <div class="therapy-detail">
                                <strong>Number of Probes:</strong> 5 probes (4 active + 1 ground)
                            </div>
                            <div class="therapy-detail">
                                <strong>Conditions Treated:</strong> <span id="protocolConditions">-</span>
                            </div>
                        </div>
                    </div>
                    <div id="noTherapySelected" style="text-align: center; padding: 20px; color: #6b7280;">
                        Please select a patient and therapy protocol
                    </div>
                </div>
                
                <!-- Probe Verification Checklist -->
                <div class="card">
                    <h2>3. Probe Placement Verification</h2>
                    <div id="probeChecklist" style="display: none;">
                        <div class="probe-checklist">
                            <p style="margin-bottom: 10px; font-weight: 600;">
                                Confirm all 5 probes are correctly placed according to the visual guide above:
                            </p>
                            
                            <!-- Probe A -->
                            <div class="probe-item" style="border-left: 4px solid #ef4444;">
                                <input type="checkbox" class="probe-checkbox" id="probeA" onchange="checkAllProbes()">
                                <div class="probe-label">
                                    <div class="probe-position">
                                        <span style="display: inline-block; width: 20px; height: 20px; background: #ef4444; border-radius: 50%; vertical-align: middle; margin-right: 5px;"></span>
                                        Probe A (Red Cable)
                                    </div>
                                    <div class="probe-location" id="probeALocation">-</div>
                                </div>
                                <div class="probe-settings" id="probeASettings">-</div>
                            </div>
                            
                            <!-- Probe B -->
                            <div class="probe-item" style="border-left: 4px solid #3b82f6;">
                                <input type="checkbox" class="probe-checkbox" id="probeB" onchange="checkAllProbes()">
                                <div class="probe-label">
                                    <div class="probe-position">
                                        <span style="display: inline-block; width: 20px; height: 20px; background: #3b82f6; border-radius: 50%; vertical-align: middle; margin-right: 5px;"></span>
                                        Probe B (Blue Cable)
                                    </div>
                                    <div class="probe-location" id="probeBLocation">-</div>
                                </div>
                                <div class="probe-settings" id="probeBSettings">-</div>
                            </div>
                            
                            <!-- Probe C -->
                            <div class="probe-item" style="border-left: 4px solid #10b981;">
                                <input type="checkbox" class="probe-checkbox" id="probeC" onchange="checkAllProbes()">
                                <div class="probe-label">
                                    <div class="probe-position">
                                        <span style="display: inline-block; width: 20px; height: 20px; background: #10b981; border-radius: 50%; vertical-align: middle; margin-right: 5px;"></span>
                                        Probe C (Green Cable)
                                    </div>
                                    <div class="probe-location" id="probeCLocation">-</div>
                                </div>
                                <div class="probe-settings" id="probeCSettings">-</div>
                            </div>
                            
                            <!-- Probe D -->
                            <div class="probe-item" style="border-left: 4px solid #f59e0b;">
                                <input type="checkbox" class="probe-checkbox" id="probeD" onchange="checkAllProbes()">
                                <div class="probe-label">
                                    <div class="probe-position">
                                        <span style="display: inline-block; width: 20px; height: 20px; background: #f59e0b; border-radius: 50%; vertical-align: middle; margin-right: 5px;"></span>
                                        Probe D (Yellow Cable)
                                    </div>
                                    <div class="probe-location" id="probeDLocation">-</div>
                                </div>
                                <div class="probe-settings" id="probeDSettings">-</div>
                            </div>
                            
                            <!-- Ground Probe -->
                            <div class="probe-item" style="border-left: 4px solid #000;">
                                <input type="checkbox" class="probe-checkbox" id="probeGround" onchange="checkAllProbes()">
                                <div class="probe-label">
                                    <div class="probe-position">
                                        <span style="display: inline-block; width: 20px; height: 20px; background: #000; border-radius: 50%; vertical-align: middle; margin-right: 5px;"></span>
                                        Ground Probe (Black Cable)
                                    </div>
                                    <div class="probe-location">Wrist or ankle (patient preference)</div>
                                </div>
                                <div class="probe-settings">Ground</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Ready Status -->
                <div id="readyStatus" class="ready-status not-ready">
                    <div class="status-icon">‚ö†Ô∏è</div>
                    <div class="status-message">Setup Not Complete</div>
                    <div class="status-detail">Please complete all steps above</div>
                </div>
                
                <!-- Confirm Button -->
                <button class="btn-confirm" id="confirmBtn" onclick="confirmSetup()" disabled>
                    Setup Complete - Ready for Treatment
                </button>
            </div>
            
            <!-- Right Column: Session Info & Notes -->
            <div>
                <!-- Session Information -->
                <div class="card">
                    <h2>Session Information</h2>
                    <div class="session-info">
                        <p><strong>Date:</strong> <span id="sessionDate"></span></p>
                        <p><strong>Time:</strong> <span id="sessionTime"></span></p>
                        <p><strong>Practitioner:</strong> <span id="practitionerName">Dr. Smith</span></p>
                        <p><strong>Clinic:</strong> London Wellness Centre</p>
                        <p><strong>Device ID:</strong> CEL-001</p>
                        <p><strong>Session ID:</strong> <span id="sessionId">-</span></p>
                    </div>
                </div>
                
                <!-- Treatment Notes -->
                <div class="card">
                    <h2>Treatment Notes</h2>
                    <textarea id="treatmentNotes" rows="6" 
                              placeholder="Enter any relevant notes about the treatment setup or patient condition..."></textarea>
                </div>
                
                <!-- Device Status -->
                <div class="card">
                    <h2>Device Status</h2>
                    <div id="deviceStatus" style="text-align: center; padding: 20px;">
                        <div id="deviceIcon" style="font-size: 48px; margin-bottom: 10px;">‚ùå</div>
                        <p id="deviceStatusText" style="font-weight: 600; color: #ef4444;">Not Ready</p>
                        <p id="deviceInstruction" style="color: #6b7280; margin-top: 10px;">
                            Complete patient and probe setup first
                        </p>
                    </div>
                </div>
                
                <!-- Session Tracking -->
                <div class="card">
                    <h2>Treatment Progress</h2>
                    <div id="sessionTracking" style="padding: 10px;">
                        <div style="margin-bottom: 10px; padding: 10px; background: #f9fafb; border-radius: 5px;">
                            <strong>Current Session:</strong> 
                            <span id="currentSessionNumber" style="color: #1e3a8a;">-</span>
                        </div>
                        <div style="margin-bottom: 10px; padding: 10px; background: #f9fafb; border-radius: 5px;">
                            <strong>Total Sessions Completed:</strong> 
                            <span id="completedSessions" style="color: #10b981;">-</span>
                        </div>
                        <div style="margin-bottom: 10px; padding: 10px; background: #f9fafb; border-radius: 5px;">
                            <strong>Recommended Course:</strong> 
                            <span id="recommendedSessions" style="color: #6b7280;">-</span>
                        </div>
                        <div style="padding: 10px; background: #fef3c7; border-radius: 5px;">
                            <strong>Sessions Remaining:</strong> 
                            <span id="remainingSessions" style="color: #f59e0b; font-weight: 600;">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="card">
                    <h2>Quick Actions</h2>
                    <button class="btn btn-secondary" onclick="viewPatientHistory()" 
                            style="width: 100%; margin-bottom: 10px;">
                        View Patient History
                    </button>
                    <button class="btn btn-secondary" onclick="printSetupSheet()" 
                            style="width: 100%;">
                        Print Setup Sheet
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Supabase Integration -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase Configuration
        const supabaseUrl = 'https://defifwzgazqlrigwumqn.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRlZmlmd3pnYXpxbHJpZ3d1bXFuIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NzI1MzQyNiwiZXhwIjoyMDcyODI5NDI2fQ.Z2rYuNduatwFsIfiA4aO-g__GNtQKAXBEyHBLG4r5W8';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // Therapy Protocols with Probe Placements
        const therapyProtocols = {
            '100': {
                name: 'Blood Sugar Balance',
                category: 'Metabolic',
                duration: 45,
                conditions: 'Diabetes support, insulin sensitivity, metabolic syndrome',
                probes: {
                    A: { location: 'DU4 + BL23 - lower back kidney region', settings: 'Low temp' },
                    B: { location: 'SP6 - inner ankle', settings: 'Low temp' },
                    C: { location: 'ST36 - below knee', settings: 'Low temp' },
                    D: { location: 'LI4 - hand web', settings: 'Low temp' }
                }
            },
            '101': {
                name: 'Deep Sleep Renewal',
                category: 'Sleep & Stress',
                duration: 30,
                conditions: 'Insomnia, restless sleep, sleep quality issues',
                probes: {
                    A: { location: 'DU4 + BL23 - kidney energy support', settings: 'Weak temp' },
                    B: { location: 'DU14 - upper back calming', settings: 'Weak temp' },
                    C: { location: 'GB20 + DU16 - neck relaxation', settings: 'Weak temp' },
                    D: { location: 'Temples (EX-HN5) - bilateral', settings: 'Very gentle' }
                }
            },
            '102': {
                name: 'Stress Relief',
                category: 'Sleep & Stress',
                duration: 40,
                conditions: 'Anxiety, tension, nervous exhaustion',
                probes: {
                    A: { location: 'HT7 - inner wrist', settings: 'Very gentle' },
                    B: { location: 'EX-HN3 - forehead', settings: 'Very gentle' },
                    C: { location: 'DU20 - crown', settings: 'Very gentle' },
                    D: { location: 'PC6 - inner forearm', settings: 'Very gentle' }
                }
            },
            '103': {
                name: 'Relaxation & Calm',
                category: 'Sleep & Stress',
                duration: 35,
                conditions: 'Daily stress, mental fatigue, emotional tension',
                probes: {
                    A: { location: 'Temple regions', settings: 'Low intensity' },
                    B: { location: 'Inner wrist (PC6)', settings: 'Low intensity' },
                    C: { location: 'Ankle (SP6)', settings: 'Low intensity' },
                    D: { location: 'Back of neck', settings: 'Low intensity' }
                }
            },
            '104': {
                name: 'Sleep Quality',
                category: 'Sleep & Stress',
                duration: 45,
                conditions: 'Poor sleep quality, frequent waking, unrefreshing sleep',
                probes: {
                    A: { location: 'Forehead center', settings: 'Very low' },
                    B: { location: 'Behind ears', settings: 'Very low' },
                    C: { location: 'Upper chest', settings: 'Very low' },
                    D: { location: 'Solar plexus', settings: 'Very low' }
                }
            },
            '201': {
                name: 'Kidney Detox',
                category: 'Kidney & Urinary',
                duration: 35,
                conditions: 'Fatigue, fluid retention, kidney function support',
                probes: {
                    A: { location: 'DU4 + BL23', settings: 'Low, 4-6' },
                    B: { location: 'BL23 - upper back', settings: 'Low, 3-5' },
                    C: { location: 'BL23 - liver reflex (left)', settings: 'Weak, 3-5' },
                    D: { location: 'KI3 + KI1 bilateral', settings: 'Weak, 2-5' }
                }
            },
            '202': {
                name: 'Kidney Support',
                category: 'Kidney & Urinary',
                duration: 40,
                conditions: 'Kidney weakness, lower back pain, energy depletion',
                probes: {
                    A: { location: 'DU4 - kidney energy center', settings: 'Low, 3-7' },
                    B: { location: 'BL23 - kidney back-shu', settings: 'Low, 3-7' },
                    C: { location: 'BL23 - reinforcement', settings: 'Low, 3-7' },
                    D: { location: 'ST36 (morning) or KI1/SP6 (afternoon)', settings: 'Low, 3-7' }
                }
            },
            '203': {
                name: 'Bladder Comfort',
                category: 'Kidney & Urinary',
                duration: 30,
                conditions: 'Bladder irritation, frequency, urgency',
                probes: {
                    A: { location: 'CV3 - lower abdomen', settings: 'Gentle' },
                    B: { location: 'BL28 - bladder shu', settings: 'Gentle' },
                    C: { location: 'SP6 - inner ankle', settings: 'Gentle' },
                    D: { location: 'BL32 - sacrum', settings: 'Gentle' }
                }
            },
            '204': {
                name: 'Urinary Balance',
                category: 'Kidney & Urinary',
                duration: 25,
                conditions: 'UTI prevention, urinary health maintenance',
                probes: {
                    A: { location: 'Lower abdomen (CV4)', settings: 'Mild' },
                    B: { location: 'Lower back (BL23)', settings: 'Mild' },
                    C: { location: 'Inner thigh (SP10)', settings: 'Mild' },
                    D: { location: 'Ankle (KI3)', settings: 'Mild' }
                }
            },
            '301': {
                name: 'Heart Health',
                category: 'Cardiovascular',
                duration: 40,
                conditions: 'Heart rhythm support, circulation, chest tightness',
                probes: {
                    A: { location: 'PC6 - inner forearm', settings: 'Moderate' },
                    B: { location: 'HT7 - wrist crease', settings: 'Moderate' },
                    C: { location: 'CV17 - chest center', settings: 'Gentle' },
                    D: { location: 'BL15 - heart shu', settings: 'Moderate' }
                }
            },
            '302': {
                name: 'Blood Pressure Balance',
                category: 'Cardiovascular',
                duration: 35,
                conditions: 'Hypertension support, stress-related BP issues',
                probes: {
                    A: { location: 'LI11 - elbow crease', settings: 'Moderate' },
                    B: { location: 'GB20 - base of skull', settings: 'Gentle' },
                    C: { location: 'ST36 - below knee', settings: 'Moderate' },
                    D: { location: 'LR3 - foot', settings: 'Gentle' }
                }
            },
            '303': {
                name: 'Circulation Boost',
                category: 'Cardiovascular',
                duration: 30,
                conditions: 'Poor circulation, cold extremities, varicose veins',
                probes: {
                    A: { location: 'SP6 - inner ankle', settings: 'Moderate' },
                    B: { location: 'ST36 - leg', settings: 'Moderate' },
                    C: { location: 'LI4 - hand', settings: 'Moderate' },
                    D: { location: 'BL40 - behind knee', settings: 'Gentle' }
                }
            },
            '304': {
                name: 'Cardiovascular Vitality',
                category: 'Cardiovascular',
                duration: 45,
                conditions: 'Overall heart health, endurance, energy',
                probes: {
                    A: { location: 'Heart area (CV17)', settings: 'Low-moderate' },
                    B: { location: 'Upper back (BL15)', settings: 'Low-moderate' },
                    C: { location: 'Wrist (PC6)', settings: 'Low-moderate' },
                    D: { location: 'Ankle (SP6)', settings: 'Low-moderate' }
                }
            },
            '401': {
                name: 'Joint Wellness',
                category: 'Joint & Mobility',
                duration: 30,
                conditions: 'Joint stiffness, morning stiffness, flexibility',
                probes: {
                    A: { location: 'Affected joint - anterior', settings: 'Moderate' },
                    B: { location: 'Affected joint - posterior', settings: 'Moderate' },
                    C: { location: 'GB34 - knee side', settings: 'Moderate' },
                    D: { location: 'SP5 - ankle', settings: 'Gentle' }
                }
            },
            '402': {
                name: 'Arthritis Relief',
                category: 'Joint & Mobility',
                duration: 35,
                conditions: 'Arthritis pain, inflammation, joint degeneration',
                probes: {
                    A: { location: 'Primary affected joint', settings: 'High' },
                    B: { location: 'Secondary affected area', settings: 'High' },
                    C: { location: 'ST36 - systemic support', settings: 'Moderate' },
                    D: { location: 'LI4 - pain relief', settings: 'Moderate' }
                }
            },
            '403': {
                name: 'Mobility Enhancement',
                category: 'Joint & Mobility',
                duration: 30,
                conditions: 'Reduced mobility, muscle tension, recovery',
                probes: {
                    A: { location: 'Hip area (GB30)', settings: 'Moderate' },
                    B: { location: 'Lower back (BL23)', settings: 'Moderate' },
                    C: { location: 'Knee (ST35)', settings: 'Moderate' },
                    D: { location: 'Ankle (BL60)', settings: 'Gentle' }
                }
            },
            '501': {
                name: 'Pain Management',
                category: 'Healing Support',
                duration: 30,
                conditions: 'Chronic pain, acute pain, pain relief',
                probes: {
                    A: { location: 'Primary pain site', settings: 'High' },
                    B: { location: 'Opposite side balance', settings: 'Moderate' },
                    C: { location: 'LI4 - general pain', settings: 'High' },
                    D: { location: 'ST36 - support', settings: 'Moderate' }
                }
            },
            '502': {
                name: 'Inflammation Control',
                category: 'Healing Support',
                duration: 40,
                conditions: 'Inflammatory conditions, swelling, heat',
                probes: {
                    A: { location: 'Inflamed area - center', settings: 'Moderate' },
                    B: { location: 'Inflamed area - periphery', settings: 'Gentle' },
                    C: { location: 'SP6 - cooling', settings: 'Moderate' },
                    D: { location: 'LI11 - heat clearing', settings: 'Moderate' }
                }
            },
            '601': {
                name: 'Immune Boost',
                category: 'Wellness & Energy',
                duration: 35,
                conditions: 'Weak immunity, frequent illness, recovery',
                probes: {
                    A: { location: 'ST36 - immune point', settings: 'Moderate' },
                    B: { location: 'CV6 - energy center', settings: 'Moderate' },
                    C: { location: 'BL23 - kidney support', settings: 'Gentle' },
                    D: { location: 'LI4 - defensive qi', settings: 'Moderate' }
                }
            },
            '602': {
                name: 'Energy Enhancement',
                category: 'Wellness & Energy',
                duration: 30,
                conditions: 'Fatigue, low energy, exhaustion',
                probes: {
                    A: { location: 'CV4 - vital energy', settings: 'Moderate' },
                    B: { location: 'ST36 - stamina', settings: 'Moderate' },
                    C: { location: 'GV20 - lifting energy', settings: 'Gentle' },
                    D: { location: 'PC6 - circulation', settings: 'Moderate' }
                }
            },
            '703': {
                name: 'Cellular Regeneration',
                category: 'Wellness & Energy',
                duration: 45,
                conditions: 'Anti-aging, tissue repair, cellular health',
                probes: {
                    A: { location: 'CV8 - navel center', settings: 'Low' },
                    B: { location: 'GV4 - life gate', settings: 'Low' },
                    C: { location: 'ST36 - longevity', settings: 'Low' },
                    D: { location: 'SP6 - three yin', settings: 'Low' }
                }
            },
            '801': {
                name: 'Full Body Wellness',
                category: 'Comprehensive',
                duration: 60,
                conditions: 'Overall health optimization, preventive care',
                probes: {
                    A: { location: 'GV20 - crown', settings: 'Balanced' },
                    B: { location: 'CV4 - lower dantian', settings: 'Balanced' },
                    C: { location: 'PC6 - inner gate', settings: 'Balanced' },
                    D: { location: 'ST36 - leg three li', settings: 'Balanced' }
                }
            },
            '802': {
                name: 'Complete Vitality',
                category: 'Comprehensive',
                duration: 60,
                conditions: 'Energy restoration, full system balance',
                probes: {
                    A: { location: 'Multiple points - rotating', settings: 'Variable' },
                    B: { location: 'Based on assessment', settings: 'Variable' },
                    C: { location: 'Customized placement', settings: 'Variable' },
                    D: { location: 'Practitioner discretion', settings: 'Variable' }
                }
            }
        };
        
        // Global Variables
        let selectedPatient = null;
        let selectedProtocol = null;
        let allProbesChecked = false;
        
        // Define toggleView function globally
        function toggleView(view) {
            if (view === 'front') {
                document.getElementById('frontView').style.display = 'block';
                document.getElementById('backView').style.display = 'none';
                document.getElementById('frontViewBtn').style.background = '#3b82f6';
                document.getElementById('frontViewBtn').style.color = 'white';
                document.getElementById('backViewBtn').style.background = '#e5e7eb';
                document.getElementById('backViewBtn').style.color = '#333';
            } else {
                document.getElementById('frontView').style.display = 'none';
                document.getElementById('backView').style.display = 'block';
                document.getElementById('backViewBtn').style.background = '#3b82f6';
                document.getElementById('backViewBtn').style.color = 'white';
                document.getElementById('frontViewBtn').style.background = '#e5e7eb';
                document.getElementById('frontViewBtn').style.color = '#333';
            }
        }
        
        // Make other functions globally accessible
        window.toggleView = toggleView;
        window.checkAllProbes = checkAllProbes;
        window.confirmSetup = confirmSetup;
        window.viewPatientHistory = viewPatientHistory;
        window.printSetupSheet = printSetupSheet;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadPatients();
            loadProtocols();
            updateDateTime();
            setInterval(updateDateTime, 60000);
        });
        
        // Load Patients
        async function loadPatients() {
            try {
                const { data, error } = await supabase
                    .from('patients')
                    .select('*')
                    .order('first_name');
                
                if (error) throw error;
                
                const patientSelect = document.getElementById('patientSelect');
                data.forEach(patient => {
                    const option = document.createElement('option');
                    option.value = patient.patient_id;
                    option.textContent = `${patient.first_name} ${patient.last_name} (${patient.patient_id})`;
                    patientSelect.appendChild(option);
                });
                
                patientSelect.addEventListener('change', async function() {
                    if (this.value) {
                        const patient = data.find(p => p.patient_id === this.value);
                        await selectPatient(patient);
                    } else {
                        selectedPatient = null;
                        document.getElementById('patientInfo').style.display = 'none';
                        updateReadyStatus();
                        updateDeviceStatus();
                    }
                });
                
            } catch (error) {
                console.error('Error loading patients:', error);
            }
        }
        
        // Select Patient
        async function selectPatient(patient) {
            selectedPatient = patient;
            
            // Update patient info display
            document.getElementById('patientName').textContent = `${patient.first_name} ${patient.last_name}`;
            document.getElementById('patientId').textContent = patient.patient_id;
            document.getElementById('patientAge').textContent = calculateAge(patient.date_of_birth);
            document.getElementById('patientGender').textContent = patient.gender;
            
            // Load treatment history and session tracking
            try {
                // Get all sessions for this patient
                const { data: sessions, error: sessionsError } = await supabase
                    .from('treatment_sessions')
                    .select('*')
                    .eq('patient_id', patient.patient_id)
                    .order('start_time', { ascending: false });
                
                if (sessionsError) throw sessionsError;
                
                // Calculate session numbers
                const completedSessionsCount = sessions ? sessions.filter(s => s.status === 'completed').length : 0;
                const currentSessionNumber = completedSessionsCount + 1;
                
                // Update session tracking display
                document.getElementById('currentSessionNumber').textContent = `Session #${currentSessionNumber}`;
                document.getElementById('completedSessions').textContent = completedSessionsCount;
                
                // Get recommended sessions from last health assessment
                const { data: assessment } = await supabase
                    .from('health_assessments')
                    .select('recommended_sessions, therapies_recommended, total_score')
                    .eq('patient_id', patient.patient_id)
                    .order('assessment_date', { ascending: false })
                    .limit(1)
                    .single();
                
                let recommendedTotal = 10; // Default recommendation
                if (assessment && assessment.recommended_sessions) {
                    recommendedTotal = assessment.recommended_sessions;
                }
                
                document.getElementById('recommendedSessions').textContent = `${recommendedTotal} sessions`;
                
                // Calculate remaining sessions
                const remaining = Math.max(0, recommendedTotal - completedSessionsCount);
                document.getElementById('remainingSessions').textContent = remaining;
                
                // Add color coding for session status
                if (currentSessionNumber === 1) {
                    document.getElementById('currentSessionNumber').innerHTML = 
                        `<span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 3px;">First Session</span>`;
                } else if (remaining === 1) {
                    document.getElementById('currentSessionNumber').innerHTML = 
                        `<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 3px;">Final Session</span>`;
                } else if (remaining === 0) {
                    document.getElementById('currentSessionNumber').innerHTML = 
                        `<span style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 3px;">Course Complete</span>`;
                }
                
                // Update last visit
                if (sessions && sessions.length > 0) {
                    const lastVisit = new Date(sessions[0].start_time);
                    document.getElementById('lastVisit').textContent = lastVisit.toLocaleDateString();
                } else {
                    document.getElementById('lastVisit').textContent = 'First visit';
                }
                
                // Update health score
                if (assessment) {
                    document.getElementById('healthScore').textContent = `${assessment.total_score || '-'}/100`;
                } else {
                    document.getElementById('healthScore').textContent = 'No assessment';
                }
                
            } catch (error) {
                console.error('Error loading patient history:', error);
                // Set defaults if error
                document.getElementById('currentSessionNumber').textContent = 'Session #1';
                document.getElementById('completedSessions').textContent = '0';
                document.getElementById('recommendedSessions').textContent = '10 sessions';
                document.getElementById('remainingSessions').textContent = '10';
            }
            
            document.getElementById('patientInfo').style.display = 'block';
            updateReadyStatus();
            updateDeviceStatus();
        }
        
        // Load Protocols
        async function loadProtocols() {
            const protocolsList = document.getElementById('protocolsList');
            
            try {
                // First try to load from database
                const { data: dbProtocols, error } = await supabase
                    .from('therapy_configurations')
                    .select('*')
                    .order('therapy_code');
                
                if (error) throw error;
                
                // If database has protocols, use them
                if (dbProtocols && dbProtocols.length > 0) {
                    const categories = {};
                    
                    // Group protocols by category
                    dbProtocols.forEach(protocol => {
                        const category = protocol.category || 'Uncategorized';
                        if (!categories[category]) {
                            categories[category] = [];
                        }
                        categories[category].push(protocol);
                    });
                    
                    // Create UI for each category
                    Object.entries(categories).forEach(([category, protocols]) => {
                        const categoryDiv = document.createElement('div');
                        categoryDiv.className = 'protocol-category';
                        
                        const categoryTitle = document.createElement('h3');
                        categoryTitle.textContent = category;
                        categoryDiv.appendChild(categoryTitle);
                        
                        protocols.forEach(protocol => {
                            const protocolCard = document.createElement('div');
                            protocolCard.className = 'protocol-card';
                            protocolCard.innerHTML = `
                                <strong>${protocol.therapy_code}: ${protocol.therapy_name}</strong><br>
                                <small>${protocol.duration || 30} minutes</small>
                            `;
                            protocolCard.onclick = function() { selectProtocolFromDB(protocol); };
                            categoryDiv.appendChild(protocolCard);
                        });
                        
                        protocolsList.appendChild(categoryDiv);
                    });
                } else {
                    // Fall back to hardcoded protocols if database is empty
                    console.log('No protocols in database, using defaults');
                    loadDefaultProtocols();
                }
                
            } catch (error) {
                console.error('Error loading protocols from database:', error);
                // Fall back to hardcoded protocols
                loadDefaultProtocols();
            }
        }
        
        // Load default hardcoded protocols (fallback)
        function loadDefaultProtocols() {
            const protocolsList = document.getElementById('protocolsList');
            const categories = {};
            
            // Group protocols by category
            Object.entries(therapyProtocols).forEach(([code, protocol]) => {
                if (!categories[protocol.category]) {
                    categories[protocol.category] = [];
                }
                categories[protocol.category].push({ code, ...protocol });
            });
            
            // Create UI for each category
            Object.entries(categories).forEach(([category, protocols]) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'protocol-category';
                
                const categoryTitle = document.createElement('h3');
                categoryTitle.textContent = category;
                categoryDiv.appendChild(categoryTitle);
                
                protocols.forEach(protocol => {
                    const protocolCard = document.createElement('div');
                    protocolCard.className = 'protocol-card';
                    protocolCard.innerHTML = `
                        <strong>${protocol.code}: ${protocol.name}</strong><br>
                        <small>${protocol.duration} minutes</small>
                    `;
                    protocolCard.onclick = function() { selectProtocol(protocol.code); };
                    categoryDiv.appendChild(protocolCard);
                });
                
                protocolsList.appendChild(categoryDiv);
            });
        }
        
        // Select Protocol from Database
        function selectProtocolFromDB(protocol) {
            selectedProtocol = {
                code: protocol.therapy_code,
                name: protocol.therapy_name,
                category: protocol.category,
                duration: protocol.duration || 30,
                conditions: protocol.conditions_treated || 'Various conditions',
                probes: {
                    A: { 
                        location: protocol.probe_a_location || 'See guide', 
                        settings: protocol.probe_a_settings || 'Standard' 
                    },
                    B: { 
                        location: protocol.probe_b_location || 'See guide', 
                        settings: protocol.probe_b_settings || 'Standard' 
                    },
                    C: { 
                        location: protocol.probe_c_location || 'See guide', 
                        settings: protocol.probe_c_settings || 'Standard' 
                    },
                    D: { 
                        location: protocol.probe_d_location || 'See guide', 
                        settings: protocol.probe_d_settings || 'Standard' 
                    }
                }
            };
            
            // Update UI
            document.querySelectorAll('.protocol-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.protocol-card').classList.add('selected');
            
            updateProtocolDisplay();
        }
        
        // Select Protocol (fallback for hardcoded)
        function selectProtocol(protocolCode) {
            selectedProtocol = therapyProtocols[protocolCode];
            selectedProtocol.code = protocolCode;
            
            // Update UI
            document.querySelectorAll('.protocol-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.protocol-card').classList.add('selected');
            
            updateProtocolDisplay();
        }
        
        // Update Protocol Display
        function updateProtocolDisplay() {
            // Show therapy info
            document.getElementById('protocolName').textContent = selectedProtocol.name;
            document.getElementById('protocolCode').textContent = selectedProtocol.code;
            document.getElementById('protocolDuration').textContent = selectedProtocol.duration;
            document.getElementById('protocolConditions').textContent = selectedProtocol.conditions;
            
            // Update probe locations
            document.getElementById('probeALocation').textContent = selectedProtocol.probes.A.location;
            document.getElementById('probeASettings').textContent = selectedProtocol.probes.A.settings;
            
            document.getElementById('probeBLocation').textContent = selectedProtocol.probes.B.location;
            document.getElementById('probeBSettings').textContent = selectedProtocol.probes.B.settings;
            
            document.getElementById('probeCLocation').textContent = selectedProtocol.probes.C.location;
            document.getElementById('probeCSettings').textContent = selectedProtocol.probes.C.settings;
            
            document.getElementById('probeDLocation').textContent = selectedProtocol.probes.D.location;
            document.getElementById('probeDSettings').textContent = selectedProtocol.probes.D.settings;
            
            // Update treatment parameters
            document.getElementById('treatmentDuration').textContent = `${selectedProtocol.duration} minutes`;
            document.getElementById('treatmentFrequency').textContent = `2-3 times per week`;
            document.getElementById('treatmentCourse').textContent = `8-10 weeks`;
            document.getElementById('treatmentSessionsWeek').textContent = `2-3 sessions`;
            
            // Update visual probe markers
            updateVisualProbeMarkers();
            
            // Show/hide appropriate sections
            document.getElementById('therapyInfo').style.display = 'block';
            document.getElementById('noTherapySelected').style.display = 'none';
            document.getElementById('probeChecklist').style.display = 'block';
            document.getElementById('noProtocolMessage').style.display = 'none';
            document.getElementById('frontView').style.display = 'block';
            document.getElementById('treatmentParams').style.display = 'block';
            
            // Reset checkboxes
            document.querySelectorAll('.probe-checkbox').forEach(cb => cb.checked = false);
            
            updateReadyStatus();
            updateDeviceStatus();
        }
        
        // Check All Probes
        function checkAllProbes() {
            const checkboxes = document.querySelectorAll('.probe-checkbox');
            allProbesChecked = Array.from(checkboxes).every(cb => cb.checked);
            updateReadyStatus();
            updateDeviceStatus();
        }
        
        // Update Device Status
        function updateDeviceStatus() {
            const deviceIcon = document.getElementById('deviceIcon');
            const deviceStatusText = document.getElementById('deviceStatusText');
            const deviceInstruction = document.getElementById('deviceInstruction');
            
            if (selectedPatient && selectedProtocol && allProbesChecked) {
                // All ready - device connected and ready
                deviceIcon.innerHTML = '‚úÖ';
                deviceStatusText.textContent = 'Ready to Start';
                deviceStatusText.style.color = '#10b981';
                deviceInstruction.innerHTML = '<strong>Press START on the device to begin treatment</strong>';
                deviceInstruction.style.color = '#059669';
            } else if (selectedPatient && selectedProtocol) {
                // Patient and protocol selected but probes not confirmed
                deviceIcon.innerHTML = '‚ö†Ô∏è';
                deviceStatusText.textContent = 'Waiting for Probe Confirmation';
                deviceStatusText.style.color = '#f59e0b';
                deviceInstruction.textContent = 'Please confirm all probe placements';
                deviceInstruction.style.color = '#6b7280';
            } else {
                // Not ready
                deviceIcon.innerHTML = '‚ùå';
                deviceStatusText.textContent = 'Not Ready';
                deviceStatusText.style.color = '#ef4444';
                deviceInstruction.textContent = 'Complete patient and probe setup first';
                deviceInstruction.style.color = '#6b7280';
            }
        }
        
        // Update Ready Status
        function updateReadyStatus() {
            const readyStatus = document.getElementById('readyStatus');
            const confirmBtn = document.getElementById('confirmBtn');
            
            if (selectedPatient && selectedProtocol && allProbesChecked) {
                readyStatus.className = 'ready-status ready';
                readyStatus.innerHTML = `
                    <div class="status-icon">‚úÖ</div>
                    <div class="status-message">Ready for Treatment</div>
                    <div class="status-detail">All probes placed correctly. Press button below to confirm.</div>
                `;
                confirmBtn.disabled = false;
            } else {
                readyStatus.className = 'ready-status not-ready';
                let message = 'Setup Not Complete';
                let detail = '';
                
                if (!selectedPatient) {
                    detail = 'Please select a patient';
                } else if (!selectedProtocol) {
                    detail = 'Please select a therapy protocol';
                } else if (!allProbesChecked) {
                    detail = 'Please confirm all probe placements';
                }
                
                readyStatus.innerHTML = `
                    <div class="status-icon">‚ö†Ô∏è</div>
                    <div class="status-message">${message}</div>
                    <div class="status-detail">${detail}</div>
                `;
                confirmBtn.disabled = true;
            }
        }
        
        // Confirm Setup
        async function confirmSetup() {
            if (!selectedPatient || !selectedProtocol || !allProbesChecked) {
                alert('Please complete all setup steps');
                return;
            }
            
            // Generate session ID
            const sessionId = 'SES-' + Date.now();
            document.getElementById('sessionId').textContent = sessionId;
            
            // Save session to database
            try {
                await supabase.from('treatment_sessions').insert({
                    session_id: sessionId,
                    patient_id: selectedPatient.patient_id,
                    protocol_id: selectedProtocol.code,
                    protocol_name: selectedProtocol.name,
                    duration: selectedProtocol.duration,
                    start_time: new Date().toISOString(),
                    status: 'ready',
                    notes: document.getElementById('treatmentNotes').value,
                    probe_placement_confirmed: true,
                    practitioner: document.getElementById('practitionerName').textContent
                });
                
                // Update UI to show completion
