<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive IRIS Report - Celloxen Platform</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background-color: #f4f7f9;
            color: #334155;
            line-height: 1.6;
        }
        .container {
            max-width: 8.5in;
            min-height: 11in;
            margin: 40px auto;
            padding: 50px;
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding-bottom: 20px;
            border-bottom: 4px solid #1e3a8a;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #1e3a8a;
            font-size: 28px;
            font-weight: 700;
        }
        .header-info p {
            text-align: right;
            font-size: 14px;
            color: #475569;
        }
        .section {
            margin-bottom: 30px;
        }
        .section h2 {
            font-size: 20px;
            font-weight: 600;
            color: #1e3a8a;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 20px;
        }
        .grid-2, .grid-3 {
            display: grid;
            gap: 20px;
        }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .info-card {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #60a5fa;
        }
        .info-card strong {
            display: block;
            color: #475569;
            font-size: 13px;
            margin-bottom: 4px;
        }
        .info-card span {
            font-size: 16px;
            font-weight: 500;
        }
        .findings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .finding-item {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .finding-item h4 {
            font-size: 14px;
            font-weight: 600;
            color: #0c4a6e;
            margin-bottom: 5px;
        }
        .finding-item p {
            font-size: 16px;
            font-weight: 500;
            color: #0284c7;
            text-transform: capitalize;
        }
        .system-analysis {
            column-count: 2;
            column-gap: 30px;
        }
        .system-item {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            break-inside: avoid;
        }
        .system-item h4 { font-size: 15px; color: #1e3a8a; }
        .system-item p { font-size: 14px; margin-top: 5px; }
        .recommendations ul {
            list-style-type: none;
            padding-left: 0;
        }
        .recommendations li {
            background: #f0fdf4;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #22c55e;
            font-size: 14px;
        }
        .disclaimer {
            font-size: 12px;
            color: #64748b;
            text-align: center;
            margin-top: 40px;
            border-top: 1px solid #e2e8f0;
            padding-top: 20px;
        }
        .no-print {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        .action-btn {
            background: #1e3a8a;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
        }
        .action-btn:hover { background: #1e40af; }
        
        .continue-section {
            margin-top: 30px;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: 10px;
        }
        
        .continue-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 14px 35px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .continue-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        @media print {
            body { background: none; }
            .container { margin: 0; padding: 0; box-shadow: none; border-radius: 0; }
            .no-print { display: none; }
            .continue-section { display: none; }
        }
    </style>
</head>
<body>

    <div class="no-print">
        <button class="action-btn" onclick="window.print()">üñ®Ô∏è Print Report</button>
        <button class="action-btn" onclick="sendEmail()">üìß Email Report</button>
    </div>

    <div class="container" id="report-content">
        <div class="header">
            <div>
                <h1>IRIS Comprehensive Report</h1>
                <p>AI-Powered Constitutional Analysis</p>
            </div>
            <div class="header-info">
                <p><strong>Patient ID:</strong> <span id="patientId"></span></p>
                <p><strong>Assessment ID:</strong> <span id="assessmentId"></span></p>
                <p><strong>Date:</strong> <span id="reportDate"></span></p>
            </div>
        </div>

        <div class="section">
            <h2>Patient Demographics</h2>
            <div class="grid-3">
                <div class="info-card"><strong>Full Name</strong> <span id="patientName"></span></div>
                <div class="info-card"><strong>Date of Birth</strong> <span id="patientDob"></span></div>
                <div class="info-card"><strong>Age</strong> <span id="patientAge"></span></div>
            </div>
        </div>

        <div class="section">
            <h2>AI Constitutional Findings</h2>
            <div class="findings-grid" id="constitutionalFindings">
                </div>
        </div>
        
        <div class="section">
            <h2>AI System Analysis</h2>
            <p id="systemAnalysisNotes" style="font-size: 14px; margin-bottom: 20px;"></p>
            <div class="system-analysis" id="systemAnalysis">
                </div>
        </div>

        <div class="section recommendations">
            <h2>AI-Generated Recommendations</h2>
            <div id="recommendations">
                </div>
        </div>

        <div class="disclaimer">
            This report is generated based on iridology principles for constitutional analysis and is intended for educational and informational purposes only. It is not a medical diagnosis and should not be used as a substitute for professional medical advice, diagnosis, or treatment.
        </div>
        
        <!-- Continue to IRIS Assessment Button -->
        <div class="continue-section no-print">
            <h3 style="color: #1e3a8a; margin-bottom: 15px;">Continue Patient Assessment Workflow</h3>
            <p style="color: #64748b; margin-bottom: 20px;">Start a new IRIS assessment for this patient or return to dashboard</p>
            <button class="continue-btn" onclick="continueToIrisAssessment()">
                Start New IRIS Assessment ‚Üí
            </button>
            <button class="action-btn" onclick="window.location.href='clinic-dashboard.html'" style="margin-left: 10px;">
                Return to Dashboard
            </button>
        </div>
    </div>

    <script>
    // --- START OF SCRIPT ---
    (function() {
        // --- 1. SUPABASE CONFIGURATION (STANDALONE) ---
        const SUPABASE_URL = 'https://defifwzgazqlrigwumqn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRlZmlmd3pnYXpxbHJpZ3d1bXFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyNTM0MjYsImV4cCI6MjA3MjgyOTQyNn0.wcUBq6Pszjtqn5aBtuu3iXBE4BLmu8x9LtJbsMWlIiA';
        
        if (!window.supabase) {
            document.body.innerHTML = '<h1>Error: Supabase client not loaded. Please check your internet connection.</h1>';
            return;
        }
        const { createClient } = window.supabase;
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('Report Generator: Supabase client initialized.');

        // --- 2. HELPER FUNCTIONS ---
        const calculateAge = (dob) => {
            if (!dob) return 'N/A';
            const ageDifMs = Date.now() - new Date(dob).getTime();
            const ageDate = new Date(ageDifMs);
            return Math.abs(ageDate.getUTCFullYear() - 1970);
        };

        const formatDate = (dateString) => new Date(dateString).toLocaleDateString('en-GB');

        // --- 3. DATA RENDERING FUNCTIONS ---
        const renderPatientData = (patient) => {
            document.getElementById('patientId').textContent = patient.patient_id || 'N/A';
            document.getElementById('patientName').textContent = `${patient.first_name} ${patient.last_name}`;
            document.getElementById('patientDob').textContent = formatDate(patient.date_of_birth);
            document.getElementById('patientAge').textContent = calculateAge(patient.date_of_birth);
        };

        const renderAssessmentData = (assessment) => {
            const analysis = assessment.claude_analysis;
            if (!analysis || !analysis.basic_findings) {
                document.getElementById('report-content').innerHTML += '<h2>Error: AI analysis data is missing or corrupt.</h2>';
                return;
            }

            const findings = analysis.basic_findings;
            const findingsContainer = document.getElementById('constitutionalFindings');
            findingsContainer.innerHTML = `
                <div class="finding-item"><h4>Constitutional Type</h4><p>${findings.constitutional_type || 'N/A'}</p></div>
                <div class="finding-item"><h4>Fibre Density</h4><p>${findings.fiber_density || 'N/A'}</p></div>
                <div class="finding-item"><h4>Pupil Size</h4><p>${findings.pupil_size || 'N/A'}</p></div>
                <div class="finding-item"><h4>Collarette</h4><p>${findings.collarette_position || 'N/A'}</p></div>
                <div class="finding-item"><h4>Lacunae</h4><p>${findings.lacunae || 'N/A'}</p></div>
                <div class="finding-item"><h4>Stress Rings</h4><p>${findings.stress_rings || 'N/A'}</p></div>
            `;
            
            document.getElementById('systemAnalysisNotes').textContent = findings.clinical_notes || 'No specific clinical notes were generated.';

            const recommendations = analysis.recommendations;
            if (recommendations) {
                const recContainer = document.getElementById('recommendations');
                recContainer.innerHTML = `
                    <h4>Nutritional</h4>
                    <ul>${(recommendations.nutritional?.foods_to_support || []).map(item => `<li>${item}</li>`).join('')}</ul>
                    <h4>Supplements</h4>
                    <ul>${(recommendations.supplements?.targeted || []).map(item => `<li>${item}</li>`).join('')}</ul>
                    <h4>Lifestyle</h4>
                    <ul>${(recommendations.lifestyle?.stress_management || []).map(item => `<li>${item}</li>`).join('')}</ul>
                `;
            }
        };

        // --- 4. MAIN DATA FETCHING FUNCTION ---
        async function generateComprehensiveReport(patientId, assessmentId) {
            console.log(`Starting report generation for patient ${patientId}, assessment ${assessmentId}`);
            try {
                // Store current patient ID for workflow continuity
                sessionStorage.setItem('currentPatientId', patientId);
                
                // Fetch patient and assessment data in parallel
                const [patientRes, assessmentRes] = await Promise.all([
                    supabase.from('patients').select('*').eq('id', patientId).single(),
                    supabase.from('iris_assessments').select('*').eq('id', assessmentId).single()
                ]);

                if (patientRes.error) throw new Error(`Failed to fetch patient data: ${patientRes.error.message}`);
                if (assessmentRes.error) throw new Error(`Failed to fetch assessment data: ${assessmentRes.error.message}`);

                const patient = patientRes.data;
                const assessment = assessmentRes.data;

                // Populate the report
                renderPatientData(patient);
                renderAssessmentData(assessment);

            } catch (error) {
                console.error('Error generating report:', error);
                document.getElementById('report-content').innerHTML = `
                    <div class="section">
                        <h2>Failed to Generate Report</h2>
                        <p style="color: red;">Could not load report data. Please check the console for details.</p>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>`;
            }
        }

        // --- 5. GLOBAL FUNCTIONS AND INITIALIZATION ---
        window.sendEmail = () => {
            const subject = `IRIS Report for Patient ID: ${document.getElementById('patientId').textContent}`;
            const body = "Please find the attached IRIS constitutional analysis report.";
            window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        };
        
        // Continue to IRIS Assessment function
        window.continueToIrisAssessment = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const patientId = urlParams.get('patientId');
            if (patientId) {
                // Pass patient ID to IRIS assessment to maintain workflow
                sessionStorage.setItem('currentPatientId', patientId);
                window.location.href = `iris-assessment-integrated.html?patientId=${patientId}`;
            } else {
                window.location.href = 'iris-assessment-integrated.html';
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const patientId = urlParams.get('patientId');
            const assessmentId = urlParams.get('assessmentId');

            document.getElementById('assessmentId').textContent = assessmentId || 'N/A';
            document.getElementById('reportDate').textContent = new Date().toLocaleDateString('en-GB');

            if (!patientId || !assessmentId) {
                alert('Patient ID or Assessment ID is missing from the URL.');
                return;
            }
            generateComprehensiveReport(patientId, assessmentId);
        });
    })();
    </script>
</body>
</html>
