<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Diagnosis Report - Celloxen Platform</title>
    
    <!-- CRITICAL: Add Supabase library BEFORE any modules -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #1f2937;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
        }
        
        .back-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .progress-bar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .progress-steps {
            display: flex;
            justify-content: space-between;
            position: relative;
        }
        
        .progress-step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }
        
        .progress-step::before {
            content: '';
            position: absolute;
            top: 20px;
            left: -50%;
            right: -50%;
            height: 2px;
            background: #e2e8f0;
            z-index: -1;
        }
        
        .progress-step:first-child::before {
            display: none;
        }
        
        .progress-step.completed::before {
            background: #10b981;
        }
        
        .progress-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e2e8f0;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .progress-step.active .progress-circle {
            background: linear-gradient(135deg, #1e3a8a, #1e40af);
            color: white;
            transform: scale(1.1);
        }
        
        .progress-step.completed .progress-circle {
            background: #10b981;
            color: white;
        }
        
        .report-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .card-header {
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 20px;
            margin-bottom: 25px;
        }
        
        .card-title {
            font-size: 22px;
            font-weight: 600;
            color: #1e293b;
        }
        
        .patient-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .info-item {
            padding: 15px;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 12px;
        }
        
        .info-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .info-value {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-top: 5px;
        }
        
        .section-container {
            margin: 30px 0;
        }
        
        .section-header {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-icon {
            font-size: 24px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }
        
        .finding-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #1e3a8a;
            transition: all 0.3s ease;
        }
        
        .finding-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .finding-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .finding-title {
            font-weight: 600;
            color: #1e293b;
        }
        
        .severity-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .severity-mild {
            background: #d1fae5;
            color: #065f46;
        }
        
        .severity-moderate {
            background: #fef3c7;
            color: #92400e;
        }
        
        .severity-severe {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .finding-details {
            color: #475569;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #f1f5f9;
        }
        
        .btn {
            padding: 12px 28px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            flex: 1;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }
        
        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background: #d1d5db;
        }
        
        .btn-email {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }
        
        .btn-email:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #1e3a8a;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-success {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        
        .alert-warning {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }
        
        @media print {
            body {
                background: white;
            }
            
            .header, .action-buttons, .back-btn {
                display: none;
            }
            
            .report-card {
                box-shadow: none;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div>
                <h1>Comprehensive Diagnosis Report</h1>
                <p style="color: #cbd5e1; margin-top: 5px;">Complete health assessment and treatment recommendations</p>
            </div>
            <a href="clinic-dashboard.html" class="back-btn">‚Üê Back to Dashboard</a>
        </div>
    </div>
    
    <div class="container">
        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-steps">
                <div class="progress-step completed">
                    <div class="progress-circle">‚úì</div>
                    <div>Health Assessment</div>
                </div>
                <div class="progress-step completed">
                    <div class="progress-circle">‚úì</div>
                    <div>IRIS Analysis</div>
                </div>
                <div class="progress-step active">
                    <div class="progress-circle">3</div>
                    <div>Diagnosis Report</div>
                </div>
                <div class="progress-step">
                    <div class="progress-circle">4</div>
                    <div>Therapy Selection</div>
                </div>
                <div class="progress-step">
                    <div class="progress-circle">5</div>
                    <div>Treatment Plan</div>
                </div>
            </div>
        </div>
        
        <!-- Patient Information -->
        <div class="report-card">
            <div class="card-header">
                <h2 class="card-title">Patient Information</h2>
            </div>
            <div class="patient-info" id="patientInfo">
                <!-- Patient info will be populated here -->
            </div>
        </div>
        
        <!-- Health Assessment Summary -->
        <div class="report-card">
            <div class="card-header">
                <h2 class="card-title">Health Assessment Summary</h2>
            </div>
            
            <div class="section-container">
                <div class="section-header">
                    <span class="section-icon">ü©∫</span>
                    <h3 class="section-title">Chief Complaints</h3>
                </div>
                <div id="chiefComplaints">
                    <!-- Complaints will be populated here -->
                </div>
            </div>
            
            <div class="section-container">
                <div class="section-header">
                    <span class="section-icon">üíä</span>
                    <h3 class="section-title">Current Medications</h3>
                </div>
                <div id="currentMedications">
                    <!-- Medications will be populated here -->
                </div>
            </div>
            
            <div class="section-container">
                <div class="section-header">
                    <span class="section-icon">üî¨</span>
                    <h3 class="section-title">Key Findings</h3>
                </div>
                <div id="keyFindings">
                    <!-- Findings will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- IRIS Assessment Results -->
        <div class="report-card">
            <div class="card-header">
                <h2 class="card-title">AI-Powered IRIS Constitutional Assessment</h2>
            </div>
            
            <div class="section-container">
                <div class="section-header">
                    <span class="section-icon">üëÅÔ∏è</span>
                    <h3 class="section-title">Constitutional Findings</h3>
                </div>
                <div id="constitutionalFindings">
                    <!-- Constitutional findings will be populated here -->
                </div>
            </div>
            
            <div class="section-container">
                <div class="section-header">
                    <span class="section-icon">üîç</span>
                    <h3 class="section-title">System Analysis</h3>
                </div>
                <div id="systemAnalysis">
                    <!-- System analysis will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- AI Recommendations -->
        <div class="report-card">
            <div class="card-header">
                <h2 class="card-title">AI-Generated Health Recommendations</h2>
            </div>
            
            <div class="alert alert-success">
                <span style="font-size: 24px;">ü§ñ</span>
                <div>
                    <strong>Personalized Recommendations Generated by AI</strong>
                    <p style="margin-top: 5px;">Based on your comprehensive iris assessment and constitutional analysis.</p>
                </div>
            </div>
            
            <div id="recommendationsContainer">
                <!-- Recommendations will be populated here -->
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="report-card">
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="printReport()">üñ®Ô∏è Print Report</button>
                <button class="btn btn-email" onclick="emailReport()">üìß Email to Patient</button>
                <button class="btn btn-primary" onclick="proceedToTherapySelection()">
                    Continue to Therapy Selection ‚Üí
                </button>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3>Generating Comprehensive Report...</h3>
            <p style="color: #64748b; margin-top: 10px;">Analyzing assessment data</p>
        </div>
    </div>
    
    <script>
        // Initialize Supabase client with correct credentials
        const SUPABASE_URL = 'https://defifwzgazqlrigwumqn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRlZmlmd3pnYXpxbHJpZ3d1bXFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3NDU5NzIsImV4cCI6MjA3NDMyMTk3Mn0.fJhK76BZ1_HQa0p-2m6-5cLjPqp0SqBBOlwE7bJAUyg';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let patientData = null;
        let healthAssessment = null;
        let irisAssessment = null;
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Starting report generation...');
            
            const urlParams = new URLSearchParams(window.location.search);
            const patientId = urlParams.get('patientId') || sessionStorage.getItem('currentPatientId');
            const assessmentId = urlParams.get('assessmentId');
            
            if (!patientId) {
                alert('No patient selected. Redirecting to patient selection.');
                window.location.href = 'patient-management.html';
                return;
            }
            
            await generateComprehensiveReport(patientId, assessmentId);
        });
        
        async function generateComprehensiveReport(patientId, assessmentId) {
            try {
                showLoading(true);
                console.log(`Loading data for patient ${patientId}, assessment ${assessmentId}`);
                
                // Load patient data
                patientData = await loadPatientData(patientId);
                console.log('Patient data loaded:', patientData);
                
                // Load health assessment
                healthAssessment = await loadHealthAssessment(patientId);
                console.log('Health assessment loaded:', healthAssessment);
                
                // Load IRIS assessment
                irisAssessment = await loadIrisAssessment(patientId, assessmentId);
                console.log('IRIS assessment loaded:', irisAssessment);
                
                // Display the report
                displayReport();
                
                showLoading(false);
                
            } catch (error) {
                console.error('Error generating report:', error);
                showLoading(false);
                alert('Error generating report: ' + (error.message || 'Unknown error'));
            }
        }
        
        async function loadPatientData(patientId) {
            const { data, error } = await supabase
                .from('patients')
                .select('*')
                .eq('id', patientId)
                .single();
            
            if (error) throw error;
            return data;
        }
        
        async function loadHealthAssessment(patientId) {
            try {
                const { data, error } = await supabase
                    .from('health_assessments')
                    .select('*')
                    .eq('patient_id', patientId)
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .single();
                
                return data || {};
            } catch (error) {
                console.warn('No health assessment found:', error);
                return {};
            }
        }
        
        async function loadIrisAssessment(patientId, assessmentId) {
            try {
                let query = supabase
                    .from('iris_assessments')
                    .select('*')
                    .eq('patient_id', patientId)
                    .order('created_at', { ascending: false });
                
                if (assessmentId) {
                    query = query.eq('id', assessmentId);
                }
                
                const { data, error } = await query.limit(1).single();
                
                if (error) {
                    console.warn('No IRIS assessment found:', error);
                    return null;
                }
                
                return data;
                
            } catch (error) {
                console.error('Error loading IRIS assessment:', error);
                return null;
            }
        }
        
        function displayReport() {
            console.log('Displaying report with data:', { patientData, healthAssessment, irisAssessment });
            
            // Display patient information
            displayPatientInfo();
            
            // Display health assessment summary
            displayHealthSummary();
            
            // Display IRIS findings
            displayIrisFindings();
        }
        
        function displayPatientInfo() {
            const container = document.getElementById('patientInfo');
            container.innerHTML = `
                <div class="info-item">
                    <div class="info-label">Patient Name</div>
                    <div class="info-value">${patientData.first_name} ${patientData.last_name}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Patient ID</div>
                    <div class="info-value">${patientData.patient_id}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Age/Gender</div>
                    <div class="info-value">${calculateAge(patientData.date_of_birth)} years / ${patientData.gender || 'N/A'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Report Date</div>
                    <div class="info-value">${new Date().toLocaleDateString('en-GB')}</div>
                </div>
            `;
        }
        
        function displayHealthSummary() {
            // Chief Complaints
            const complaintsDiv = document.getElementById('chiefComplaints');
            const complaints = healthAssessment.chief_complaint || 'No complaints recorded';
            complaintsDiv.innerHTML = `
                <div class="finding-card">
                    <div class="finding-details">${complaints}</div>
                </div>
            `;
            
            // Current Medications
            const medicationsDiv = document.getElementById('currentMedications');
            const medications = healthAssessment.current_medications || 'None reported';
            medicationsDiv.innerHTML = `
                <div class="finding-card">
                    <div class="finding-details">${medications}</div>
                </div>
            `;
            
            // Key Findings
            const findingsDiv = document.getElementById('keyFindings');
            let findingsHtml = '';
            
            if (healthAssessment.lifestyle_habits) {
                findingsHtml += `
                    <div class="finding-card">
                        <div class="finding-header">
                            <div class="finding-title">Lifestyle Factors</div>
                        </div>
                        <div class="finding-details">${healthAssessment.lifestyle_habits}</div>
                    </div>
                `;
            }
            
            findingsDiv.innerHTML = findingsHtml || '<p style="color: #64748b;">No additional findings recorded</p>';
        }
        
        function displayIrisFindings() {
            if (!irisAssessment) {
                document.getElementById('constitutionalFindings').innerHTML = 
                    '<p style="color: #64748b;">IRIS assessment not completed</p>';
                document.getElementById('systemAnalysis').innerHTML = 
                    '<p style="color: #64748b;">No system analysis available</p>';
                document.getElementById('recommendationsContainer').innerHTML = 
                    '<p style="color: #64748b;">No recommendations available</p>';
                return;
            }
            
            // Constitutional Findings
            displayConstitutionalFindings();
            
            // System Analysis
            displaySystemAnalysis();
            
            // AI Recommendations
            displayRecommendations();
        }
        
        function displayConstitutionalFindings() {
            const container = document.getElementById('constitutionalFindings');
            let html = '';
            
            // Basic findings from individual columns
            if (irisAssessment.constitutional_type) {
                html += `
                    <div class="finding-card">
                        <div class="finding-header">
                            <div class="finding-title">Constitutional Type</div>
                            <span class="severity-badge severity-mild">${irisAssessment.constitutional_type}</span>
                        </div>
                        <div class="finding-details">Primary constitutional classification based on iris fiber patterns</div>
                    </div>
                `;
            }
            
            if (irisAssessment.fiber_density) {
                html += `
                    <div class="finding-card">
                        <div class="finding-header">
                            <div class="finding-title">Fiber Density</div>
                            <span class="severity-badge severity-mild">${irisAssessment.fiber_density}</span>
                        </div>
                        <div class="finding-details">Indicates inherent constitutional strength and resilience</div>
                    </div>
                `;
            }
            
            if (irisAssessment.pupil_size) {
                html += `
                    <div class="finding-card">
                        <div class="finding-header">
                            <div class="finding-title">Pupil Response</div>
                            <span class="severity-badge severity-mild">${irisAssessment.pupil_size}</span>
                        </div>
                        <div class="finding-details">Reflects autonomic nervous system balance</div>
                    </div>
                `;
            }
            
            if (irisAssessment.stress_rings && irisAssessment.stress_rings !== 'none') {
                const severityClass = irisAssessment.stress_rings === 'severe' ? 'severity-severe' : 'severity-moderate';
                html += `
                    <div class="finding-card">
                        <div class="finding-header">
                            <div class="finding-title">Stress Indicators</div>
                            <span class="severity-badge ${severityClass}">${irisAssessment.stress_rings} stress rings</span>
                        </div>
                        <div class="finding-details">Indicates chronic stress patterns and nervous system tension</div>
                    </div>
                `;
            }
            
            container.innerHTML = html || '<p style="color: #64748b;">No constitutional findings available</p>';
        }
        
        function displaySystemAnalysis() {
            const container = document.getElementById('systemAnalysis');
            let html = '';
            
            // Check for AI analysis data (Gemini results)
            if (irisAssessment.claude_analysis) {
                const analysis = irisAssessment.claude_analysis;
                
                // Overall health grade
                if (analysis.comprehensive_analysis && analysis.comprehensive_analysis.overall_health_grade) {
                    html += `
                        <div class="finding-card">
                            <div class="finding-header">
                                <div class="finding-title">Overall Health Assessment</div>
                                <span class="severity-badge severity-mild">Grade ${analysis.comprehensive_analysis.overall_health_grade}</span>
                            </div>
                            <div class="finding-details">AI-generated comprehensive health evaluation based on iris patterns</div>
                        </div>
                    `;
                }
                
                // Priority alerts
                if (analysis.comprehensive_analysis && analysis.comprehensive_analysis.priority_alerts) {
                    const alerts = analysis.comprehensive_analysis.priority_alerts;
                    
                    // Critical alerts
                    if (alerts.critical && alerts.critical.length > 0) {
                        alerts.critical.forEach(alert => {
                            html += `
                                <div class="finding-card">
                                    <div class="finding-header">
                                        <div class="finding-title">Priority Finding</div>
                                        <span class="severity-badge severity-severe">High Priority</span>
                                    </div>
                                    <div class="finding-details">${alert}</div>
                                </div>
                            `;
                        });
                    }
                    
                    // Moderate alerts
                    if (alerts.moderate && alerts.moderate.length > 0) {
                        alerts.moderate.forEach(alert => {
                            html += `
                                <div class="finding-card">
                                    <div class="finding-header">
                                        <div class="finding-title">Moderate Finding</div>
                                        <span class="severity-badge severity-moderate">Moderate</span>
                                    </div>
                                    <div class="finding-details">${alert}</div>
                                </div>
                            `;
                        });
                    }
                    
                    // Normal findings
                    if (alerts.normal && alerts.normal.length > 0) {
                        alerts.normal.forEach(alert => {
                            html += `
                                <div class="finding-card">
                                    <div class="finding-header">
                                        <div class="finding-title">Healthy System</div>
                                        <span class="severity-badge severity-mild">Normal</span>
                                    </div>
                                    <div class="finding-details">${alert}</div>
                                </div>
                            `;
                        });
                    }
                }
            }
            
            // Clinical notes if available
            if (irisAssessment.clinical_notes) {
                html += `
                    <div class="finding-card">
                        <div class="finding-header">
                            <div class="finding-title">Clinical Observations</div>
                        </div>
                        <div class="finding-details">${irisAssessment.clinical_notes}</div>
                    </div>
                `;
            }
            
            container.innerHTML = html || '<p style="color: #64748b;">No system analysis available</p>';
        }
        
        function displayRecommendations() {
            const container = document.getElementById('recommendationsContainer');
            let html = '';
            
            if (irisAssessment.claude_analysis && 
                irisAssessment.claude_analysis.comprehensive_analysis && 
                irisAssessment.claude_analysis.comprehensive_analysis.recommendations) {
                
                const recommendations = irisAssessment.claude_analysis.comprehensive_analysis.recommendations;
                
                // Nutritional recommendations
                if (recommendations.nutritional) {
                    html += `
                        <div class="section-container">
                            <div class="section-header">
                                <span class="section-icon">ü•ó</span>
                                <h3 class="section-title">Nutritional Guidance</h3>
                            </div>
                    `;
                    
                    if (recommendations.nutritional.foods_to_support) {
                        html += `
                            <div class="finding-card">
                                <div class="finding-header">
                                    <div class="finding-title">Beneficial Foods</div>
                                    <span class="severity-badge severity-mild">Recommended</span>
                                </div>
                                <div class="finding-details">
                                    <ul style="margin-left: 20px; margin-top: 10px;">
                                        ${recommendations.nutritional.foods_to_support.map(food => `<li>${food}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `;
                    }
                    
                    if (recommendations.nutritional.foods_to_avoid) {
                        html += `
                            <div class="finding-card">
                                <div class="finding-header">
                                    <div class="finding-title">Foods to Limit</div>
                                    <span class="severity-badge severity-moderate">Caution</span>
                                </div>
                                <div class="finding-details">
                                    <ul style="margin-left: 20px; margin-top: 10px;">
                                        ${recommendations.nutritional.foods_to_avoid.map(food => `<li>${food}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                }
                
                // Supplement recommendations
                if (recommendations.supplements) {
                    html += `
                        <div class="section-container">
                            <div class="section-header">
                                <span class="section-icon">üíä</span>
                                <h3 class="section-title">Supplement Support</h3>
                            </div>
                    `;
                    
                    if (recommendations.supplements.foundational) {
                        html += `
                            <div class="finding-card">
                                <div class="finding-header">
                                    <div class="finding-title">Foundation Supplements</div>
                                    <span class="severity-badge severity-mild">Essential</span>
                                </div>
                                <div class="finding-details">
                                    <ul style="margin-left: 20px; margin-top: 10px;">
                                        ${recommendations.supplements.foundational.map(supplement => `<li>${supplement}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `;
                    }
                    
                    if (recommendations.supplements.targeted) {
                        html += `
                            <div class="finding-card">
                                <div class="finding-header">
                                    <div class="finding-title">Targeted Support</div>
                                    <span class="severity-badge severity-moderate">Specific</span>
                                </div>
                                <div class="finding-details">
                                    <ul style="margin-left: 20px; margin-top: 10px;">
                                        ${recommendations.supplements.targeted.map(supplement => `<li>${supplement}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                }
                
                // Lifestyle recommendations
                if (recommendations.lifestyle) {
                    html += `
                        <div class="section-container">
                            <div class="section-header">
                                <span class="section-icon">üèÉ‚Äç‚ôÄÔ∏è</span>
                                <h3 class="section-title">Lifestyle Guidance</h3>
                            </div>
                    `;
                    
                    if (recommendations.lifestyle.stress_management) {
                        html += `
                            <div class="finding-card">
                                <div class="finding-header">
                                    <div class="finding-title">Stress Management</div>
                                    <span class="severity-badge severity-moderate">Important</span>
                                </div>
                                <div class="finding-details">
                                    <ul style="margin-left: 20px; margin-top: 10px;">
                                        ${recommendations.lifestyle.stress_management.map(item => `<li>${item}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `;
                    }
                    
                    if (recommendations.lifestyle.movement) {
                        html += `
                            <div class="finding-card">
                                <div class="finding-header">
                                    <div class="finding-title">Movement & Exercise</div>
                                    <span class="severity-badge severity-mild">Beneficial</span>
                                </div>
                                <div class="finding-details">
                                    <ul style="margin-left: 20px; margin-top: 10px;">
                                        ${recommendations.lifestyle.movement.map(item => `<li>${item}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                }
            }
            
            container.innerHTML = html || '<p style="color: #64748b;">No specific recommendations available</p>';
        }
        
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        }
        
        function calculateAge(dateOfBirth) {
            if (!dateOfBirth) return 'N/A';
            const today = new Date();
            const birthDate = new Date(dateOfBirth);
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }
        
        // Action button functions - GLOBAL SCOPE
        window.printReport = function() {
            window.print();
        };
        
        window.emailReport = function() {
            const subject = encodeURIComponent(`Health Assessment Report - ${patientData.first_name} ${patientData.last_name}`);
            const body = encodeURIComponent(`Please find attached the comprehensive health assessment report.\n\nReport generated on: ${new Date().toLocaleDateString('en-GB')}\n\nBest regards,\nCelloxen Health Platform`);
            
            window.location.href = `mailto:${patientData.email || ''}?subject=${subject}&body=${body}`;
        };
        
        window.proceedToTherapySelection = function() {
            sessionStorage.setItem('reportCompleted', 'true');
            sessionStorage.setItem('currentPatientId', patientData.id);
            
            window.location.href = `clinic-dashboard.html?patientId=${patientData.id}&step=therapy`;
        };
    </script>
</body>
</html>
