<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Diagnosis Report - Celloxen Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #1f2937;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
        }
        
        .back-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .progress-bar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .progress-steps {
            display: flex;
            justify-content: space-between;
            position: relative;
        }
        
        .progress-step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }
        
        .progress-step::before {
            content: '';
            position: absolute;
            top: 20px;
            left: -50%;
            right: -50%;
            height: 2px;
            background: #e2e8f0;
            z-index: -1;
        }
        
        .progress-step:first-child::before {
            display: none;
        }
        
        .progress-step.completed::before {
            background: #10b981;
        }
        
        .progress-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e2e8f0;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .progress-step.active .progress-circle {
            background: linear-gradient(135deg, #1e3a8a, #1e40af);
            color: white;
            transform: scale(1.1);
        }
        
        .progress-step.completed .progress-circle {
            background: #10b981;
            color: white;
        }
        
        .report-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .card-header {
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 20px;
            margin-bottom: 25px;
        }
        
        .card-title {
            font-size: 22px;
            font-weight: 600;
            color: #1e293b;
        }
        
        .patient-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .info-item {
            padding: 15px;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 12px;
        }
        
        .info-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .info-value {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-top: 5px;
        }
        
        .section-container {
            margin: 30px 0;
        }
        
        .section-header {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-icon {
            font-size: 24px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }
        
        .finding-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #1e3a8a;
            transition: all 0.3s ease;
        }
        
        .finding-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .finding-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .finding-title {
            font-weight: 600;
            color: #1e293b;
        }
        
        .severity-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .severity-mild {
            background: #d1fae5;
            color: #065f46;
        }
        
        .severity-moderate {
            background: #fef3c7;
            color: #92400e;
        }
        
        .severity-severe {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .finding-details {
            color: #475569;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .therapy-recommendation {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
        }
        
        .therapy-list {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }
        
        .therapy-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #10b981;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .therapy-item:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.2);
        }
        
        .therapy-info {
            flex: 1;
        }
        
        .therapy-name {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 5px;
        }
        
        .therapy-description {
            font-size: 14px;
            color: #64748b;
        }
        
        .match-score {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-weight: 600;
            min-width: 60px;
            text-align: center;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #f1f5f9;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 16px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            flex: 1;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }
        
        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background: #d1d5db;
        }
        
        .btn-email {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }
        
        .btn-email:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #1e3a8a;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-success {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        
        .alert-warning {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }
        
        @media print {
            body {
                background: white;
            }
            
            .header, .action-buttons, .back-btn {
                display: none;
            }
            
            .report-card {
                box-shadow: none;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div>
                <h1>Comprehensive Diagnosis Report</h1>
                <p style="color: #cbd5e1; margin-top: 5px;">Complete health assessment and treatment recommendations</p>
            </div>
            <a href="clinic-dashboard.html" class="back-btn">‚Üê Back to Dashboard</a>
        </div>
    </div>
    
    <div class="container">
        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-steps">
                <div class="progress-step completed">
                    <div class="progress-circle">‚úì</div>
                    <div>Health Assessment</div>
                </div>
                <div class="progress-step completed">
                    <div class="progress-circle">‚úì</div>
                    <div>IRIS Analysis</div>
                </div>
                <div class="progress-step active">
                    <div class="progress-circle">3</div>
                    <div>Diagnosis Report</div>
                </div>
                <div class="progress-step">
                    <div class="progress-circle">4</div>
                    <div>Therapy Selection</div>
                </div>
                <div class="progress-step">
                    <div class="progress-circle">5</div>
                    <div>Treatment Plan</div>
                </div>
            </div>
        </div>
        
        <!-- Patient Information -->
        <div class="report-card">
            <div class="card-header">
                <h2 class="card-title">Patient Information</h2>
            </div>
            <div class="patient-info" id="patientInfo">
                <!-- Patient info will be populated here -->
            </div>
        </div>
        
        <!-- Health Assessment Summary -->
        <div class="report-card">
            <div class="card-header">
                <h2 class="card-title">Health Assessment Summary</h2>
            </div>
            
            <div class="section-container">
                <div class="section-header">
                    <span class="section-icon">ü©∫</span>
                    <h3 class="section-title">Chief Complaints</h3>
                </div>
                <div id="chiefComplaints">
                    <!-- Complaints will be populated here -->
                </div>
            </div>
            
            <div class="section-container">
                <div class="section-header">
                    <span class="section-icon">üíä</span>
                    <h3 class="section-title">Current Medications</h3>
                </div>
                <div id="currentMedications">
                    <!-- Medications will be populated here -->
                </div>
            </div>
            
            <div class="section-container">
                <div class="section-header">
                    <span class="section-icon">üî¨</span>
                    <h3 class="section-title">Key Findings</h3>
                </div>
                <div id="keyFindings">
                    <!-- Findings will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- IRIS Assessment Results -->
        <div class="report-card">
            <div class="card-header">
                <h2 class="card-title">IRIS Constitutional Assessment</h2>
            </div>
            
            <div class="section-container">
                <div class="section-header">
                    <span class="section-icon">üëÅÔ∏è</span>
                    <h3 class="section-title">Constitutional Findings</h3>
                </div>
                <div id="constitutionalFindings">
                    <!-- Constitutional findings will be populated here -->
                </div>
            </div>
            
            <div class="section-container">
                <div class="section-header">
                    <span class="section-icon">üîç</span>
                    <h3 class="section-title">Organ System Analysis</h3>
                </div>
                <div id="organAnalysis">
                    <!-- Organ analysis will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- Therapy Recommendations -->
        <div class="report-card">
            <div class="card-header">
                <h2 class="card-title">Recommended Therapy Protocols</h2>
            </div>
            
            <div class="therapy-recommendation">
                <div class="alert alert-success">
                    <span style="font-size: 24px;">‚ú®</span>
                    <div>
                        <strong>Personalized Treatment Plan Generated</strong>
                        <p style="margin-top: 5px;">Based on your comprehensive assessment, the following therapies are recommended.</p>
                    </div>
                </div>
                
                <div class="therapy-list" id="therapyList">
                    <!-- Therapy recommendations will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="report-card">
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="printReport()">üñ®Ô∏è Print Report</button>
                <button class="btn btn-email" onclick="emailReport()">üìß Email to Patient</button>
                <button class="btn btn-primary" onclick="proceedToTherapySelection()">
                    Continue to Therapy Selection ‚Üí
                </button>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3>Generating Comprehensive Report...</h3>
            <p style="color: #64748b; margin-top: 10px;">Analyzing assessment data</p>
        </div>
    </div>
    
    <script type="module">
        import { supabase } from './supabase-config.js';
        import { sendReportEmail } from './email-sender.js';
        
        let patientData = null;
        let healthAssessment = null;
        let irisAssessment = null;
        let reportData = null;
        let recommendedTherapies = [];
        
        // IRIS Assessment Compatibility Functions
        function normalizeIrisAssessmentData(assessmentData) {
            const normalized = {
                id: assessmentData.id,
                patient_id: assessmentData.patient_id,
                clinic_id: assessmentData.clinic_id,
                created_at: assessmentData.created_at,
                organ_analysis: [],
                constitutional_findings: {},
                iris_signs: [],
                recommendations: []
            };
            
            // Convert new assessment format to expected format
            if (assessmentData.assessment_data) {
                const data = typeof assessmentData.assessment_data === 'string' 
                    ? JSON.parse(assessmentData.assessment_data) 
                    : assessmentData.assessment_data;
                    
                normalized.constitutional_findings = data.findings || {};
                normalized.organ_analysis = convertFindingsToOrganAnalysis(data.findings);
                
            } else if (assessmentData.constitution_type) {
                // If data is stored in individual columns
                normalized.constitutional_findings = {
                    constitution_type: assessmentData.constitution_type,
                    fiber_density: assessmentData.fiber_density,
                    pupil_size: assessmentData.pupil_size,
                    collarette_position: assessmentData.collarette_position,
                    lacunae: assessmentData.lacunae,
                    stress_rings: assessmentData.stress_rings,
                    clinical_notes: assessmentData.clinical_notes
                };
                
                normalized.organ_analysis = convertFindingsToOrganAnalysis(normalized.constitutional_findings);
            }
            
            normalized.iris_signs = generateIrisSigns(normalized.constitutional_findings);
            
            if (assessmentData.images) {
                normalized.images = assessmentData.images;
            }
            
            return normalized;
        }
        
        function convertFindingsToOrganAnalysis(findings) {
            const organAnalysis = [];
            
            if (findings.constitution_type) {
                switch(findings.constitution_type) {
                    case 'neurogenic':
                        organAnalysis.push({
                            organ: 'Nervous System',
                            findings: ['High nervous system sensitivity', 'Stress response tendencies'],
                            severity: 'moderate',
                            location: 'Both eyes'
                        });
                        break;
                    case 'polyglandular':
                        organAnalysis.push({
                            organ: 'Endocrine System',
                            findings: ['Glandular imbalances', 'Hormonal fluctuations'],
                            severity: 'moderate',
                            location: 'Both eyes'
                        });
                        break;
                    case 'connective_tissue':
                        organAnalysis.push({
                            organ: 'Connective Tissue',
                            findings: ['Connective tissue weakness', 'Structural support needs'],
                            severity: 'moderate',
                            location: 'Both eyes'
                        });
                        break;
                    case 'lymphatic':
                        organAnalysis.push({
                            organ: 'Lymphatic System',
                            findings: ['Lymphatic congestion tendency', 'Immune system support needed'],
                            severity: 'moderate',
                            location: 'Both eyes'
                        });
                        break;
                    case 'biliary':
                        organAnalysis.push({
                            organ: 'Hepatobiliary System',
                            findings: ['Liver/gallbladder support needed', 'Digestive weakness'],
                            severity: 'moderate',
                            location: 'Both eyes'
                        });
                        break;
                }
            }
            
            if (findings.fiber_density) {
                switch(findings.fiber_density) {
                    case 'loose':
                    case 'very_loose':
                        organAnalysis.push({
                            organ: 'Constitutional Strength',
                            findings: ['Weak constitutional fibers', 'Need for constitutional support'],
                            severity: findings.fiber_density === 'very_loose' ? 'severe' : 'moderate',
                            location: 'Both eyes'
                        });
                        break;
                    case 'tight':
                        organAnalysis.push({
                            organ: 'Constitutional Strength',
                            findings: ['Strong constitutional fibers', 'Good inherent vitality'],
                            severity: 'mild',
                            location: 'Both eyes'
                        });
                        break;
                }
            }
            
            if (findings.stress_rings && findings.stress_rings !== 'none') {
                const severity = findings.stress_rings === 'severe' ? 'severe' : 
                                findings.stress_rings === 'moderate' ? 'moderate' : 'mild';
                organAnalysis.push({
                    organ: 'Stress Response System',
                    findings: ['Chronic stress patterns', 'Nervous tension rings'],
                    severity: severity,
                    location: 'Peripheral zones'
                });
            }
            
            if (findings.lacunae && findings.lacunae !== 'none') {
                const severity = findings.lacunae === 'many' ? 'moderate' : 'mild';
                organAnalysis.push({
                    organ: 'Tissue Integrity',
                    findings: ['Tissue weakness signs', 'Genetic predisposition markers'],
                    severity: severity,
                    location: 'Various zones'
                });
            }
            
            // Ensure we always return at least one analysis
            if (organAnalysis.length === 0) {
                organAnalysis.push({
                    organ: 'General Constitution',
                    findings: ['Constitutional assessment completed'],
                    severity: 'mild',
                    location: 'Both eyes'
                });
            }
            
            return organAnalysis;
        }
        
        function generateIrisSigns(findings) {
            const signs = [];
            
            if (findings.constitution_type) {
                signs.push({
                    sign: 'Constitutional Type',
                    description: `${findings.constitution_type} constitution identified`,
                    significance: 'Indicates primary constitutional tendencies'
                });
            }
            
            if (findings.fiber_density) {
                signs.push({
                    sign: 'Fiber Density',
                    description: `${findings.fiber_density} fiber pattern observed`,
                    significance: 'Indicates inherent constitutional strength'
                });
            }
            
            if (findings.stress_rings && findings.stress_rings !== 'none') {
                signs.push({
                    sign: 'Stress Rings',
                    description: `${findings.stress_rings} stress rings detected`,
                    significance: 'Indicates nervous system tension'
                });
            }
            
            return signs;
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const patientId = urlParams.get('patientId') || sessionStorage.getItem('currentPatientId');
            
            if (!patientId) {
                alert('No patient selected. Redirecting to patient selection.');
                window.location.href = 'patient-management.html';
                return;
            }
            
            await generateComprehensiveReport(patientId);
        });
        
        async function generateComprehensiveReport(patientId) {
            try {
                showLoading(true);
                
                // Load patient data
                patientData = await loadPatientData(patientId);
                
                // Load health assessment
                healthAssessment = await loadHealthAssessment(patientId);
                
                // Load IRIS assessment with normalization
                const rawIrisData = await loadIrisAssessment(patientId);
                irisAssessment = rawIrisData ? normalizeIrisAssessmentData(rawIrisData) : null;
                
                // Generate therapy recommendations
                const recommendations = await generateTherapyRecommendations(
                    patientData, 
                    healthAssessment, 
                    irisAssessment
                );
                
                recommendedTherapies = recommendations.therapies || [];
                
                // Display the report
                displayReport();
                
                // Save report to database
                await saveReport();
                
                showLoading(false);
                
            } catch (error) {
                console.error('Error generating report:', error);
                showLoading(false);
                alert('Error generating report. Please try again.');
            }
        }
        
        async function loadPatientData(patientId) {
            const { data, error } = await supabase
                .from('patients')
                .select('*')
                .eq('id', patientId)
                .single();
            
            if (error) throw error;
            return data;
        }
        
        async function loadHealthAssessment(patientId) {
            const { data, error } = await supabase
                .from('health_assessments')
                .select('*')
                .eq('patient_id', patientId)
                .order('created_at', { ascending: false })
                .limit(1)
                .single();
            
            return data || {};
        }
        
        async function loadIrisAssessment(patientId) {
            try {
                // Try to load from session first
                let irisData = sessionStorage.getItem('irisAssessmentData');
                if (irisData) {
                    return JSON.parse(irisData);
                }
                
                // Load from database
                const { data, error } = await supabase
                    .from('iris_assessments')
                    .select('*')
                    .eq('patient_id', patientId)
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .single();
                
                if (error) {
                    console.warn('No IRIS assessment found:', error);
                    return null;
                }
                
                return data;
                
            } catch (error) {
                console.error('Error loading IRIS assessment:', error);
                return null;
            }
        }
        
        async function generateTherapyRecommendations(patient, health, iris) {
            try {
                // Import the recommendation engine dynamically
                const { TherapyRecommendationEngine } = await import('./therapy-recommendations-engine.js');
                
                const engine = new TherapyRecommendationEngine();
                const recommendations = engine.generateRecommendations(patient, health, iris);
                
                return {
                    therapies: recommendations.recommendedTherapies || [],
                    scores: recommendations.matchScores || {},
                    reasoning: recommendations.reasoning || ''
                };
                
            } catch (error) {
                console.error('Error generating recommendations:', error);
                // Return default recommendations
                return {
                    therapies: ['001', '301', '501'],
                    scores: { '001': 0.5, '301': 0.5, '501': 0.5 },
                    reasoning: 'Default wellness recommendations'
                };
            }
        }
        
        function displayReport() {
            // Display patient information
            displayPatientInfo();
            
            // Display health assessment summary
            displayHealthSummary();
            
            // Display IRIS findings
            displayIrisFindings();
            
            // Display therapy recommendations
            displayTherapyRecommendations();
        }
        
        function displayPatientInfo() {
            const container = document.getElementById('patientInfo');
            container.innerHTML = `
                <div class="info-item">
                    <div class="info-label">Patient Name</div>
                    <div class="info-value">${patientData.first_name} ${patientData.last_name}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Patient ID</div>
                    <div class="info-value">${patientData.patient_id}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Age/Gender</div>
                    <div class="info-value">${calculateAge(patientData.date_of_birth)} years / ${patientData.gender || 'N/A'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Report Date</div>
                    <div class="info-value">${new Date().toLocaleDateString('en-GB')}</div>
                </div>
            `;
        }
        
        function displayHealthSummary() {
            // Chief Complaints
            const complaintsDiv = document.getElementById('chiefComplaints');
            const complaints = healthAssessment.chief_complaint || 'No complaints recorded';
            complaintsDiv.innerHTML = `
                <div class="finding-card">
                    <div class="finding-details">${complaints}</div>
                </div>
            `;
            
            // Current Medications
            const medicationsDiv = document.getElementById('currentMedications');
            const medications = healthAssessment.current_medications || 'None';
            medicationsDiv.innerHTML = `
                <div class="finding-card">
                    <div class="finding-details">${medications}</div>
                </div>
            `;
            
            // Key Findings
            const findingsDiv = document.getElementById('keyFindings');
            let findingsHtml = '';
            
            if (healthAssessment.lifestyle_habits) {
                findingsHtml += `
                    <div class="finding-card">
                        <div class="finding-header">
                            <div class="finding-title">Lifestyle Factors</div>
                        </div>
                        <div class="finding-details">${healthAssessment.lifestyle_habits}</div>
                    </div>
                `;
            }
            
            if (healthAssessment.symptoms_duration) {
                findingsHtml += `
                    <div class="finding-card">
                        <div class="finding-header">
                            <div class="finding-title">Symptom Duration</div>
                        </div>
                        <div class="finding-details">${healthAssessment.symptoms_duration}</div>
                    </div>
                `;
            }
            
            findingsDiv.innerHTML = findingsHtml || '<p style="color: #64748b;">No additional findings recorded</p>';
        }
        
        function displayIrisFindings() {
            if (!irisAssessment) {
                document.getElementById('constitutionalFindings').innerHTML = 
                    '<p style="color: #64748b;">IRIS assessment not completed</p>';
                document.getElementById('organAnalysis').innerHTML = 
                    '<p style="color: #64748b;">No organ analysis available</p>';
                return;
            }
            
            // Constitutional Findings
            const constitutionalDiv = document.getElementById('constitutionalFindings');
            let constitutionalHtml = '';
            
            if (irisAssessment.constitutional_findings) {
                const findings = irisAssessment.constitutional_findings;
                
                if (findings.constitution_type) {
                    constitutionalHtml += `
                        <div class="finding-card">
                            <div class="finding-header">
                                <div class="finding-title">Constitutional Type</div>
                                <span class="severity-badge severity-mild">${findings.constitution_type}</span>
                            </div>
                        </div>
                    `;
                }
                
                if (findings.fiber_density) {
                    constitutionalHtml += `
                        <div class="finding-card">
                            <div class="finding-header">
                                <div class="finding-title">Fiber Density</div>
                                <span class="severity-badge severity-mild">${findings.fiber_density}</span>
                            </div>
                        </div>
                    `;
                }
            }
            
            constitutionalDiv.innerHTML = constitutionalHtml || '<p style="color: #64748b;">No constitutional findings</p>';
            
            // Organ Analysis
            const organDiv = document.getElementById('organAnalysis');
            let organHtml = '';
            
            if (irisAssessment.organ_analysis && irisAssessment.organ_analysis.length > 0) {
                irisAssessment.organ_analysis.forEach(analysis => {
                    const severityClass = `severity-${analysis.severity || 'mild'}`;
                    organHtml += `
                        <div class="finding-card">
                            <div class="finding-header">
                                <div class="finding-title">${analysis.organ}</div>
                                <span class="severity-badge ${severityClass}">${analysis.severity || 'mild'}</span>
                            </div>
                            <div class="finding-details">
                                ${analysis.findings.join(', ')}
                            </div>
                        </div>
                    `;
                });
            }
            
            organDiv.innerHTML = organHtml || '<p style="color: #64748b;">No organ analysis available</p>';
        }
        
        function displayTherapyRecommendations() {
            const container = document.getElementById('therapyList');
            
            if (!recommendedTherapies || recommendedTherapies.length === 0) {
                container.innerHTML = '<p style="color: #64748b;">No therapy recommendations generated</p>';
                return;
            }
            
            let html = '';
            recommendedTherapies.forEach(therapyCode => {
                html += `
                    <div class="therapy-item">
                        <div class="therapy-info">
                            <div class="therapy-name">Therapy Protocol ${therapyCode}</div>
                            <div class="therapy-description">Recommended based on assessment findings</div>
                        </div>
                        <div class="match-score">Match</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        async function saveReport() {
            try {
                reportData = {
                    patient_id: patientData.id,
                    clinic_id: patientData.clinic_id,
                    report_type: 'comprehensive',
                    health_assessment_id: healthAssessment?.id,
                    iris_assessment_id: irisAssessment?.id,
                    findings_summary: {
                        chief_complaints: healthAssessment?.chief_complaint,
                        iris_findings: irisAssessment?.constitutional_findings,
                        organ_analysis: irisAssessment?.organ_analysis
                    },
                    recommended_therapies: recommendedTherapies,
                    created_at: new Date().toISOString()
                };
                
                const { data, error } = await supabase
                    .from('diagnosis_reports')
                    .insert([reportData])
                    .select()
                    .single();
                
                if (error) throw error;
                
                reportData.id = data.id;
                sessionStorage.setItem('reportId', data.id);
                sessionStorage.setItem('reportGenerated', 'true');
                
            } catch (error) {
                console.error('Error saving report:', error);
            }
        }
        
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        }
        
        function calculateAge(dateOfBirth) {
            if (!dateOfBirth) return 'N/A';
            const today = new Date();
            const birthDate = new Date(dateOfBirth);
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }
        
        // Action button functions
        window.printReport = function() {
            window.print();
        };
        
        window.emailReport = async function() {
            try {
                showLoading(true);
                
                // Generate PDF content
                const pdfContent = document.querySelector('.container').innerHTML;
                const pdfBlob = new Blob([pdfContent], { type: 'application/pdf' });
                
                // Send email
                await sendReportEmail(pdfBlob, patientData.email, `${patientData.first_name} ${patientData.last_name}`);
                
                showLoading(false);
                alert('Report emailed successfully!');
                
            } catch (error) {
                console.error('Error emailing report:', error);
                showLoading(false);
                alert('Error sending email. Please try again.');
            }
        };
        
        window.proceedToTherapySelection = function() {
            // Save recommended therapies to session
            sessionStorage.setItem('recommendedTherapies', JSON.stringify(recommendedTherapies));
            sessionStorage.setItem('reportCompleted', 'true');
            
            // Navigate to therapy selection
            window.location.href = `treatment-planning.html?patientId=${patientData.id}`;
        };
    </script>
</body>
</html>
