<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Registration - Celloxen Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .registration-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .card-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .card-title {
            font-size: 24px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 5px;
        }
        
        .card-subtitle {
            color: #6b7280;
            font-size: 14px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #374151;
            font-size: 14px;
        }
        
        .required {
            color: #ef4444;
        }
        
        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }
        
        .btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background: #d1d5db;
        }
        
        /* Confirmation Screen */
        .confirmation-screen {
            display: none;
        }
        
        .patient-summary {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .summary-row {
            display: flex;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .summary-row:last-child {
            border-bottom: none;
        }
        
        .summary-label {
            font-weight: 500;
            color: #6b7280;
            width: 150px;
        }
        
        .summary-value {
            color: #1f2937;
            flex: 1;
        }
        
        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .success-icon {
            font-size: 24px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
            <h1 style="font-size: 20px;">Patient Registration</h1>
            <a href="patient-management-enhanced.html" style="color: white; text-decoration: none;">← Back</a>
        </div>
    </div>

    <div class="container">
        <!-- Registration Form -->
        <div id="registrationForm" class="registration-card">
            <div class="card-header">
                <h2 class="card-title">Register New Patient</h2>
                <p class="card-subtitle">Enter patient details to begin their wellness journey</p>
            </div>
            
            <form id="patientForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">First Name <span class="required">*</span></label>
                        <input type="text" class="form-input" id="firstName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last Name <span class="required">*</span></label>
                        <input type="text" class="form-input" id="lastName" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Date of Birth <span class="required">*</span></label>
                        <input type="date" class="form-input" id="dob" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Gender <span class="required">*</span></label>
                        <select class="form-input" id="gender" required>
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="email">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone <span class="required">*</span></label>
                        <input type="tel" class="form-input" id="phone" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Address</label>
                    <input type="text" class="form-input" id="address">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Medical History Notes</label>
                    <textarea class="form-input" id="medicalHistory" rows="3"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Register Patient</button>
                    <button type="button" class="btn btn-secondary" onclick="window.location.href='patient-management-enhanced.html'">Cancel</button>
                </div>
            </form>
        </div>

        <!-- Confirmation Screen -->
        <div id="confirmationScreen" class="registration-card confirmation-screen">
            <div class="card-header">
                <h2 class="card-title">Patient Registration Successful</h2>
                <p class="card-subtitle">Review patient details and continue to health assessment</p>
            </div>
            
            <div class="success-message">
                <span class="success-icon">✓</span>
                <div>
                    <strong>Registration Complete!</strong><br>
                    Patient ID: <span id="confirmPatientId"></span>
                </div>
            </div>
            
            <div class="patient-summary">
                <div class="summary-row">
                    <div class="summary-label">Name:</div>
                    <div class="summary-value" id="confirmName"></div>
                </div>
                <div class="summary-row">
                    <div class="summary-label">Date of Birth:</div>
                    <div class="summary-value" id="confirmDob"></div>
                </div>
                <div class="summary-row">
                    <div class="summary-label">Gender:</div>
                    <div class="summary-value" id="confirmGender"></div>
                </div>
                <div class="summary-row">
                    <div class="summary-label">Email:</div>
                    <div class="summary-value" id="confirmEmail"></div>
                </div>
                <div class="summary-row">
                    <div class="summary-label">Phone:</div>
                    <div class="summary-value" id="confirmPhone"></div>
                </div>
                <div class="summary-row">
                    <div class="summary-label">Address:</div>
                    <div class="summary-value" id="confirmAddress"></div>
                </div>
            </div>
            
            <div class="form-actions">
                <button class="btn btn-primary" onclick="continueToAssessment()">Continue to Health Assessment</button>
                <button class="btn btn-secondary" onclick="editDetails()">Edit Details</button>
                <button class="btn btn-secondary" onclick="window.location.href='patient-management-enhanced.html'">Back to Patients</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabase } from './supabase-config.js';
        import { workflowManager } from './workflow-manager.js';
        
        let registeredPatientId = null;
        let registeredPatientData = null;
        
        document.getElementById('patientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await registerPatient();
        });
        
        async function registerPatient() {
            const authData = JSON.parse(localStorage.getItem('celloxen_auth') || '{}');
            const clinicId = authData.clinicId || sessionStorage.getItem('currentClinicId');
            
            if (!clinicId) {
                alert('No clinic ID found. Please log in again.');
                return;
            }
            
            const patientData = {
                clinic_id: clinicId,
                first_name: document.getElementById('firstName').value,
                last_name: document.getElementById('lastName').value,
                date_of_birth: document.getElementById('dob').value,
                gender: document.getElementById('gender').value,
                email: document.getElementById('email').value || null,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value || null,
                medical_history: document.getElementById('medicalHistory').value || null,
                patient_id: generatePatientId(),
                created_at: new Date().toISOString()
            };
            
            try {
                // Step 1: Register the patient
                const { data: newPatient, error } = await supabase
                    .from('patients')
                    .insert(patientData)
                    .select()
                    .single();
                
                if (error) throw error;
                
                registeredPatientId = newPatient.id;
                registeredPatientData = newPatient;
                
                // Step 2: Initialize workflow using the CORRECT method name
                await workflowManager.initializeWorkflow(newPatient.id);
                
                // Step 3: Show confirmation screen
                showConfirmation(newPatient);
                
            } catch (error) {
                console.error('Error registering patient:', error);
                alert('Error registering patient: ' + error.message);
            }
        }
        
        function generatePatientId() {
            const timestamp = Date.now().toString(36).toUpperCase();
            const random = Math.random().toString(36).substr(2, 5).toUpperCase();
            return `CX${timestamp}${random}`;
        }
        
        function showConfirmation(patient) {
            document.getElementById('registrationForm').style.display = 'none';
            document.getElementById('confirmationScreen').style.display = 'block';
            
            document.getElementById('confirmPatientId').textContent = patient.patient_id;
            document.getElementById('confirmName').textContent = `${patient.first_name} ${patient.last_name}`;
            document.getElementById('confirmDob').textContent = new Date(patient.date_of_birth).toLocaleDateString('en-GB');
            document.getElementById('confirmGender').textContent = patient.gender;
            document.getElementById('confirmEmail').textContent = patient.email || 'N/A';
            document.getElementById('confirmPhone').textContent = patient.phone;
            document.getElementById('confirmAddress').textContent = patient.address || 'N/A';
        }
        
        window.continueToAssessment = async function() {
            if (registeredPatientId) {
                // This will route to health assessment based on workflow stage
                await workflowManager.continueAssessment(registeredPatientId);
            }
        };
        
        window.editDetails = function() {
            // Show form again with data
            document.getElementById('registrationForm').style.display = 'block';
            document.getElementById('confirmationScreen').style.display = 'none';
            
            // Populate form with registered data
            if (registeredPatientData) {
                document.getElementById('firstName').value = registeredPatientData.first_name;
                document.getElementById('lastName').value = registeredPatientData.last_name;
                document.getElementById('dob').value = registeredPatientData.date_of_birth;
                document.getElementById('gender').value = registeredPatientData.gender;
                document.getElementById('email').value = registeredPatientData.email || '';
                document.getElementById('phone').value = registeredPatientData.phone;
                document.getElementById('address').value = registeredPatientData.address || '';
                document.getElementById('medicalHistory').value = registeredPatientData.medical_history || '';
            }
        };
    </script>
</body>
</html>
