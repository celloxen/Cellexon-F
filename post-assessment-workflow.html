<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assessment Complete - Celloxen Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .completion-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            text-align: center;
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 40px;
            color: white;
        }
        
        h1 {
            color: #1e293b;
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .patient-info {
            color: #64748b;
            margin-bottom: 30px;
            font-size: 18px;
        }
        
        .completion-message {
            background: #f0fdf4;
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .completion-message p {
            color: #065f46;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .action-btn {
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #1e3a8a, #1e40af);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(30, 58, 138, 0.3);
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #1e293b;
            border: 2px solid #e5e7eb;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }
        
        .assessment-summary {
            background: #f9fafb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: left;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .summary-item:last-child {
            border-bottom: none;
        }
        
        .summary-label {
            color: #64748b;
            font-size: 14px;
        }
        
        .summary-value {
            color: #1e293b;
            font-weight: 600;
            font-size: 14px;
        }
        
        .navigation-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .nav-link {
            color: #64748b;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.3s;
        }
        
        .nav-link:hover {
            color: #1e3a8a;
        }
        
        .loading {
            display: none;
        }
        
        .loading.show {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #1e3a8a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-message {
            display: none;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .status-message.success {
            display: block;
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-message.error {
            display: block;
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <div class="completion-card">
        <div class="success-icon">‚úì</div>
        <h1>Assessment Complete!</h1>
        
        <div class="patient-info" id="patientInfo">
            Loading patient information...
        </div>
        
        <div class="completion-message">
            <p>
                The health assessment has been successfully completed and saved. 
                You can now send the report to the patient or proceed with treatment planning.
            </p>
        </div>
        
        <div class="assessment-summary">
            <div class="summary-item">
                <span class="summary-label">Assessment Type</span>
                <span class="summary-value" id="assessmentType">Comprehensive Health Assessment</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Date</span>
                <span class="summary-value" id="assessmentDate"></span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Status</span>
                <span class="summary-value" style="color: #10b981;">Complete</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Report ID</span>
                <span class="summary-value" id="reportId">--</span>
            </div>
        </div>
        
        <div class="action-buttons">
            <button class="action-btn btn-success" onclick="emailReportNow()">
                <span>üìß</span>
                <span>Email Report to Patient</span>
                <span class="loading" id="emailLoading"></span>
            </button>
            
            <button class="action-btn btn-primary" onclick="viewReport()">
                <span>üìÑ</span>
                <span>View Full Report</span>
            </button>
            
            <button class="action-btn btn-secondary" onclick="downloadReport()">
                <span>‚¨áÔ∏è</span>
                <span>Download PDF</span>
            </button>
            
            <button class="action-btn btn-secondary" onclick="startTreatmentPlan()">
                <span>üíä</span>
                <span>Create Treatment Plan</span>
            </button>
        </div>
        
        <div class="status-message" id="statusMessage"></div>
        
        <div class="navigation-links">
            <a href="patient-management-enhanced.html" class="nav-link">Back to Patients</a>
            <a href="clinic-dashboard.html" class="nav-link">Dashboard</a>
            <a href="appointments-management.html" class="nav-link">Appointments</a>
        </div>
    </div>
    
    <script src="email-sender.js"></script>
    <script type="module">
        import { supabase } from './supabase-config.js';
        
        let currentPatient = null;
        let currentAssessment = null;
        let reportPdfBlob = null;
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            // Get assessment data from URL params or session storage
            const urlParams = new URLSearchParams(window.location.search);
            const patientId = urlParams.get('patientId') || sessionStorage.getItem('lastAssessedPatientId');
            const assessmentId = urlParams.get('assessmentId') || sessionStorage.getItem('lastAssessmentId');
            
            // Set today's date
            document.getElementById('assessmentDate').textContent = new Date().toLocaleDateString('en-GB');
            
            if (patientId) {
                await loadPatientData(patientId);
            }
            
            if (assessmentId) {
                document.getElementById('reportId').textContent = `RPT-${assessmentId}`;
            }
        });
        
        // Load patient data
        async function loadPatientData(patientId) {
            try {
                const { data: patient, error } = await supabase
                    .from('patients')
                    .select('*')
                    .eq('id', patientId)
                    .single();
                
                if (error) throw error;
                
                currentPatient = patient;
                document.getElementById('patientInfo').textContent = 
                    `Patient: ${patient.first_name} ${patient.last_name} (${patient.patient_id})`;
                    
            } catch (error) {
                console.error('Error loading patient:', error);
                document.getElementById('patientInfo').textContent = 'Patient information unavailable';
            }
        }
        
        // Email report function
        window.emailReportNow = async function() {
            if (!currentPatient) {
                showStatus('Patient information not available', 'error');
                return;
            }
            
            const patientEmail = currentPatient.email;
            const patientName = `${currentPatient.first_name} ${currentPatient.last_name}`;
            
            if (!patientEmail) {
                const enteredEmail = prompt(`Enter email address for ${patientName}:`);
                if (!enteredEmail) return;
                currentPatient.email = enteredEmail;
                
                // Update patient email in database
                await supabase
                    .from('patients')
                    .update({ email: enteredEmail })
                    .eq('id', currentPatient.id);
            }
            
            // Show loading
            document.getElementById('emailLoading').classList.add('show');
            showStatus('Sending report...', 'info');
            
            try {
                // Generate or get PDF blob
                if (!reportPdfBlob) {
                    reportPdfBlob = await generateReportPDF();
                }
                
                // Use the existing sendReportEmail function
                if (window.sendReportEmail) {
                    const success = await window.sendReportEmail(
                        reportPdfBlob,
                        currentPatient.email,
                        patientName
                    );
                    
                    if (success) {
                        showStatus('‚úì Report sent successfully to ' + currentPatient.email, 'success');
                        
                        // Log the activity
                        await logEmailActivity('assessment_report', currentPatient.id);
                    } else {
                        showStatus('Failed to send email. Please try again.', 'error');
                    }
                } else {
                    showStatus('Email service not configured', 'error');
                }
            } catch (error) {
                console.error('Error sending email:', error);
                showStatus('Error: ' + error.message, 'error');
            } finally {
                document.getElementById('emailLoading').classList.remove('show');
            }
        };
        
        // Generate PDF (simplified - in production use proper PDF library)
        async function generateReportPDF() {
            // Create a simple HTML report
            const reportHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Health Assessment Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 40px; }
                        h1 { color: #1e3a8a; }
                        .header { border-bottom: 2px solid #1e3a8a; margin-bottom: 30px; padding-bottom: 20px; }
                        .section { margin: 30px 0; }
                        .metric { margin: 10px 0; padding: 10px; background: #f9fafb; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Health Assessment Report</h1>
                        <p><strong>Patient:</strong> ${currentPatient?.first_name || ''} ${currentPatient?.last_name || ''}</p>
                        <p><strong>Date:</strong> ${new Date().toLocaleDateString('en-GB')}</p>
                        <p><strong>Patient ID:</strong> ${currentPatient?.patient_id || '--'}</p>
                    </div>
                    
                    <div class="section">
                        <h2>Assessment Results</h2>
                        <div class="metric">
                            <strong>Overall Health Score:</strong> Good
                        </div>
                        <div class="metric">
                            <strong>Constitutional Type:</strong> Mixed
                        </div>
                        <div class="metric">
                            <strong>Primary Concerns:</strong> General wellness
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2>Recommendations</h2>
                        <p>Based on the assessment, the following treatment plan is recommended:</p>
                        <ul>
                            <li>Regular therapy sessions</li>
                            <li>Dietary modifications</li>
                            <li>Supplement protocol</li>
                            <li>Follow-up in 4 weeks</li>
                        </ul>
                    </div>
                    
                    <div class="section">
                        <p style="color: #6b7280; font-size: 12px;">
                            This is a confidential medical document. 
                            Generated by Celloxen Wellness Platform.
                        </p>
                    </div>
                </body>
                </html>
            `;
            
            // Convert to blob
            return new Blob([reportHTML], { type: 'application/pdf' });
        }
        
        // Log email activity
        async function logEmailActivity(type, patientId) {
            try {
                const authData = JSON.parse(localStorage.getItem('celloxen_auth') || '{}');
                await supabase.from('activity_logs').insert({
                    clinic_id: authData.clinicId,
                    user_id: authData.userId,
                    action: 'email_sent',
                    details: {
                        type: type,
                        patient_id: patientId,
                        timestamp: new Date().toISOString()
                    }
                });
            } catch (error) {
                console.log('Activity logging skipped:', error);
            }
        }
        
        // View report
        window.viewReport = function() {
            window.location.href = 'medical-reports-corrected.html';
        };
        
        // Download report
        window.downloadReport = function() {
            alert('PDF download functionality would be implemented here');
        };
        
        // Start treatment plan
        window.startTreatmentPlan = function() {
            if (currentPatient) {
                window.location.href = `treatment-planning.html?patientId=${currentPatient.id}`;
            } else {
                window.location.href = 'treatment-planning.html';
            }
        };
        
        // Show status message
        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = 'status-message ' + type;
            
            if (type !== 'info') {
                setTimeout(() => {
                    statusEl.className = 'status-message';
                }, 5000);
            }
        }
    </script>
</body>
</html>
